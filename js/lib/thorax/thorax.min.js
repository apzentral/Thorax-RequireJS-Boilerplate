!function(a){function g(){this.helpers&&_.each(this.helpers,function(a,b){var c=this;this.helpers[b]=function(){var b=_.toArray(arguments),d=_.last(b);return d.context=this,a.apply(c,b)}},this)}function h(a,b){var c=a.extend;a.extend=function(){var a=c.apply(this,arguments);return a.prototype.name&&(b[a.prototype.name]=a),a}}function i(a,b,c,d){var f,e=a[b];if(_.indexOf(c,".")>=0){var g=c.split(/\./);c=g.pop(),_.each(g,function(a){e=e[a]})}if(e&&(f=e[c]),f||d)return f;throw new Error(b+": "+c+" does not exist.")}function j(a,b){var c;if(_.isString(this[a])?c=f.Util.getTemplate(this[a],!0):this.name&&!_.isFunction(this[a])&&(c=f.Util.getTemplate(this.name+(b.extension||""),!0)),!c&&"template"===a&&this._defaultTemplate&&(c=this._defaultTemplate),c&&!_.isFunction(this[a])&&(this[a]=c),b.required&&!_.isFunction(this[a]))throw new Error("View "+(this.name||this.cid)+" requires: "+a)}function k(a,b,c){return a&&a[b]?_.isFunction(a[b])?a[b].call(c||a):a[b]:null}function m(a){_.each(l,function(b){a[b.name]||(a[b.name]=[])})}function n(a){_.each(l,function(b){a[b.name]=[]})}function o(a,b,c,d){var e=[];_.has(a,b)&&e.push(a);var f=a;if(c)for(;f=f.__parent__;)_.has(f,b)&&e.push(f);else for(f=f.constructor;f;)f.prototype&&_.has(f.prototype,b)&&e.push(f.prototype),f=f.__super__&&f.__super__.constructor;for(var g=e.length;g--;)_.each(k(e[g],b,a),d)}function p(a,b,c,d){if(_.isObject(c)){var e=l[b];if(e&&e.event)return q(a["_"+b+"Events"],c,d),!0}}function q(a,b,c){_.each(b,function(b,d){_.isArray(b)?_.each(b,function(b){a.push([d,b,c])}):a.push([d,b,c])})}function r(a){if(!a||!a.data)throw new Error("Handlebars template compiled without data, use: Handlebars.compile(template, {data: true})");return a.data}function t(a){a.tag&&(a.tagName=a.tag,delete a.tag),a["class"]&&(a.className=a["class"],delete a["class"])}function y(a){w.push.apply(w,a),x=new RegExp("^(nested\\s+)?("+w.join("|")+")(?:\\s|$)")}function z(b,c){return function(d){var e=a(d.target).view({helper:!1});e&&e.cid===c&&(d.originalContext=this,b(d))}}function A(a,b){function g(){try{d.apply(e,arguments)}catch(b){f.onException("thorax-exception: "+(e.name||e.cid)+":"+a,b)}}a+=b.originalName;var c=b.handler,d=_.isFunction(c)?c:this[c];if(!d)throw new Error('Event "'+c+'" does not exist '+(this.name||this.cid)+":"+a);var e=b.context||this;return g._callback=d,g}function B(a,b,c){var d={originalName:a,handler:_.isString(b)?this[b]:b};if(a.match(x)){var e=v.exec(a);d.nested=!!e[1],d.name=e[2],d.type="DOM",d.selector=e[3]}else d.name=a,d.type="view";return d.context=c,d}function F(a){for(;a._helperName&&"view"!==a._helperName;)a=a.parent;return a}function G(a){var b=_.pick(a,"fn","inverse","hash","data");return b.data=_.omit(a.data,"cid","view","yield"),b}function H(a,b){function c(a,b){return _.every(a,function(a,c){return b[c]===a})}return a._helperName!==b._helperName?!1:(a=a._helperOptions,b=b._helperOptions,a.args.length===b.args.length&&c(a.args,b.args)&&_.isEqual(_.keys(a.options),_.keys(b.options))&&_.every(a.options,function(d,e){if("data"===e||"hash"===e)return c(a.options[e],b.options[e]);if("fn"===e||"inverse"===e){if(b.options[e]===d)return!0;var f=b.options[e]||{};return d&&_.has(d,"program")&&!d.depth&&f.program===d.program}return b.options[e]===d}))}function I(a,b){function c(c,d){var e=this[a],f=k(this,b.$el);return c===e?this:(e&&this.unbindDataObject(e),c?(this[a]=c,b.loading&&b.loading.call(this),this.bindDataObject(a,c,_.extend({},this.options,d)),f&&f.attr(b.cidAttrName,c.cid),c.trigger("set",c,e)):(this[a]=!1,b.change&&b.change.call(this,!1),f&&f.removeAttr(b.cidAttrName)),this.trigger("change:data-object",a,c,e),this)}b=l[a]=_.defaults({name:"_"+a+"Events",event:!0},b),b.ctor=function(){if(this[a]){var c=this[a];this[a]=null,this[b.set](c)}},f.View.prototype[b.set]=c}function J(a,b,c){var d=this;o(c,"_"+a+"Events",!0,function(a){function g(){if(d.el)c.apply(e,arguments);else{if(f)throw new Error("destroyed-event:"+d.name+":"+a[0]);f++}}var c=L(a[1],d),e=a[2]||d,f=0;g._callback=c,d.listenTo(b,a[0],g)})}function K(a,b){a.load?a.load(function(){b&&b.success&&b.success(a)},b):a.fetch(b)}function L(a,b){return _.isFunction(a)?a:b[a]}function N(a){var b=a&&this._objectOptionsByCid[a.cid];this.conditionalRender(b&&b.render)}function V(a){var b=a&&this._objectOptionsByCid[a.cid]||void 0;this.shouldRender(b&&b.render)&&this.renderCollection&&this.renderCollection()}function W(a){var b=a&&this._objectOptionsByCid[a.cid]||void 0;this.shouldRender(b&&b.render)&&this.ensureRendered()}function X(){this.itemFilter&&this.collection.forEach(Y,this)}function Y(a){var b=this.getCollectionElement();this.itemFilter&&b.find("["+M+'="'+a.cid+'"]')[Z.call(this,a)?"show":"hide"]()}function Z(a){return this.itemFilter(a,this.collection.indexOf(a))}function $(){var a=this.getCollectionElement();this.emptyClass&&a.removeClass(this.emptyClass),a.removeAttr(S),a.empty()}function ab(){var a=this.getCollectionElement();this.emptyClass&&a.addClass(this.emptyClass),a.attr(S,!0),this.appendEmpty()}function cb(b,c,d){var e=0,f=this;this.$("select,input,textarea",b.root||this.el).each(function(){(b.children||f===a(this).view({helper:!1}))&&"button"!==this.type&&"cancel"!==this.type&&"submit"!==this.type&&this.name&&""!==this.name&&(c.call(d||this,e,this),++e)})}function db(a,b,c,d){for(var e,f=a,g=b.split("["),h=c.mode,i=0;i<g.length-1;++i){if(e=g[i].replace("]",""),!f[e]){if("serialize"!==h)return d.call(this,!1,e);f[e]={}}f=f[e]}e=g[g.length-1].replace("]",""),d.call(this,f,e)}function eb(){this.$("form").removeAttr("data-submit-wait")}function gb(a,b){b=b||{},b.target=this,this.trigger(a,b),_.each(this.children,function(c){c.trigger(a,b)})}function hb(){++this._renderCount,this.$el.attr(fb,this.cid)}function ib(){if(!this.$("["+fb+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function jb(){return this.$("["+fb+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function kb(){Backbone.history||(Backbone.history=new Backbone.History),Backbone.history.on("route",lb,this),this.on("destroyed",function(){Backbone.history.off("route",lb,this)})}function lb(a){this===a&&this.trigger.apply(this,["route"].concat(Array.prototype.slice.call(arguments,1)))}function nb(a){return function(){var b=_.toArray(arguments);b.unshift(a),this.parent.trigger.apply(this.parent,b)}}function pb(a){var b=F(this);if(!this[a]){var c=b[a];c&&(this[a]=c)}}function tb(b){var c=a(b.target),d=c.view({helper:!1}),e=c.attr(qb),f=c.attr(rb),g=!1;e&&(g=d[e].call(d,b)),f&&d.trigger(f,b),"A"===c.tagName&&g===!1&&b.preventDefault()}function vb(){wb(),ub=f._fastClickEventName||"click",a(document).on(ub,sb,tb)}function wb(){ub&&a(document).off(ub,sb,tb)}function Bb(a,b){function e(){c!==Backbone.history.getFragment()&&(d=!0,g.cancel(),b&&b())}function f(){Backbone.history.off("route",e),d||a.apply(this,arguments)}var c=Backbone.history.getFragment(),d=!1;Backbone.history.on("route",e);var g=_.bind(f,this);return g.cancel=function(){Backbone.history.off("route",e)},g}function Cb(a,b,c){if(this.isPopulated())return _.defer(a,this);2===arguments.length&&!_.isFunction(b)&&_.isObject(b)&&(c=b,b=!1);var d=this,e=!1,f=Bb(_.bind(a,d),function(){e=!0,d._request&&(d._aborted=!0,d._request.abort()),b&&b.call(d,!1)});this.fetch(_.defaults({success:f,error:function(){f.cancel(),!e&&b&&b.apply(d,[!0].concat(_.toArray(arguments)))}},c))}function Db(a,b){return a.resetQueue&&(this.fetchQueue=void 0),this.fetchQueue?(this.fetchQueue.push(a),void 0):(this.fetchQueue=[a],a=_.defaults({success:Eb(this,this.fetchQueue,"success"),error:Eb(this,this.fetchQueue,"error"),complete:Eb(this,this.fetchQueue,"complete")},a),b&&b.call(this,a),a)}function Eb(a,b,c){return function(){var d=arguments;_.each(b,function(a){a[c]&&a[c].apply(this,d)},this),a.fetchQueue===b&&(a.fetchQueue=void 0)}}function Gb(){this.render()}a.fn.forEach||(a.fn.forEach=function(b,c){a.fn.each.call(this,function(a){b.call(c||this,this,a)})});var b="data-view-name",c="data-view-cid",d="data-view-helper",e={};Handlebars.templates||(Handlebars.templates={});var f=this.Thorax={VERSION:"2.0.0rc4",templatePathPrefix:"",Views:{},onException:function(a,b){throw b},templates:Handlebars.templates};f.View=Backbone.View.extend({constructor:function(){var a=Backbone.View.apply(this,arguments);return _.each(l,function(b){b.ctor&&b.ctor.call(this,a)},this),a},_configure:function(a){var b=this;this._objectOptionsByCid={},this._boundDataObjectsByCid={},_.each(l,function(a){b[a.name]=[]}),e[this.cid]=this,this.children={},this._renderCount=0,_.extend(this,a||{}),g.call(this),_.each(l,function(a){a.configure&&a.configure.call(this)},this)},setElement:function(){var a=Backbone.View.prototype.setElement.apply(this,arguments);return this.name&&this.$el.attr(b,this.name),this.$el.attr(c,this.cid),a},_addChild:function(a){return this.children[a.cid]=a,a.parent||(a.parent=this),this.trigger("child",a),a},_removeChild:function(a){return delete this.children[a.cid],a.parent=null,a},destroy:function(a){a=_.defaults(a||{},{children:!0}),_.each(this._boundDataObjectsByCid,this.unbindDataObject,this),this.trigger("destroyed"),delete e[this.cid],_.each(this.children,function(b){this._removeChild(b),a.children&&b.destroy()},this),this.parent&&this.parent._removeChild(this),this.el&&(this.undelegateEvents(),this.remove()),this.el=this.$el=void 0,this.parent=void 0,this.model=this.collection=this._collection=void 0,this._helperOptions=void 0},render:function(a){if(this._rendering)throw new Error("nested-render");this._previousHelpers=_.filter(this.children,function(a){return a._helperOptions});var b={};_.each(this.children,function(a,c){a._helperOptions||(b[c]=a)}),this.children=b,this._rendering=!0;try{!_.isUndefined(a)&&(_.isElement(a)||f.Util.is$(a)||a&&a.el||_.isString(a)||_.isFunction(a))?_.isFunction(a)&&(a=this.renderTemplate(a)):(j.call(this,"template",{required:!0}),a=this.renderTemplate(this.template))}finally{this._rendering=!1}return _.each(this._previousHelpers,function(a){a.destroy(),a.parent=void 0}),this._previousHelpers=void 0,this.html(a&&a.el||a&&a.string||a),++this._renderCount,this.trigger("rendered"),a},context:function(){return _.extend({},this.model&&this.model.attributes||{})},_getContext:function(){return _.extend({},this,k(this,"context")||{})},_getData:function(a){return{view:this,cid:_.uniqueId("t"),yield:function(){return a.fn&&a.fn(a)}}},_getHelpers:function(){return this.helpers?_.extend({},Handlebars.helpers,this.helpers):Handlebars.helpers},renderTemplate:function(a,b,c){var d;return b=b||this._getContext(),d=_.isFunction(a)?a:f.Util.getTemplate(a,c),d?d(b,{helpers:this._getHelpers(),data:this._getData(b)}):""},ensureRendered:function(){!this._renderCount&&this.render()},shouldRender:function(a){return a||null==a&&this._renderCount},conditionalRender:function(a){this.shouldRender(a)&&this.render()},appendTo:function(b){this.ensureRendered(),a(b).append(this.el),this.trigger("ready",{target:this})},html:function(a){if(_.isUndefined(a))return this.el.innerHTML;this.trigger("before:append");var b=this._replaceHTML(a);return this.trigger("append"),b},_replaceHTML:function(a){return this.el.innerHTML="",this.$el.append(a)},_anchorClick:function(b){var c=a(b.currentTarget),d=c.attr("href");return d&&("#"===d[0]||"/"===d[0]&&"/"!==d[1])?(Backbone.history.navigate(d,{trigger:!0}),!1):!0}}),f.View.extend=function(){m(this);var a=Backbone.View.extend.apply(this,arguments);return a.__parent__=this,n(a),a},h(f.View,f.Views),a.fn.view=function(b){b=_.defaults(b||{},{helper:!0});var f="["+c+"]";b.helper||(f+=":not(["+d+"])");var g=a(this).closest(f);return g&&e[g.attr(c)]||!1};var l={},s=["id","className","tagName"];f.Util={getViewInstance:function(a,b){if(b=b||{},_.isString(a)){var c=i(f,"Views",a,!1);return c.cid?_.extend(c,b||{}):new c(b)}return _.isFunction(a)?new a(b):a},getTemplate:function(a,b){var d,c=f.templatePathPrefix;if(c&&a.substr(0,c.length)!==c&&(a=c+a),a=a.replace(/\.handlebars$/,""),d=Handlebars.templates[a],d||(a+=".handlebars",d=Handlebars.templates[a]),!d&&!b)throw new Error("templates: "+a+" does not exist.");return d},is$:function(a){return _.isObject(a)&&"length"in a},expandToken:function(a,b){function f(a,b){if(a.match(/^("|')/)&&a.match(/("|')$/))return a.replace(/(^("|')|('|")$)/g,"");for(var c=a.split("."),d=c.length,e=0;b&&d>e;e++)"this"!==c[e]&&(b=b[c[e]]);return b}if(a&&a.indexOf&&a.indexOf("{{")>=0){for(var d,c=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,e=[];d=c.exec(a);)if(d[1]){var g=d[1].split(/\s+/);if(g.length>1){var h=g.shift();g=_.map(g,function(a){return f(a,b)}),Handlebars.helpers[h]?e.push(Handlebars.helpers[h].apply(b,g)):e.push(d[0])}else e.push(f(g[0],b))}else e.push(d[0]);a=e.join("")}return a},tag:function(a,b,c){var d=_.omit(a,"tagName"),e=a.tagName||"div";return"<"+e+" "+_.map(d,function(a,b){if(_.isUndefined(a)||"expand-tokens"===b)return"";var d=a;return c&&(d=f.Util.expandToken(a,c)),("className"===b?"class":b)+'="'+Handlebars.Utils.escapeExpression(d)+'"'}).join(" ")+">"+(_.isUndefined(b)?"":b)+"</"+e+">"}},f.Mixins={},l.mixins={name:"mixins",configure:function(){_.each(this.constructor.mixins,this.mixin,this),_.each(this.mixins,this.mixin,this)}},_.extend(f.View,{mixin:function(a){m(this),this.mixins.push(a)},registerMixin:function(a,b,c){f.Mixins[a]=[b,c]}}),f.View.prototype.mixin=function(a){if(this._appliedMixins||(this._appliedMixins=[]),-1===_.indexOf(this._appliedMixins,a))if(this._appliedMixins.push(a),_.isFunction(a))a.call(this);else{var b=f.Mixins[a];_.extend(this,b[1]),_.isArray(b[0])?b[0][0].apply(this,b[0][1]):b[0].apply(this,_.toArray(arguments).slice(1))}};var u=f.View.prototype.on;l.event={name:"_events",configure:function(){var a=this;o(this.constructor,"_events",!0,function(b){a.on.apply(a,b)}),o(this,"events",!1,function(b,c){a.on(c,b,a)})}},_.extend(f.View,{on:function(a,b){return m(this),p(this,a,b)?this:(_.isObject(a)?_.each(a,function(a,b){this.on(b,a)},this):_.isArray(b)?_.each(b,function(b){this._events.push([a,b])},this):this._events.push([a,b]),this)}}),_.extend(f.View.prototype,{on:function(a,b,c){return p(this,a,b,c)?this:(_.isObject(a)&&arguments.length<3?_.each(a,function(a,c){this.on(c,a,b||this)},this):_.each(_.isArray(b)?b:[b],function(b){var d=B.call(this,a,b,c||this);"DOM"===d.type?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(d)):this._addEvent(d)},this),this)},delegateEvents:function(a){this.undelegateEvents(),a&&(_.isFunction(a)&&(a=a.call(this)),this._eventsToDelegate=[],this.on(a)),this._eventsToDelegate&&_.each(this._eventsToDelegate,this._addEvent,this)},_addEvent:function(a){if("view"===a.type)_.each(a.name.split(/\s+/),function(b){u.call(this,b,A.call(this,"view-event:",a),a.context||this)},this);else{var b=A.call(this,"dom-event:",a);a.nested||(b=z(b,this.cid));var c=a.name+".delegateEvents"+this.cid;a.selector?this.$el.on(c,a.selector,b):this.$el.on(c,b)}}}),f.View.on("ready",function(a){function b(b){b.trigger("ready",a)}this._isReady||(this._isReady=!0,_.each(this.children,b),this.on("child",b))});var x,v=/^(nested\s+)?(\S+)(?:\s+(.+))?/,w=[];y(["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","focus","blur"]);var C="data-view-tmp",D={},E={_ensureElement:function(){f.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(d,this._helperName)},_getContext:function(){return this.parent._getContext.apply(this.parent,arguments)}};f.HelperView=f.View.extend(E),Handlebars.registerViewHelper=function(a,b,c){2===arguments.length&&(b.factory?c=b.callback:(c=b,b=f.HelperView)),Handlebars.registerHelper(a,function(){var d=_.toArray(arguments),e=d.pop(),g=r(e).view,h={template:e.fn||Handlebars.VM.noop,inverse:e.inverse,options:e.hash,declaringView:g,parent:F(g),_helperName:a,_helperOptions:{options:G(e),args:_.clone(d)}};t(e.hash),_.extend(h,_.pick(e.hash,s));var i=_.find(g._previousHelpers,function(a){return H(h,a)});if(i)g._previousHelpers=_.without(g._previousHelpers,i),g.children[i.cid]=i;else{if(b.factory){if(i=b.factory(d,h),!i)return"";i._helperName=h._helperName,i._helperOptions=h._helperOptions}else i=new b(h);d.push(i),g._addChild(i),g.trigger.apply(g,["helper",a].concat(d)),g.trigger.apply(g,["helper:"+a].concat(d)),c&&c.apply(this,d)}var j=_.pick(e.hash,s);j[C]=i.cid;var k=e.hash["expand-tokens"];return new Handlebars.SafeString(f.Util.tag(j,"",k?this:null))});var d=Handlebars.helpers[a];return d},f.View.on("append",function(b,c){(b||this.$el).find("["+C+"]").forEach(function(b){var d=b.getAttribute(C),e=this.children[d];e&&(D[d]?(e.render(D[d]),delete D[d]):e.ensureRendered(),a(b).replaceWith(e.el),c&&c(e.el))},this)}),_.extend(f.View.prototype,{bindDataObject:function(a,b,c){if(this._boundDataObjectsByCid[b.cid])return!1;this._boundDataObjectsByCid[b.cid]=b;var c=this._modifyDataObjectOptions(b,_.extend({},l[a].defaultOptions,c));this._objectOptionsByCid[b.cid]=c,J.call(this,a,b,this.constructor),J.call(this,a,b,this);var d=l[a];return d.bindCallback&&d.bindCallback.call(this,b,c),b.shouldFetch&&b.shouldFetch(c)?K(b,c):l[a].change&&l[a].change.call(this,b,c),!0},unbindDataObject:function(a){return this._boundDataObjectsByCid[a.cid]?(delete this._boundDataObjectsByCid[a.cid],this.stopListening(a),delete this._objectOptionsByCid[a.cid],!0):!1},_modifyDataObjectOptions:function(a,b){return b}});var M="data-model-cid";f.Model=Backbone.Model.extend({isEmpty:function(){return!this.isPopulated()},isPopulated:function(){var a=_.clone(this.attributes),b=k(this,"defaults")||{};for(var c in b){if(a[c]!=b[c])return!0;delete a[c]}var d=_.keys(a);return d.length>1||1===d.length&&d[0]!==this.idAttribute},shouldFetch:function(a){var b;try{b=k(this,"url")}catch(c){b=!1}return a.fetch&&!!b&&!this.isPopulated()}}),f.Models={},h(f.Model,f.Models),I("model",{set:"setModel",defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:N,$el:"$el",cidAttrName:M}),f.View.on({model:{error:function(a,b){this._objectOptionsByCid[a.cid].errors&&this.trigger("error",b,a)},change:function(a){N.call(this,a)}}}),a.fn.model=function(b){var c=a(this),d=c.closest("["+M+"]"),e=d&&d.attr(M);if(e){var b=b||c.view();if(b&&b.model&&b.model.cid===e)return b.model||!1;var f=c.collection(b);if(f)return f.get(e)}return!1};var O=Backbone.Collection.prototype.fetch,P=Backbone.Collection.prototype.reset,Q=f.View.prototype._replaceHTML,R="data-collection-cid",S="data-collection-empty",T="data-collection-element",U=1;f.Collection=Backbone.Collection.extend({model:f.Model||Backbone.Model,initialize:function(){return this.cid=_.uniqueId("collection"),Backbone.Collection.prototype.initialize.apply(this,arguments)},isEmpty:function(){return this.length>0?!1:0===this.length&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!k(this,"url")},shouldFetch:function(a){return a.fetch&&!!k(this,"url")&&!this.isPopulated()},fetch:function(a){a=a||{};var b=a.success;return a.success=function(a,c){a._fetched=!0,b&&b(a,c)},O.apply(this,arguments)},reset:function(a,b){return this._fetched=!!a,P.call(this,a,b)}}),f.Collections={},h(f.Collection,f.Collections),I("collection",{set:"setCollection",bindCallback:W,defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:V,$el:"getCollectionElement",cidAttrName:R}),f.CollectionView=f.View.extend({_defaultTemplate:Handlebars.VM.noop,_collectionSelector:"["+T+"]",_replaceHTML:function(a){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return Q.call(this,a);var b,c=this.getCollectionElement();b=Q.call(this,a),c.attr("data-view-cid")||this.getCollectionElement().replaceWith(c)},render:function(){var a=this.shouldRender();f.View.prototype.render.apply(this,arguments),a||this.renderCollection()},appendItem:function(b,c,d){if(b){var e,f=this.getCollectionElement();if(d=_.defaults(d||{},{filter:!0}),c&&c.el&&(c=f.children().indexOf(c.el)+1),b.el||_.isString(b)?(e=b,b=!1):(c=c||this.collection.indexOf(b)||0,e=this.renderItem(b,c)),e){e.cid&&(e.ensureRendered(),this._addChild(e)),_.isString(e)&&!e.match(/^\s*</m)&&(e="<div>"+e+"</div>");var g=e.$el?e.$el:_.filter(a(a.trim(e)),function(a){return a.nodeType===U});b&&a(g).attr(M,b.cid);var h=c>0?this.collection.at(c-1):!1;if(h){var i=f.children("["+M+'="'+h.cid+'"]').last();i.after(g)}else f.prepend(g);this.trigger("append",null,function(a){a.setAttribute(M,b.cid)}),!d.silent&&this.trigger("rendered:item",this,this.collection,b,g,c),d.filter&&Y.call(this,b)}return e}},updateItem:function(a){var b=this.getCollectionElement(),d=b.find("["+M+'="'+a.cid+'"]');d.attr(c)||(this.removeItem(d),this.appendItem(a))},removeItem:function(a){var b=a;if(a.cid){var d=this.getCollectionElement();b=d.find("["+M+'="'+a.cid+'"]')}if(!b.length)return!1;b.remove();var e=b.attr(c),f=this.children[e];return f&&(this._removeChild(f),f.destroy()),!0},renderCollection:function(){this.collection?(this.collection.isEmpty()?ab.call(this):($.call(this),this.collection.forEach(function(a,b){this.appendItem(a,b)},this)),this.trigger("rendered:collection",this,this.collection)):ab.call(this)},emptyClass:"empty",renderEmpty:function(){if(this.emptyTemplate||this.emptyView||j.call(this,"emptyTemplate",{extension:"-empty",required:!1}),this.emptyView){var a={};this.emptyTemplate&&(a.template=this.emptyTemplate);var b=f.Util.getViewInstance(this.emptyView,a);return b.ensureRendered(),b}return this.emptyTemplate&&this.renderTemplate(this.emptyTemplate)},renderItem:function(a,b){if(this.itemTemplate||this.itemView||j.call(this,"itemTemplate",{extension:"-item",required:!this.itemView}),this.itemView){var c={model:a};return this.itemTemplate&&(c.template=this.itemTemplate),f.Util.getViewInstance(this.itemView,c)}return this.renderTemplate(this.itemTemplate,this.itemContext(a,b))},itemContext:function(a){return a.attributes},appendEmpty:function(){var a=this.getCollectionElement();a.empty();var b=this.renderEmpty();b&&this.appendItem(b,0,{silent:!0,filter:!1}),this.trigger("rendered:empty",this,this.collection)},getCollectionElement:function(){var a=this.$(this._collectionSelector);return 0===a.length?this.$el:a}}),f.CollectionView.on({collection:{reset:V,sort:V,filter:function(){X.call(this)},change:function(a){this.updateItem(a),Y.call(this,a)},add:function(a){var b=this.getCollectionElement();if(1===this.collection.length&&b.length&&$.call(this),b.length){var c=this.collection.indexOf(a);this.appendItem(a,c)}},remove:function(a){var b=this.getCollectionElement();this.removeItem(a),0===this.collection.length&&b.length&&ab.call(this)}}}),f.View.on({collection:{error:function(a,b){this._objectOptionsByCid[a.cid].errors&&this.trigger("error",b,a)}}}),a.fn.collection=function(b){if(b&&b.collection)return b.collection;var c=a(this),d=c.closest("["+R+"]"),e=d&&d.attr(R);return e&&(b=c.view())?b.collection:!1},l.model.defaultOptions.populate=!0;var bb=l.model.change;l.model.change=function(){bb.apply(this,arguments);var a=this.model&&this._objectOptionsByCid[this.model.cid];a&&a.populate&&this.populate(this.model.attributes,a.populate===!0?{}:a.populate)},l.model.defaultOptions.populate=!0,_.extend(f.View.prototype,{serialize:function(){for(var a,b,c,d=0;d<arguments.length;++d)_.isFunction(arguments[d])?a=arguments[d]:_.isObject(arguments[d])&&("stopPropagation"in arguments[d]&&"preventDefault"in arguments[d]?c=arguments[d]:b=arguments[d]);if(!c||this._preventDuplicateSubmission(c)){b=_.extend({set:!0,validate:!0,children:!0,silent:!0},b||{});var e=b.attributes||{},f=this,g=[];if(cb.call(this,b,function(){var a=f._getInputValue(this,b,g);_.isUndefined(a)||db.call(this,e,this.name,{mode:"serialize"},function(b,c){b[c]?_.isArray(b[c])?b[c].push(a):b[c]=[b[c],a]:b[c]=a})}),this.trigger("serialize",e,b),b.validate){var h=this.validateInput(e);if(h&&h.length&&(g=g.concat(h)),this.trigger("validate",e,g,b),g.length)return this.trigger("error",g),void 0}return b.set&&this.model&&!this.model.set(e,{silent:b.silent})?!1:(a&&a.call(this,e,_.bind(eb,this)),e)}},_preventDuplicateSubmission:function(b,c){b.preventDefault();var d=a(b.target);return"form"!==(b.target.tagName||"").toLowerCase()&&(d=a(b.target).closest("form")),d.attr("data-submit-wait")?!1:(d.attr("data-submit-wait","true"),c&&c.call(this,b),!0)},populate:function(a,b){b=_.extend({children:!0},b||{});var c,a=a||this._getContext();cb.call(this,b,function(){db.call(this,a,this.name,{mode:"populate"},function(a,b){c=a&&a[b],_.isUndefined(c)||("checkbox"===this.type&&_.isBoolean(c)?this.checked=c:"checkbox"===this.type||"radio"===this.type?this.checked=c==this.value:this.value=c)})}),this.trigger("populate",a)},validateInput:function(){},_getInputValue:function(b){if("checkbox"!==b.type&&"radio"!==b.type){if(b.multiple===!0){var c=[];return a("option",b).each(function(){this.selected&&c.push(this.value)}),c}return b.value}return b.checked?b.value:void 0}}),f.View.on({error:function(){eb.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})},deactivated:function(){eb.call(this)}});var fb="data-layout-cid";f.LayoutView=f.View.extend({_defaultTemplate:Handlebars.VM.noop,render:function(){var a=f.View.prototype.render.apply(this,arguments);return this.template===Handlebars.VM.noop?hb.call(this):ib.call(this),a},setView:function(a,b){b=_.extend({scroll:!0,destroy:!0},b||{}),_.isString(a)&&(a=new(f.Util.registryGet(f,"Views",a,!1))),this.ensureRendered();var c=this._view;return a===c?!1:(b.destroy&&a&&(a._shouldDestroyOnNextSetView=!0),this.trigger("change:view:start",a,c,b),c&&(this._removeChild(c),c.$el.remove(),gb.call(c,"deactivated",b),c._shouldDestroyOnNextSetView&&c.destroy()),a?(gb.call(this,"activated",b),a.trigger("activated",b),this._addChild(a),this._view=a,this._view.appendTo(jb.call(this))):this._view=void 0,this.trigger("change:view:end",a,c,b),a)},getView:function(){return this._view}}),Handlebars.registerHelper("layout-element",function(a){var b=r(a).view;if(!b.getView)throw new Error("layout-element must be used within a LayoutView");return a.hash[fb]=b.cid,t(a.hash),new Handlebars.SafeString(f.Util.tag.call(this,a.hash,"",this))}),f.Router=Backbone.Router.extend({constructor:function(){var a=f.Router.__super__.constructor.apply(this,arguments);return kb.call(this),a},route:function(a,b,c){return c||(c=this[b]),Backbone.Router.prototype.route.call(this,a,b,function(){return this.trigger.apply(this,["route:before",a,b].concat(Array.prototype.slice.call(arguments))),c.apply(this,arguments)})}}),f.Routers={},h(f.Router,f.Routers),f.CollectionHelperView=f.CollectionView.extend({events:{"rendered:item":nb("rendered:item"),"rendered:collection":nb("rendered:collection"),"rendered:empty":nb("rendered:empty")},constructor:function(a){_.each(mb,function(b,c){if(a.options[c]){var d=a.options[c];("itemTemplate"===b||"emptyTemplate"===b)&&(d=f.Util.getTemplate(d)),a[b]=d}}),!a.itemTemplate&&a.template&&a.template!==Handlebars.VM.noop&&(a.itemTemplate=a.template,a.template=Handlebars.VM.noop),!a.emptyTemplate&&a.inverse&&a.inverse!==Handlebars.VM.noop&&(a.emptyTemplate=a.inverse,a.inverse=Handlebars.VM.noop);var b=f.HelperView.call(this,a);return this.parent.name&&(this.emptyTemplate||(this.emptyTemplate=f.Util.getTemplate(this.parent.name+"-empty",!0)),this.itemTemplate||(this.itemTemplate=f.Util.getTemplate(this.parent.name+"-item",!!this.itemView))),b},setAsPrimaryCollectionHelper:function(){_.each(ob,function(a){pb.call(this,a)},this);var a=this;_.each(["itemFilter","itemContext","renderItem","renderEmpty"],function(b){a.parent[b]&&!this[b]&&(a[b]=function(){return a.parent[b].apply(a.parent,arguments)})})}}),_.extend(f.CollectionHelperView.prototype,E);var mb={"item-template":"itemTemplate","empty-template":"emptyTemplate","item-view":"itemView","empty-view":"emptyView","empty-class":"emptyClass"},ob=["itemTemplate","itemView","emptyTemplate","emptyView"];Handlebars.registerViewHelper("collection",f.CollectionHelperView,function(a,b){1===arguments.length&&(b=a,a=b.parent.collection,a&&b.setAsPrimaryCollectionHelper(),b.$el.attr(T,"true"),b.listenTo(b.parent,"change:data-object",function(a,c){"collection"===a&&(b.setAsPrimaryCollectionHelper(),b.setCollection(c))})),a&&b.setCollection(a)}),Handlebars.registerHelper("collection-element",function(a){if(!r(a).view.renderCollection)throw new Error("collection-element helper must be declared inside of a CollectionView");var b=a.hash;return t(b),b.tagName=b.tagName||"div",b[T]=!0,new Handlebars.SafeString(f.Util.tag.call(this,b,"",this))}),Handlebars.registerHelper("empty",function(a,b){1===arguments.length&&(b=a);var c=r(b).view;return 1===arguments.length&&(a=c.model),c._emptyListeners||(c._emptyListeners={}),a&&!c._emptyListeners[a.cid]&&a.models&&"length"in a&&(c._emptyListeners[a.cid]=!0,c.listenTo(a,"remove",function(){0===a.length&&c.render()}),c.listenTo(a,"add",function(){1===a.length&&c.render()}),c.listenTo(a,"reset",function(){c.render()})),!a||a.isEmpty()?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("template",function(a,b){var c=_.extend({fn:b&&b.fn},this,b?b.hash:{}),d=r(b).view.renderTemplate(a,c);return new Handlebars.SafeString(d)}),Handlebars.registerHelper("yield",function(a){return r(a).yield&&a.data.yield()}),Handlebars.registerHelper("url",function(a){var b;if(arguments.length>2)b=_.map(_.head(arguments,arguments.length-1),encodeURIComponent).join("/");else{var c=arguments[1],d=c&&c.hash||c;b=d&&d["expand-tokens"]?f.Util.expandToken(a,this):a}if(Backbone.history._hasPushState){var e=Backbone.history.options.root;return"/"===e&&"/"===b.substr(0,1)?b:e+b}return"#"+b}),Handlebars.registerViewHelper("view",{factory:function(a,b){var c=a.length>=1?a[0]:f.View;return f.Util.getViewInstance(c,b.options)},callback:function(){var a=arguments[arguments.length-1],b=a._helperOptions.options,c=a.cid;b.fn&&(D[c]=b.fn)}});var qb="data-call-method",rb="data-trigger-event";Handlebars.registerHelper("button",function(a,b){1===arguments.length&&(b=a,a=b.hash.method);var c=b.hash,d=c["expand-tokens"];if(delete c["expand-tokens"],!a&&!b.hash.trigger)throw new Error("button helper must have a method name as the first argument or a 'trigger', or a 'method' attribute specified.");return t(c),c.tagName=c.tagName||"button",c.trigger&&(c[rb]=c.trigger),delete c.trigger,a&&(c[qb]=a),new Handlebars.SafeString(f.Util.tag(c,b.fn?b.fn(this):"",d?this:null))}),Handlebars.registerHelper("link",function(){var a=_.toArray(arguments),b=a.pop(),c=b.hash,d=0===a.length?[c.href]:a,e=c["expand-tokens"];if(delete c["expand-tokens"],!d[0]&&""!==d[0])throw new Error("link helper requires an href as the first argument or an 'href' attribute");return t(c),d.push(b),c.href=Handlebars.helpers.url.apply(this,d),c.tagName=c.tagName||"a",c.trigger&&(c[rb]=b.hash.trigger),delete c.trigger,c[qb]="_anchorClick",new Handlebars.SafeString(f.Util.tag(c,b.fn?b.fn(this):"",e?this:null))});var ub,sb="["+qb+"], ["+rb+"]";a(document).ready(function(){f._fastClickEventName||vb()});var xb="data-element-tmp";Handlebars.registerHelper("element",function(a,b){t(b.hash);var c=_.uniqueId("element"),d=r(b).view,e=_.pick(b.hash,s);return e[xb]=c,d._elementsByCid||(d._elementsByCid={}),d._elementsByCid[c]=a,new Handlebars.SafeString(f.Util.tag(e))}),f.View.on("append",function(b,c){(b||this.$el).find("["+xb+"]").forEach(function(b){var d=a(b),e=d.attr(xb),f=this._elementsByCid[e];_.isFunction(f)&&(f=f.call(this)),d.replaceWith(f),c&&c(f)},this)}),Handlebars.registerHelper("super",function(a){var b=r(a).view,c=b.constructor&&b.constructor.__super__;if(c){var d=c.template;if(!d){if(!c.name)throw new Error("Cannot use super helper when parent has no name or template.");d=c.name}return _.isString(d)&&(d=f.Util.getTemplate(d,!1)),new Handlebars.SafeString(d(this,a))}return""});var Ab,yb="load:start",zb="load:end";f.setRootObject=function(a){Ab=a},f.loadHandler=function(a,b,c){var d=_.uniqueId("load");
return function(e,g,h){function k(){if(!j.timeout||j.run){var b=void 0!==i._loadingTimeoutDuration?i._loadingTimeoutDuration:f.View.prototype._loadingTimeoutDuration;j.timeout=setTimeout(function(){try{j.run=!0,a.call(i,j.message,j.background,j)}catch(b){f.onException("loadStart",b)}},1e3*b)}}var i=c||this;i._loadInfo=i._loadInfo||{};var j=i._loadInfo[d];j?(clearTimeout(j.endTimeout),j.message=e,!g&&j.background&&(j.background=!1,k())):(j=i._loadInfo[d]=_.extend({isLoading:function(){return j.events.length},cid:d,events:[],timeout:0,message:e,background:!!g},Backbone.Events),k()),_.indexOf(j.events,h)>=0||(j.events.push(h),h.on(zb,function l(){var a=i._loadingTimeoutEndDuration;void 0===a&&(a=f.View.prototype._loadingTimeoutEndDuration);var c=j.events,e=_.indexOf(c,h);e>=0&&!h.isLoading()&&(c.splice(e,1),_.indexOf(c,h)<0&&h.off(zb,l)),c.length||(clearTimeout(j.endTimeout),j.endTimeout=setTimeout(function(){try{c.length||(j.run&&(b.call(i,j.background,j),j.trigger(zb,j)),clearTimeout(j.timeout),j=i._loadInfo[d]=void 0)}catch(a){f.onException("loadEnd",a)}},1e3*a))}))}},f.forwardLoadEvents=function(a,b,c){function d(e,f,g){c&&a.off(yb,d),b.trigger(yb,e,f,g)}return a.on(yb,d),{off:function(){a.off(yb,d)}}},f.mixinLoadable=function(b,c){_.extend(b,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(b,d,e){var f=c?this.parent:this;f&&f.el&&(f.nonBlockingLoad||d||!Ab||Ab===this||Ab.trigger(yb,b,d,e),f._isLoading=!0,a(f.el).addClass(f._loadingClassName),f.trigger("change:load-state","start",d))},onLoadEnd:function(){var b=c?this.parent:this;b&&b.el&&(b._isLoading=!1,a(b.el).removeClass(b._loadingClassName),b.trigger("change:load-state","end"))}})},f.mixinLoadableEvents=function(a,b){_.extend(a,{_loadCount:0,isLoading:function(){return this._loadCount>0},loadStart:function(a,c){this._loadCount++;var d=b?this.parent:this;d.trigger(yb,a,c,d)},loadEnd:function(){this._loadCount--;var a=b?this.parent:this;a.trigger(zb,a)}})},f.mixinLoadable(f.View.prototype),f.mixinLoadableEvents(f.View.prototype),f.HelperView&&(f.mixinLoadable(f.HelperView.prototype,!0),f.mixinLoadableEvents(f.HelperView.prototype,!0)),f.CollectionHelperView&&(f.mixinLoadable(f.CollectionHelperView.prototype,!0),f.mixinLoadableEvents(f.CollectionHelperView.prototype,!0)),f.sync=function(a,b,c){var d=this,e=c.complete;return c.complete=function(){d._request=void 0,d._aborted=!1,e&&e.apply(this,arguments)},this._request=Backbone.sync.apply(this,arguments),this._request};var Fb=[];f.Model&&Fb.push(f.Model),f.Collection&&Fb.push(f.Collection),_.each(Fb,function(a){var b=a.prototype.fetch;f.mixinLoadableEvents(a.prototype,!1),_.extend(a.prototype,{sync:f.sync,fetch:function(a){a=a||{};var c=this,d=a.complete;return a.complete=function(){d&&d.apply(this,arguments),c.loadEnd()},c.loadStart(void 0,a.background),Db.call(this,a||{},b)},load:function(a,b,c){2!==arguments.length||_.isFunction(b)||(c=b,b=!1),c=c||{},c.background||this.isPopulated()||!Ab||f.forwardLoadEvents(this,Ab,!0),Cb.call(this,a,b,c)}})}),f.Util.bindToRoute=Bb,f.Router&&(f.Router.bindToRoute=f.Router.prototype.bindToRoute=Bb),f.View.prototype._modifyDataObjectOptions=function(a,b){return b.ignoreErrors=this.ignoreFetchError,b.background=this.nonBlockingLoad,b},f.HelperView.prototype._modifyDataObjectOptions=f.CollectionHelperView.prototype._modifyDataObjectOptions=function(a,b){return b.ignoreErrors=this.parent.ignoreFetchError,b.background=this.parent.nonBlockingLoad,b},l.collection.loading=function(){var a=this.loadingView,b=this.loadingTemplate,c=this.loadingPlacement;if(a||b){var d=f.loadHandler(_.bind(function(){var d;if(0===this.collection.length&&this.$el.empty(),a){var e=f.Util.getViewInstance(a);this._addChild(e),b?e.render(b):e.render(),d=e}else d=this.renderTemplate(b);var g=c?c.call(this):this.collection.length;this.appendItem(d,g),this.$el.children().eq(g).attr("data-loading-element",this.collection.cid)},this),_.bind(function(){this.$el.find('[data-loading-element="'+this.collection.cid+'"]').remove()},this),this.collection);this.listenTo(this.collection,"load:start",d)}},mb&&(mb["loading-template"]="loadingTemplate",mb["loading-view"]="loadingView",mb["loading-placement"]="loadingPlacement"),f.View.on({"load:start":f.loadHandler(function(a,b,c){this.onLoadStart(a,b,c)},function(a,b){this.onLoadEnd(b)}),collection:{"load:start":function(a,b,c){this.trigger(yb,a,b,c)}},model:{"load:start":function(a,b,c){this.trigger(yb,a,b,c)}}}),Handlebars.registerHelper("loading",function(a){var b=r(a).view;return b.off("change:load-state",Gb,b),b.on("change:load-state",Gb,b),b._isLoading?a.fn(this):a.inverse(this)});var Hb=/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());Hb&&(f.View.on("before:append",function(){this._renderCount>0&&(_.each(this._elementsByCid,function(b){a(b).detach()}),_.each(this.children,function(a){a.$el.detach()}))}),f.CollectionView.prototype._replaceHTML=function(a){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return Q.call(this,a);var b,c=this.getCollectionElement().clone(!0,!0);b=Q.call(this,a),c.attr("data-view-cid")||this.getCollectionElement().replaceWith(c)})}(jQuery);