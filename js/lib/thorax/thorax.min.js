!function(a,b){"undefined"!=typeof exports?b(a,exports,require("underscore"),Backbone):"function"==typeof define&&define.amd?define(["underscore","jquery","backbone","exports"],function(c,d,e,f){a.Thorax=b(a,f,c,d,e)}):a.Thorax=b(a,{},a._,a.jQuery||a.Zepto||a.ender||a.$,a.Backbone)}(this,function(a,b,c,d,e){function j(){this.helpers&&c.each(this.helpers,function(a,b){var d=this;this.helpers[b]=function(){var b=c.toArray(arguments),e=c.last(b);return e.context=this,a.apply(d,b)}},this)}function k(a,b){var c=a.extend;a.extend=function(){var a=c.apply(this,arguments);return a.prototype.name&&(b[a.prototype.name]=a),a}}function l(a,b,d,e){var g,f=a[b];if(c.indexOf(d,".")>=0){var h=d.split(/\./);d=h.pop(),c.each(h,function(a){f=f[a]})}if(f&&(g=f[d]),g||e)return g;throw new Error(b+": "+d+" does not exist.")}function m(a,d){var e;if(c.isString(this[a])?e=b.Util.getTemplate(this[a],!0):this.name&&!c.isFunction(this[a])&&(e=b.Util.getTemplate(this.name+(d.extension||""),!0)),!e&&"template"===a&&this._defaultTemplate&&(e=this._defaultTemplate),e&&!c.isFunction(this[a])&&(this[a]=e),d.required&&!c.isFunction(this[a]))throw new Error("View "+(this.name||this.cid)+" requires: "+a)}function n(a,b,d){return a&&a[b]?c.isFunction(a[b])?a[b].call(d||a):a[b]:null}function p(a){c.each(o,function(b){a[b.name]||(a[b.name]=[])})}function q(a){c.each(o,function(b){a[b.name]=[]})}function r(a,b,d,e){var f=[];c.has(a,b)&&f.push(a);var g=a;if(d)for(;g=g.__parent__;)c.has(g,b)&&f.push(g);else for(g=g.constructor;g;)g.prototype&&c.has(g.prototype,b)&&f.push(g.prototype),g=g.__super__&&g.__super__.constructor;for(var h=f.length;h--;)c.each(n(f[h],b,a),e)}function s(a,b,d,e){if(c.isObject(d)){var f=o[b];if(f&&f.event)return t(a["_"+b+"Events"],d,e),!0}}function t(a,b,d){c.each(b,function(b,e){c.isArray(b)?c.each(b,function(b){a.push([e,b,d])}):a.push([e,b,d])})}function u(a){if(!a||!a.data)throw new Error("Handlebars template compiled without data, use: Handlebars.compile(template, {data: true})");return a.data}function w(a){a.tag&&(a.tagName=a.tag,delete a.tag),a["class"]&&(a.className=a["class"],delete a["class"])}function B(a){z.push.apply(z,a),A=new RegExp("^(nested\\s+)?("+z.join("|")+")(?:\\s|$)")}function C(a,b){return function(c){var e=d(c.target).view({helper:!1});e&&e.cid===b&&(c.originalContext=this,a(c))}}function D(a,d){function h(){try{f.apply(g,arguments)}catch(c){b.onException("thorax-exception: "+(g.name||g.cid)+":"+a,c)}}a+=d.originalName;var e=d.handler,f=c.isFunction(e)?e:this[e];if(!f)throw new Error('Event "'+e+'" does not exist '+(this.name||this.cid)+":"+a);var g=d.context||this;return h._callback=f,h}function E(a,b,d){var e={originalName:a,handler:c.isString(b)?this[b]:b};if(a.match(A)){var f=y.exec(a);e.nested=!!f[1],e.name=f[2],e.type="DOM",e.selector=f[3]}else e.name=a,e.type="view";return e.context=d,e}function I(a){for(;a._helperName&&"view"!==a._helperName;)a=a.parent;return a}function J(a){var b=c.pick(a,"fn","inverse","hash","data");return b.data=c.omit(a.data,"cid","view","yield"),b}function K(a,b){function d(a,b){return c.every(a,function(a,c){return b[c]===a})}return a._helperName!==b._helperName?!1:(a=a._helperOptions,b=b._helperOptions,a.args.length===b.args.length&&d(a.args,b.args)&&c.isEqual(c.keys(a.options),c.keys(b.options))&&c.every(a.options,function(e,f){if("data"===f||"hash"===f)return d(a.options[f],b.options[f]);if("fn"===f||"inverse"===f){if(b.options[f]===e)return!0;var g=b.options[f]||{};return e&&c.has(e,"program")&&!e.depth&&g.program===e.program}return b.options[f]===e}))}function L(a,d){function e(b,e){var f=this[a],g=n(this,d.$el);return b===f?this:(f&&this.unbindDataObject(f),b?(this[a]=b,d.loading&&d.loading.call(this),this.bindDataObject(a,b,c.extend({},this.options,e)),g&&g.attr(d.cidAttrName,b.cid),b.trigger("set",b,f)):(this[a]=!1,d.change&&d.change.call(this,!1),g&&g.removeAttr(d.cidAttrName)),this.trigger("change:data-object",a,b,f),this)}d=o[a]=c.defaults({name:"_"+a+"Events",event:!0},d),d.ctor=function(){if(this[a]){var b=this[a];this[a]=null,this[d.set](b)}},b.View.prototype[d.set]=e}function M(a,b,c){var d=this;r(c,"_"+a+"Events",!0,function(a){function g(){if(d.el)c.apply(e,arguments);else{if(f)throw new Error("destroyed-event:"+d.name+":"+a[0]);f++}}var c=O(a[1],d),e=a[2]||d,f=0;g._callback=c,d.listenTo(b,a[0],g)})}function N(a,b){a.load?a.load(function(){b&&b.success&&b.success(a)},b):a.fetch(b)}function O(a,b){return c.isFunction(a)?a:b[a]}function Q(a){var b=a&&this._objectOptionsByCid[a.cid];this.conditionalRender(b&&b.render)}function Y(a){var b=a&&this._objectOptionsByCid[a.cid]||void 0;this.shouldRender(b&&b.render)&&this.renderCollection&&this.renderCollection()}function Z(a){var b=a&&this._objectOptionsByCid[a.cid]||void 0;this.shouldRender(b&&b.render)&&this.ensureRendered()}function $(){this.itemFilter&&this.collection.forEach(_,this)}function _(a){var b=this.getCollectionElement();this.itemFilter&&b.find("["+P+'="'+a.cid+'"]')[ab.call(this,a)?"show":"hide"]()}function ab(a){return this.itemFilter(a,this.collection.indexOf(a))}function bb(){var a=this.getCollectionElement();this.emptyClass&&a.removeClass(this.emptyClass),a.removeAttr(V),a.empty()}function cb(){var a=this.getCollectionElement();this.emptyClass&&a.addClass(this.emptyClass),a.attr(V,!0),this.appendEmpty()}function eb(a,b,c){var e=0,f=this;this.$("select,input,textarea",a.root||this.el).each(function(){(a.children||f===d(this).view({helper:!1}))&&"button"!==this.type&&"cancel"!==this.type&&"submit"!==this.type&&this.name&&""!==this.name&&(b.call(c||this,e,this),++e)})}function fb(a,b,c,d){for(var e,f=a,g=b.split("["),h=c.mode,i=0;i<g.length-1;++i){if(e=g[i].replace("]",""),!f[e]){if("serialize"!==h)return d.call(this,!1,e);f[e]={}}f=f[e]}e=g[g.length-1].replace("]",""),d.call(this,f,e)}function gb(){this.$("form").removeAttr("data-submit-wait")}function ib(a,b){b=b||{},b.target=this,this.trigger(a,b),c.each(this.children,function(c){c.trigger(a,b)})}function jb(){++this._renderCount,this.$el.attr(hb,this.cid)}function kb(){if(!this.$("["+hb+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function lb(){return this.$("["+hb+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function mb(){e.history||(e.history=new e.History),e.history.on("route",nb,this),this.on("destroyed",function(){e.history.off("route",nb,this)})}function nb(a){this===a&&this.trigger.apply(this,["route"].concat(Array.prototype.slice.call(arguments,1)))}function pb(a){return function(){var b=c.toArray(arguments);b.unshift(a),this.parent.trigger.apply(this.parent,b)}}function rb(a){var b=I(this);if(!this[a]){var c=b[a];c&&(this[a]=c)}}function vb(a){var b=d(a.target),c=b.view({helper:!1}),e=b.attr(sb),f=b.attr(tb),g=!1;e&&(g=c[e].call(c,a)),f&&c.trigger(f,a),"A"===b.tagName&&g===!1&&a.preventDefault()}function xb(){yb(),wb=b._fastClickEventName||"click",d(document).on(wb,ub,vb)}function yb(){wb&&d(document).off(wb,ub,vb)}function Db(a,b){function g(){d!==e.history.getFragment()&&(f=!0,i.cancel(),b&&b())}function h(){e.history.off("route",g),f||a.apply(this,arguments)}var d=e.history.getFragment(),f=!1;e.history.on("route",g);var i=c.bind(h,this);return i.cancel=function(){e.history.off("route",g)},i}function Eb(a,b,d){if(this.isPopulated())return c.defer(a,this);2===arguments.length&&!c.isFunction(b)&&c.isObject(b)&&(d=b,b=!1);var e=this,f=!1,g=Db(c.bind(a,e),function(){f=!0,e._request&&(e._aborted=!0,e._request.abort()),b&&b.call(e,!1)});this.fetch(c.defaults({success:g,error:function(){g.cancel(),!f&&b&&b.apply(e,[!0].concat(c.toArray(arguments)))}},d))}function Fb(a,b){return a.resetQueue&&(this.fetchQueue=void 0),this.fetchQueue?(this.fetchQueue.push(a),void 0):(this.fetchQueue=[a],a=c.defaults({success:Gb(this,this.fetchQueue,"success"),error:Gb(this,this.fetchQueue,"error"),complete:Gb(this,this.fetchQueue,"complete")},a),b&&b.call(this,a),a)}function Gb(a,b,d){return function(){var e=arguments;c.each(b,function(a){a[d]&&a[d].apply(this,e)},this),a.fetchQueue===b&&(a.fetchQueue=void 0)}}function Ib(){this.render()}d.fn.forEach||(d.fn.forEach=function(a,b){d.fn.each.call(this,function(c){a.call(b||this,this,c)})});var f="data-view-name",g="data-view-cid",h="data-view-helper",i={};Handlebars.templates||(Handlebars.templates={}),b.VERSION="2.0.0rc4",b.templatePathPrefix="",b.Views={},b.onException=function(a,b){throw b},b.templates=Handlebars.templates,b.View=e.View.extend({constructor:function(){var a=e.View.apply(this,arguments);return c.each(o,function(b){b.ctor&&b.ctor.call(this,a)},this),a},_configure:function(a){var b=this;this._objectOptionsByCid={},this._boundDataObjectsByCid={},c.each(o,function(a){b[a.name]=[]}),i[this.cid]=this,this.children={},this._renderCount=0,c.extend(this,a||{}),j.call(this),c.each(o,function(a){a.configure&&a.configure.call(this)},this)},setElement:function(){var a=e.View.prototype.setElement.apply(this,arguments);return this.name&&this.$el.attr(f,this.name),this.$el.attr(g,this.cid),a},_addChild:function(a){return this.children[a.cid]=a,a.parent||(a.parent=this),this.trigger("child",a),a},_removeChild:function(a){return delete this.children[a.cid],a.parent=null,a},destroy:function(a){a=c.defaults(a||{},{children:!0}),c.each(this._boundDataObjectsByCid,this.unbindDataObject,this),this.trigger("destroyed"),delete i[this.cid],c.each(this.children,function(b){this._removeChild(b),a.children&&b.destroy()},this),this.parent&&this.parent._removeChild(this),this.el&&(this.undelegateEvents(),this.remove()),this.el=this.$el=void 0,this.parent=void 0,this.model=this.collection=this._collection=void 0,this._helperOptions=void 0},render:function(a){if(this._rendering)throw new Error("nested-render");this._previousHelpers=c.filter(this.children,function(a){return a._helperOptions});var d={};c.each(this.children,function(a,b){a._helperOptions||(d[b]=a)}),this.children=d,this._rendering=!0;try{!c.isUndefined(a)&&(c.isElement(a)||b.Util.is$(a)||a&&a.el||c.isString(a)||c.isFunction(a))?c.isFunction(a)&&(a=this.renderTemplate(a)):(m.call(this,"template",{required:!0}),a=this.renderTemplate(this.template))}finally{this._rendering=!1}return c.each(this._previousHelpers,function(a){a.destroy(),a.parent=void 0}),this._previousHelpers=void 0,this.html(a&&a.el||a&&a.string||a),++this._renderCount,this.trigger("rendered"),a},context:function(){return c.extend({},this.model&&this.model.attributes||{})},_getContext:function(){return c.extend({},this,n(this,"context")||{})},_getData:function(a){return{view:this,cid:c.uniqueId("t"),yield:function(){return a.fn&&a.fn(a)}}},_getHelpers:function(){return this.helpers?c.extend({},Handlebars.helpers,this.helpers):Handlebars.helpers},renderTemplate:function(a,d,e){var f;return d=d||this._getContext(),f=c.isFunction(a)?a:b.Util.getTemplate(a,e),f?f(d,{helpers:this._getHelpers(),data:this._getData(d)}):""},ensureRendered:function(){!this._renderCount&&this.render()},shouldRender:function(a){return a||null==a&&this._renderCount},conditionalRender:function(a){this.shouldRender(a)&&this.render()},appendTo:function(a){this.ensureRendered(),d(a).append(this.el),this.trigger("ready",{target:this})},html:function(a){if(c.isUndefined(a))return this.el.innerHTML;this.trigger("before:append");var b=this._replaceHTML(a);return this.trigger("append"),b},_replaceHTML:function(a){return this.el.innerHTML="",this.$el.append(a)},_anchorClick:function(a){var b=d(a.currentTarget),c=b.attr("href");return c&&("#"===c[0]||"/"===c[0]&&"/"!==c[1])?(e.history.navigate(c,{trigger:!0}),!1):!0}}),b.View.extend=function(){p(this);var a=e.View.extend.apply(this,arguments);return a.__parent__=this,q(a),a},k(b.View,b.Views),d.fn.view=function(a){a=c.defaults(a||{},{helper:!0});var b="["+g+"]";a.helper||(b+=":not(["+h+"])");var e=d(this).closest(b);return e&&i[e.attr(g)]||!1};var o={},v=["id","className","tagName"];b.Util={getViewInstance:function(a,d){if(d=d||{},c.isString(a)){var e=l(b,"Views",a,!1);return e.cid?c.extend(e,d||{}):new e(d)}return c.isFunction(a)?new a(d):a},getTemplate:function(a,c){var e,d=b.templatePathPrefix;if(d&&a.substr(0,d.length)!==d&&(a=d+a),a=a.replace(/\.handlebars$/,""),e=Handlebars.templates[a],e||(a+=".handlebars",e=Handlebars.templates[a]),!e&&!c)throw new Error("templates: "+a+" does not exist.");return e},is$:function(a){return c.isObject(a)&&"length"in a},expandToken:function(a,b){function g(a,b){if(a.match(/^("|')/)&&a.match(/("|')$/))return a.replace(/(^("|')|('|")$)/g,"");for(var c=a.split("."),d=c.length,e=0;b&&d>e;e++)"this"!==c[e]&&(b=b[c[e]]);return b}if(a&&a.indexOf&&a.indexOf("{{")>=0){for(var e,d=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,f=[];e=d.exec(a);)if(e[1]){var h=e[1].split(/\s+/);if(h.length>1){var i=h.shift();h=c.map(h,function(a){return g(a,b)}),Handlebars.helpers[i]?f.push(Handlebars.helpers[i].apply(b,h)):f.push(e[0])}else f.push(g(h[0],b))}else f.push(e[0]);a=f.join("")}return a},tag:function(a,d,e){var f=c.omit(a,"tagName"),g=a.tagName||"div";return"<"+g+" "+c.map(f,function(a,d){if(c.isUndefined(a)||"expand-tokens"===d)return"";var f=a;return e&&(f=b.Util.expandToken(a,e)),("className"===d?"class":d)+'="'+Handlebars.Utils.escapeExpression(f)+'"'}).join(" ")+">"+(c.isUndefined(d)?"":d)+"</"+g+">"}},b.Mixins={},o.mixins={name:"mixins",configure:function(){c.each(this.constructor.mixins,this.mixin,this),c.each(this.mixins,this.mixin,this)}},c.extend(b.View,{mixin:function(a){p(this),this.mixins.push(a)},registerMixin:function(a,c,d){b.Mixins[a]=[c,d]}}),b.View.prototype.mixin=function(a){if(this._appliedMixins||(this._appliedMixins=[]),-1===c.indexOf(this._appliedMixins,a))if(this._appliedMixins.push(a),c.isFunction(a))a.call(this);else{var d=b.Mixins[a];c.extend(this,d[1]),c.isArray(d[0])?d[0][0].apply(this,d[0][1]):d[0].apply(this,c.toArray(arguments).slice(1))}};var x=b.View.prototype.on;o.event={name:"_events",configure:function(){var a=this;r(this.constructor,"_events",!0,function(b){a.on.apply(a,b)}),r(this,"events",!1,function(b,c){a.on(c,b,a)})}},c.extend(b.View,{on:function(a,b){return p(this),s(this,a,b)?this:(c.isObject(a)?c.each(a,function(a,b){this.on(b,a)},this):c.isArray(b)?c.each(b,function(b){this._events.push([a,b])},this):this._events.push([a,b]),this)}}),c.extend(b.View.prototype,{on:function(a,b,d){return s(this,a,b,d)?this:(c.isObject(a)&&arguments.length<3?c.each(a,function(a,c){this.on(c,a,b||this)},this):c.each(c.isArray(b)?b:[b],function(b){var c=E.call(this,a,b,d||this);"DOM"===c.type?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(c)):this._addEvent(c)},this),this)},delegateEvents:function(a){this.undelegateEvents(),a&&(c.isFunction(a)&&(a=a.call(this)),this._eventsToDelegate=[],this.on(a)),this._eventsToDelegate&&c.each(this._eventsToDelegate,this._addEvent,this)},_addEvent:function(a){if("view"===a.type)c.each(a.name.split(/\s+/),function(b){x.call(this,b,D.call(this,"view-event:",a),a.context||this)},this);else{var b=D.call(this,"dom-event:",a);a.nested||(b=C(b,this.cid));var d=a.name+".delegateEvents"+this.cid;a.selector?this.$el.on(d,a.selector,b):this.$el.on(d,b)}}}),b.View.on("ready",function(a){function b(b){b.trigger("ready",a)}this._isReady||(this._isReady=!0,c.each(this.children,b),this.on("child",b))});var A,y=/^(nested\s+)?(\S+)(?:\s+(.+))?/,z=[];B(["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","focus","blur"]);var F="data-view-tmp",G={},H={_ensureElement:function(){b.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(h,this._helperName)},_getContext:function(){return this.parent._getContext.apply(this.parent,arguments)}};b.HelperView=b.View.extend(H),Handlebars.registerViewHelper=function(a,d,e){2===arguments.length&&(d.factory?e=d.callback:(e=d,d=b.HelperView)),Handlebars.registerHelper(a,function(){var f=c.toArray(arguments),g=f.pop(),h=u(g).view,i={template:g.fn||Handlebars.VM.noop,inverse:g.inverse,options:g.hash,declaringView:h,parent:I(h),_helperName:a,_helperOptions:{options:J(g),args:c.clone(f)}};w(g.hash),c.extend(i,c.pick(g.hash,v));var j=c.find(h._previousHelpers,function(a){return K(i,a)});if(j)h._previousHelpers=c.without(h._previousHelpers,j),h.children[j.cid]=j;else{if(d.factory){if(j=d.factory(f,i),!j)return"";j._helperName=i._helperName,j._helperOptions=i._helperOptions}else j=new d(i);f.push(j),h._addChild(j),h.trigger.apply(h,["helper",a].concat(f)),h.trigger.apply(h,["helper:"+a].concat(f)),e&&e.apply(this,f)}var k=c.pick(g.hash,v);k[F]=j.cid;var l=g.hash["expand-tokens"];return new Handlebars.SafeString(b.Util.tag(k,"",l?this:null))});var f=Handlebars.helpers[a];return f},b.View.on("append",function(a,b){(a||this.$el).find("["+F+"]").forEach(function(a){var c=a.getAttribute(F),e=this.children[c];e&&(G[c]?(e.render(G[c]),delete G[c]):e.ensureRendered(),d(a).replaceWith(e.el),b&&b(e.el))},this)}),c.extend(b.View.prototype,{bindDataObject:function(a,b,d){if(this._boundDataObjectsByCid[b.cid])return!1;this._boundDataObjectsByCid[b.cid]=b;var d=this._modifyDataObjectOptions(b,c.extend({},o[a].defaultOptions,d));this._objectOptionsByCid[b.cid]=d,M.call(this,a,b,this.constructor),M.call(this,a,b,this);var e=o[a];return e.bindCallback&&e.bindCallback.call(this,b,d),b.shouldFetch&&b.shouldFetch(d)?N(b,d):o[a].change&&o[a].change.call(this,b,d),!0},unbindDataObject:function(a){return this._boundDataObjectsByCid[a.cid]?(delete this._boundDataObjectsByCid[a.cid],this.stopListening(a),delete this._objectOptionsByCid[a.cid],!0):!1},_modifyDataObjectOptions:function(a,b){return b}});var P="data-model-cid";b.Model=e.Model.extend({isEmpty:function(){return!this.isPopulated()},isPopulated:function(){var a=c.clone(this.attributes),b=n(this,"defaults")||{};for(var d in b){if(a[d]!=b[d])return!0;delete a[d]}var e=c.keys(a);return e.length>1||1===e.length&&e[0]!==this.idAttribute},shouldFetch:function(a){var b;try{b=n(this,"url")}catch(c){b=!1}return a.fetch&&!!b&&!this.isPopulated()}}),b.Models={},k(b.Model,b.Models),L("model",{set:"setModel",defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:Q,$el:"$el",cidAttrName:P}),b.View.on({model:{error:function(a,b){this._objectOptionsByCid[a.cid].errors&&this.trigger("error",b,a)},change:function(a){Q.call(this,a)}}}),d.fn.model=function(a){var b=d(this),c=b.closest("["+P+"]"),e=c&&c.attr(P);if(e){var a=a||b.view();if(a&&a.model&&a.model.cid===e)return a.model||!1;var f=b.collection(a);if(f)return f.get(e)}return!1};var R=e.Collection.prototype.fetch,S=e.Collection.prototype.reset,T=b.View.prototype._replaceHTML,U="data-collection-cid",V="data-collection-empty",W="data-collection-element",X=1;b.Collection=e.Collection.extend({model:b.Model||e.Model,initialize:function(){return this.cid=c.uniqueId("collection"),e.Collection.prototype.initialize.apply(this,arguments)},isEmpty:function(){return this.length>0?!1:0===this.length&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!n(this,"url")},shouldFetch:function(a){return a.fetch&&!!n(this,"url")&&!this.isPopulated()},fetch:function(a){a=a||{};var b=a.success;return a.success=function(a,c){a._fetched=!0,b&&b(a,c)},R.apply(this,arguments)},reset:function(a,b){return this._fetched=!!a,S.call(this,a,b)}}),b.Collections={},k(b.Collection,b.Collections),L("collection",{set:"setCollection",bindCallback:Z,defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:Y,$el:"getCollectionElement",cidAttrName:U}),b.CollectionView=b.View.extend({_defaultTemplate:Handlebars.VM.noop,_collectionSelector:"["+W+"]",_replaceHTML:function(a){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return T.call(this,a);var b,c=this.getCollectionElement();b=T.call(this,a),c.attr("data-view-cid")||this.getCollectionElement().replaceWith(c)},render:function(){var a=this.shouldRender();b.View.prototype.render.apply(this,arguments),a||this.renderCollection()},appendItem:function(a,b,e){if(a){var f,g=this.getCollectionElement();if(e=c.defaults(e||{},{filter:!0}),b&&b.el&&(b=g.children().indexOf(b.el)+1),a.el||c.isString(a)?(f=a,a=!1):(b=b||this.collection.indexOf(a)||0,f=this.renderItem(a,b)),f){f.cid&&(f.ensureRendered(),this._addChild(f)),c.isString(f)&&!f.match(/^\s*</m)&&(f="<div>"+f+"</div>");var h=f.$el?f.$el:c.filter(d(d.trim(f)),function(a){return a.nodeType===X});a&&d(h).attr(P,a.cid);var i=b>0?this.collection.at(b-1):!1;if(i){var j=g.children("["+P+'="'+i.cid+'"]').last();j.after(h)}else g.prepend(h);this.trigger("append",null,function(b){b.setAttribute(P,a.cid)}),!e.silent&&this.trigger("rendered:item",this,this.collection,a,h,b),e.filter&&_.call(this,a)}return f}},updateItem:function(a){var b=this.getCollectionElement(),c=b.find("["+P+'="'+a.cid+'"]');c.attr(g)||(this.removeItem(c),this.appendItem(a))},removeItem:function(a){var b=a;if(a.cid){var c=this.getCollectionElement();b=c.find("["+P+'="'+a.cid+'"]')}if(!b.length)return!1;b.remove();var d=b.attr(g),e=this.children[d];return e&&(this._removeChild(e),e.destroy()),!0},renderCollection:function(){this.collection?(this.collection.isEmpty()?cb.call(this):(bb.call(this),this.collection.forEach(function(a,b){this.appendItem(a,b)},this)),this.trigger("rendered:collection",this,this.collection)):cb.call(this)},emptyClass:"empty",renderEmpty:function(){if(this.emptyTemplate||this.emptyView||m.call(this,"emptyTemplate",{extension:"-empty",required:!1}),this.emptyView){var a={};this.emptyTemplate&&(a.template=this.emptyTemplate);var c=b.Util.getViewInstance(this.emptyView,a);return c.ensureRendered(),c}return this.emptyTemplate&&this.renderTemplate(this.emptyTemplate)},renderItem:function(a,c){if(this.itemTemplate||this.itemView||m.call(this,"itemTemplate",{extension:"-item",required:!this.itemView}),this.itemView){var d={model:a};return this.itemTemplate&&(d.template=this.itemTemplate),b.Util.getViewInstance(this.itemView,d)}return this.renderTemplate(this.itemTemplate,this.itemContext(a,c))},itemContext:function(a){return a.attributes},appendEmpty:function(){var a=this.getCollectionElement();a.empty();var b=this.renderEmpty();b&&this.appendItem(b,0,{silent:!0,filter:!1}),this.trigger("rendered:empty",this,this.collection)},getCollectionElement:function(){var a=this.$(this._collectionSelector);return 0===a.length?this.$el:a}}),b.CollectionView.on({collection:{reset:Y,sort:Y,filter:function(){$.call(this)},change:function(a){this.updateItem(a),_.call(this,a)},add:function(a){var b=this.getCollectionElement();if(1===this.collection.length&&b.length&&bb.call(this),b.length){var c=this.collection.indexOf(a);this.appendItem(a,c)}},remove:function(a){var b=this.getCollectionElement();this.removeItem(a),0===this.collection.length&&b.length&&cb.call(this)}}}),b.View.on({collection:{error:function(a,b){this._objectOptionsByCid[a.cid].errors&&this.trigger("error",b,a)}}}),d.fn.collection=function(a){if(a&&a.collection)return a.collection;var b=d(this),c=b.closest("["+U+"]"),e=c&&c.attr(U);return e&&(a=b.view())?a.collection:!1},o.model.defaultOptions.populate=!0;var db=o.model.change;o.model.change=function(){db.apply(this,arguments);var a=this.model&&this._objectOptionsByCid[this.model.cid];a&&a.populate&&this.populate(this.model.attributes,a.populate===!0?{}:a.populate)},o.model.defaultOptions.populate=!0,c.extend(b.View.prototype,{serialize:function(){for(var a,b,d,e=0;e<arguments.length;++e)c.isFunction(arguments[e])?a=arguments[e]:c.isObject(arguments[e])&&("stopPropagation"in arguments[e]&&"preventDefault"in arguments[e]?d=arguments[e]:b=arguments[e]);if(!d||this._preventDuplicateSubmission(d)){b=c.extend({set:!0,validate:!0,children:!0,silent:!0},b||{});var f=b.attributes||{},g=this,h=[];if(eb.call(this,b,function(){var a=g._getInputValue(this,b,h);c.isUndefined(a)||fb.call(this,f,this.name,{mode:"serialize"},function(b,d){b[d]?c.isArray(b[d])?b[d].push(a):b[d]=[b[d],a]:b[d]=a})}),this.trigger("serialize",f,b),b.validate){var i=this.validateInput(f);if(i&&i.length&&(h=h.concat(i)),this.trigger("validate",f,h,b),h.length)return this.trigger("error",h),void 0}return b.set&&this.model&&!this.model.set(f,{silent:b.silent})?!1:(a&&a.call(this,f,c.bind(gb,this)),f)}},_preventDuplicateSubmission:function(a,b){a.preventDefault();var c=d(a.target);return"form"!==(a.target.tagName||"").toLowerCase()&&(c=d(a.target).closest("form")),c.attr("data-submit-wait")?!1:(c.attr("data-submit-wait","true"),b&&b.call(this,a),!0)},populate:function(a,b){b=c.extend({children:!0},b||{});var d,a=a||this._getContext();eb.call(this,b,function(){fb.call(this,a,this.name,{mode:"populate"},function(a,b){d=a&&a[b],c.isUndefined(d)||("checkbox"===this.type&&c.isBoolean(d)?this.checked=d:"checkbox"===this.type||"radio"===this.type?this.checked=d==this.value:this.value=d)})}),this.trigger("populate",a)},validateInput:function(){},_getInputValue:function(a){if("checkbox"!==a.type&&"radio"!==a.type){if(a.multiple===!0){var b=[];return d("option",a).each(function(){this.selected&&b.push(this.value)}),b}return a.value}return a.checked?a.value:void 0}}),b.View.on({error:function(){gb.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})},deactivated:function(){gb.call(this)}});var hb="data-layout-cid";b.LayoutView=b.View.extend({_defaultTemplate:Handlebars.VM.noop,render:function(){var a=b.View.prototype.render.apply(this,arguments);return this.template===Handlebars.VM.noop?jb.call(this):kb.call(this),a},setView:function(a,d){d=c.extend({scroll:!0,destroy:!0},d||{}),c.isString(a)&&(a=new(b.Util.registryGet(b,"Views",a,!1))),this.ensureRendered();var e=this._view;return a===e?!1:(d.destroy&&a&&(a._shouldDestroyOnNextSetView=!0),this.trigger("change:view:start",a,e,d),e&&(this._removeChild(e),e.$el.remove(),ib.call(e,"deactivated",d),e._shouldDestroyOnNextSetView&&e.destroy()),a?(ib.call(this,"activated",d),a.trigger("activated",d),this._addChild(a),this._view=a,this._view.appendTo(lb.call(this))):this._view=void 0,this.trigger("change:view:end",a,e,d),a)},getView:function(){return this._view}}),Handlebars.registerHelper("layout-element",function(a){var c=u(a).view;if(!c.getView)throw new Error("layout-element must be used within a LayoutView");return a.hash[hb]=c.cid,w(a.hash),new Handlebars.SafeString(b.Util.tag.call(this,a.hash,"",this))}),b.Router=e.Router.extend({constructor:function(){var a=b.Router.__super__.constructor.apply(this,arguments);return mb.call(this),a},route:function(a,b,c){return c||(c=this[b]),e.Router.prototype.route.call(this,a,b,function(){return this.trigger.apply(this,["route:before",a,b].concat(Array.prototype.slice.call(arguments))),c.apply(this,arguments)})}}),b.Routers={},k(b.Router,b.Routers),b.CollectionHelperView=b.CollectionView.extend({events:{"rendered:item":pb("rendered:item"),"rendered:collection":pb("rendered:collection"),"rendered:empty":pb("rendered:empty")},constructor:function(a){c.each(ob,function(c,d){if(a.options[d]){var e=a.options[d];("itemTemplate"===c||"emptyTemplate"===c)&&(e=b.Util.getTemplate(e)),a[c]=e}}),!a.itemTemplate&&a.template&&a.template!==Handlebars.VM.noop&&(a.itemTemplate=a.template,a.template=Handlebars.VM.noop),!a.emptyTemplate&&a.inverse&&a.inverse!==Handlebars.VM.noop&&(a.emptyTemplate=a.inverse,a.inverse=Handlebars.VM.noop);var d=b.HelperView.call(this,a);return this.parent.name&&(this.emptyTemplate||(this.emptyTemplate=b.Util.getTemplate(this.parent.name+"-empty",!0)),this.itemTemplate||(this.itemTemplate=b.Util.getTemplate(this.parent.name+"-item",!!this.itemView))),d},setAsPrimaryCollectionHelper:function(){c.each(qb,function(a){rb.call(this,a)},this);var a=this;c.each(["itemFilter","itemContext","renderItem","renderEmpty"],function(b){a.parent[b]&&!this[b]&&(a[b]=function(){return a.parent[b].apply(a.parent,arguments)})})}}),c.extend(b.CollectionHelperView.prototype,H);var ob={"item-template":"itemTemplate","empty-template":"emptyTemplate","item-view":"itemView","empty-view":"emptyView","empty-class":"emptyClass"},qb=["itemTemplate","itemView","emptyTemplate","emptyView"];Handlebars.registerViewHelper("collection",b.CollectionHelperView,function(a,b){1===arguments.length&&(b=a,a=b.parent.collection,a&&b.setAsPrimaryCollectionHelper(),b.$el.attr(W,"true"),b.listenTo(b.parent,"change:data-object",function(a,c){"collection"===a&&(b.setAsPrimaryCollectionHelper(),b.setCollection(c))})),a&&b.setCollection(a)}),Handlebars.registerHelper("collection-element",function(a){if(!u(a).view.renderCollection)throw new Error("collection-element helper must be declared inside of a CollectionView");var c=a.hash;return w(c),c.tagName=c.tagName||"div",c[W]=!0,new Handlebars.SafeString(b.Util.tag.call(this,c,"",this))}),Handlebars.registerHelper("empty",function(a,b){1===arguments.length&&(b=a);var c=u(b).view;return 1===arguments.length&&(a=c.model),c._emptyListeners||(c._emptyListeners={}),a&&!c._emptyListeners[a.cid]&&a.models&&"length"in a&&(c._emptyListeners[a.cid]=!0,c.listenTo(a,"remove",function(){0===a.length&&c.render()}),c.listenTo(a,"add",function(){1===a.length&&c.render()}),c.listenTo(a,"reset",function(){c.render()})),!a||a.isEmpty()?b.fn(this):b.inverse(this)}),Handlebars.registerHelper("template",function(a,b){var d=c.extend({fn:b&&b.fn},this,b?b.hash:{}),e=u(b).view.renderTemplate(a,d);return new Handlebars.SafeString(e)}),Handlebars.registerHelper("yield",function(a){return u(a).yield&&a.data.yield()}),Handlebars.registerHelper("url",function(a){var d;if(arguments.length>2)d=c.map(c.head(arguments,arguments.length-1),encodeURIComponent).join("/");else{var f=arguments[1],g=f&&f.hash||f;d=g&&g["expand-tokens"]?b.Util.expandToken(a,this):a}if(e.history._hasPushState){var h=e.history.options.root;return"/"===h&&"/"===d.substr(0,1)?d:h+d}return"#"+d}),Handlebars.registerViewHelper("view",{factory:function(a,c){var d=a.length>=1?a[0]:b.View;return b.Util.getViewInstance(d,c.options)},callback:function(){var a=arguments[arguments.length-1],b=a._helperOptions.options,c=a.cid;b.fn&&(G[c]=b.fn)}});var sb="data-call-method",tb="data-trigger-event";Handlebars.registerHelper("button",function(a,c){1===arguments.length&&(c=a,a=c.hash.method);var d=c.hash,e=d["expand-tokens"];if(delete d["expand-tokens"],!a&&!c.hash.trigger)throw new Error("button helper must have a method name as the first argument or a 'trigger', or a 'method' attribute specified.");return w(d),d.tagName=d.tagName||"button",d.trigger&&(d[tb]=d.trigger),delete d.trigger,a&&(d[sb]=a),new Handlebars.SafeString(b.Util.tag(d,c.fn?c.fn(this):"",e?this:null))}),Handlebars.registerHelper("link",function(){var a=c.toArray(arguments),d=a.pop(),e=d.hash,f=0===a.length?[e.href]:a,g=e["expand-tokens"];if(delete e["expand-tokens"],!f[0]&&""!==f[0])throw new Error("link helper requires an href as the first argument or an 'href' attribute");return w(e),f.push(d),e.href=Handlebars.helpers.url.apply(this,f),e.tagName=e.tagName||"a",e.trigger&&(e[tb]=d.hash.trigger),delete e.trigger,e[sb]="_anchorClick",new Handlebars.SafeString(b.Util.tag(e,d.fn?d.fn(this):"",g?this:null))});var wb,ub="["+sb+"], ["+tb+"]";d(document).ready(function(){b._fastClickEventName||xb()});var zb="data-element-tmp";Handlebars.registerHelper("element",function(a,d){w(d.hash);var e=c.uniqueId("element"),f=u(d).view,g=c.pick(d.hash,v);return g[zb]=e,f._elementsByCid||(f._elementsByCid={}),f._elementsByCid[e]=a,new Handlebars.SafeString(b.Util.tag(g))}),b.View.on("append",function(a,b){(a||this.$el).find("["+zb+"]").forEach(function(a){var e=d(a),f=e.attr(zb),g=this._elementsByCid[f];c.isFunction(g)&&(g=g.call(this)),e.replaceWith(g),b&&b(g)},this)}),Handlebars.registerHelper("super",function(a){var d=u(a).view,e=d.constructor&&d.constructor.__super__;if(e){var f=e.template;if(!f){if(!e.name)throw new Error("Cannot use super helper when parent has no name or template.");f=e.name}return c.isString(f)&&(f=b.Util.getTemplate(f,!1)),new Handlebars.SafeString(f(this,a))}return""});var Cb,Ab="load:start",Bb="load:end";
b.setRootObject=function(a){Cb=a},b.loadHandler=function(a,d,f){var g=c.uniqueId("load");return function(h,i,j){function m(){if(!l.timeout||l.run){var c=void 0!==k._loadingTimeoutDuration?k._loadingTimeoutDuration:b.View.prototype._loadingTimeoutDuration;l.timeout=setTimeout(function(){try{l.run=!0,a.call(k,l.message,l.background,l)}catch(c){b.onException("loadStart",c)}},1e3*c)}}var k=f||this;k._loadInfo=k._loadInfo||{};var l=k._loadInfo[g];l?(clearTimeout(l.endTimeout),l.message=h,!i&&l.background&&(l.background=!1,m())):(l=k._loadInfo[g]=c.extend({isLoading:function(){return l.events.length},cid:g,events:[],timeout:0,message:h,background:!!i},e.Events),m()),c.indexOf(l.events,j)>=0||(l.events.push(j),j.on(Bb,function n(){var a=k._loadingTimeoutEndDuration;void 0===a&&(a=b.View.prototype._loadingTimeoutEndDuration);var e=l.events,f=c.indexOf(e,j);f>=0&&!j.isLoading()&&(e.splice(f,1),c.indexOf(e,j)<0&&j.off(Bb,n)),e.length||(clearTimeout(l.endTimeout),l.endTimeout=setTimeout(function(){try{e.length||(l.run&&(d.call(k,l.background,l),l.trigger(Bb,l)),clearTimeout(l.timeout),l=k._loadInfo[g]=void 0)}catch(a){b.onException("loadEnd",a)}},1e3*a))}))}},b.forwardLoadEvents=function(a,b,c){function d(e,f,g){c&&a.off(Ab,d),b.trigger(Ab,e,f,g)}return a.on(Ab,d),{off:function(){a.off(Ab,d)}}},b.mixinLoadable=function(a,b){c.extend(a,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(a,c,e){var f=b?this.parent:this;f&&f.el&&(f.nonBlockingLoad||c||!Cb||Cb===this||Cb.trigger(Ab,a,c,e),f._isLoading=!0,d(f.el).addClass(f._loadingClassName),f.trigger("change:load-state","start",c))},onLoadEnd:function(){var a=b?this.parent:this;a&&a.el&&(a._isLoading=!1,d(a.el).removeClass(a._loadingClassName),a.trigger("change:load-state","end"))}})},b.mixinLoadableEvents=function(a,b){c.extend(a,{_loadCount:0,isLoading:function(){return this._loadCount>0},loadStart:function(a,c){this._loadCount++;var d=b?this.parent:this;d.trigger(Ab,a,c,d)},loadEnd:function(){this._loadCount--;var a=b?this.parent:this;a.trigger(Bb,a)}})},b.mixinLoadable(b.View.prototype),b.mixinLoadableEvents(b.View.prototype),b.HelperView&&(b.mixinLoadable(b.HelperView.prototype,!0),b.mixinLoadableEvents(b.HelperView.prototype,!0)),b.CollectionHelperView&&(b.mixinLoadable(b.CollectionHelperView.prototype,!0),b.mixinLoadableEvents(b.CollectionHelperView.prototype,!0)),b.sync=function(a,b,c){var d=this,f=c.complete;return c.complete=function(){d._request=void 0,d._aborted=!1,f&&f.apply(this,arguments)},this._request=e.sync.apply(this,arguments),this._request};var Hb=[];b.Model&&Hb.push(b.Model),b.Collection&&Hb.push(b.Collection),c.each(Hb,function(a){var d=a.prototype.fetch;b.mixinLoadableEvents(a.prototype,!1),c.extend(a.prototype,{sync:b.sync,fetch:function(a){a=a||{};var b=this,c=a.complete;return a.complete=function(){c&&c.apply(this,arguments),b.loadEnd()},b.loadStart(void 0,a.background),Fb.call(this,a||{},d)},load:function(a,d,e){2!==arguments.length||c.isFunction(d)||(e=d,d=!1),e=e||{},e.background||this.isPopulated()||!Cb||b.forwardLoadEvents(this,Cb,!0),Eb.call(this,a,d,e)}})}),b.Util.bindToRoute=Db,b.Router&&(b.Router.bindToRoute=b.Router.prototype.bindToRoute=Db),b.View.prototype._modifyDataObjectOptions=function(a,b){return b.ignoreErrors=this.ignoreFetchError,b.background=this.nonBlockingLoad,b},b.HelperView.prototype._modifyDataObjectOptions=b.CollectionHelperView.prototype._modifyDataObjectOptions=function(a,b){return b.ignoreErrors=this.parent.ignoreFetchError,b.background=this.parent.nonBlockingLoad,b},o.collection.loading=function(){var a=this.loadingView,d=this.loadingTemplate,e=this.loadingPlacement;if(a||d){var f=b.loadHandler(c.bind(function(){var c;if(0===this.collection.length&&this.$el.empty(),a){var f=b.Util.getViewInstance(a);this._addChild(f),d?f.render(d):f.render(),c=f}else c=this.renderTemplate(d);var g=e?e.call(this):this.collection.length;this.appendItem(c,g),this.$el.children().eq(g).attr("data-loading-element",this.collection.cid)},this),c.bind(function(){this.$el.find('[data-loading-element="'+this.collection.cid+'"]').remove()},this),this.collection);this.listenTo(this.collection,"load:start",f)}},ob&&(ob["loading-template"]="loadingTemplate",ob["loading-view"]="loadingView",ob["loading-placement"]="loadingPlacement"),b.View.on({"load:start":b.loadHandler(function(a,b,c){this.onLoadStart(a,b,c)},function(a,b){this.onLoadEnd(b)}),collection:{"load:start":function(a,b,c){this.trigger(Ab,a,b,c)}},model:{"load:start":function(a,b,c){this.trigger(Ab,a,b,c)}}}),Handlebars.registerHelper("loading",function(a){var b=u(a).view;return b.off("change:load-state",Ib,b),b.on("change:load-state",Ib,b),b._isLoading?a.fn(this):a.inverse(this)});var Jb=/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());return Jb&&(b.View.on("before:append",function(){this._renderCount>0&&(c.each(this._elementsByCid,function(a){d(a).detach()}),c.each(this.children,function(a){a.$el.detach()}))}),b.CollectionView.prototype._replaceHTML=function(a){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return T.call(this,a);var b,c=this.getCollectionElement().clone(!0,!0);b=T.call(this,a),c.attr("data-view-cid")||this.getCollectionElement().replaceWith(c)}),b});