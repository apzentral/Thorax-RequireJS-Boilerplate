/*
Copyright (c) 2011-2013 @WalmartLabs

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to
deal in the Software without restriction, including without limitation the
rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
sell copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.
*/

(function(e,t){typeof exports!="undefined"?t(e,exports,require("underscore"),Backbone):typeof define=="function"&&define.amd?define(["underscore","jquery","backbone","exports"],function(n,r,i,s){e.Thorax=t(e,s,n,r,i)}):e.Thorax=t(e,{},e._,e.jQuery||e.Zepto||e.ender||e.$,e.Backbone)})(this,function(e,t,n,r,i){function f(){var e=this._constructorArg,t=this;this._referenceCount=0,this._objectOptionsByCid={},this._boundDataObjectsByCid={},n.each(g,function(e){t[e.name]=[]}),a[this.cid]=this,this.children={},this._renderCount=0,n.extend(this,e||{}),l.call(this),n.each(g,function(e){e.configure&&e.configure.call(this)},this),this.trigger("configure")}function l(){this.helpers&&n.each(this.helpers,function(e,t){var r=this;this.helpers[t]=function(){var t=n.toArray(arguments),i=n.last(t);return i.context=this,e.apply(r,t)}},this)}function c(e){return'Error "'+e+'". For more information visit http://thoraxjs.org/error-codes.html'+"#"+e}function h(e,t){var n=e.extend;e.extend=function(){var e=n.apply(this,arguments);return e.prototype.name&&(t[e.prototype.name]=e),e}}function p(e,t,r,i){var s=e[t],o;if(n.indexOf(r,".")>=0){var u=r.split(/\./);r=u.pop(),n.each(u,function(e){s=s[e]})}s&&(o=s[r]);if(!o&&!i)throw new Error(t+": "+r+" does not exist.");return o}function d(e,r){var i;n.isString(this[e])?i=t.Util.getViewClass(this[e],!0):this.name&&!n.isFunction(this[e])&&(i=t.Util.getViewClass(this.name+(r.extension||""),!0)),i&&!n.isFunction(this[e])&&(this[e]=i);if(r.required&&!n.isFunction(this[e]))throw new Error("View "+(this.name||this.cid)+" requires: "+e)}function v(e,r){var i;n.isString(this[e])?i=t.Util.getTemplate(this[e],!0):this.name&&!n.isFunction(this[e])&&(i=t.Util.getTemplate(this.name+(r.extension||""),!0)),!i&&e==="template"&&this._defaultTemplate&&(i=this._defaultTemplate),i&&!n.isFunction(this[e])&&(this[e]=i);if(r.required&&!n.isFunction(this[e])){var s=new Error("view-requires: "+e);throw s.info={name:this.name||this.cid,parent:this.parent&&(this.parent.name||this.parent.cid),helperName:this._helperName},s}}function m(e,t,r){return!e||!e[t]?null:n.isFunction(e[t])?e[t].call(r||e):e[t]}function y(e){n.each(g,function(t){e[t.name]||(e[t.name]=[])})}function b(e){n.each(g,function(t){e[t.name]=[]})}function w(e,t,r,i){var s=[];n.has(e,t)&&s.push(e);var o=e;if(r)while(o=o.__parent__)n.has(o,t)&&s.push(o);else{o=o.constructor;while(o)o.prototype&&n.has(o.prototype,t)&&s.push(o.prototype),o=o.__super__&&o.__super__.constructor}var u=s.length;while(u--)n.each(m(s[u],t,e),i)}function E(e,t,r,i){if(n.isObject(r)){var s=g[t];if(s&&s.event)return e&&e.listenTo&&e[t]&&e[t].cid?x(e,r,i,t):x(e["_"+t+"Events"],r,i),!0}}function S(e,t,n,r,i){function u(){if(e.el)s.apply(i,arguments);else{if(o)throw new Error("destroyed-event:"+e.name+":"+n);o++}}var s=V(r,e),o=0;u._callback=s._callback||s,u._thoraxBind=!0,e.listenTo(t,n,u)}function x(e,t,r,i){function s(t,n){i?S(e,e[i],n,t,r||e):e.push([n,t,r])}n.each(t,function(e,t){n.isArray(e)?n.each(e,function(e){s(e,t)}):s(e,t)})}function T(e){if(!e||!e.data)throw new Error(c("handlebars-no-data"));return e.data}function N(e){e.tag&&(e.tagName=e.tag,delete e.tag),e["class"]&&(e.className=e["class"],delete e["class"])}function k(e){if(!C){var t="area,base,br,col,embed,hr,img,input,keygen,link,menuitem,meta,param,source,track,wbr";C={},n.each(t.split(","),function(e){C[e]=!0})}return C[e]}function _(e){O.push.apply(O,e),M=new RegExp("^(nested\\s+)?("+O.join("|")+")(?:\\s|$)")}function D(e,t){return function(n){var i=r(n.target).view({helper:!1});if(i&&i.cid===t)return n.originalContext=this,e(n)}}function P(e,r){e+=r.originalName;var i=r.handler,s=n.isFunction(i)?i:this[i];if(!s)throw new Error('Event "'+i+'" does not exist '+(this.name||this.cid)+":"+e);var o=r.context||this,u=t.bindSection("thorax-event",{view:o.name||o.cid,eventName:e},n.bind(s,o));return u._callback=s,u._thoraxBind=!0,u}function H(e,t,r){var i={originalName:e,handler:n.isString(t)?this[t]:t};if(e.match(M)){var s=A.exec(e);i.nested=!!s[1],i.name=s[2],i.type="DOM",i.selector=s[3]}else i.name=e,i.type="view";return i.context=r,i}function I(e){while(e._helperName&&e._helperName!=="view")e=e.parent;return e}function q(e,r){if(r["expand-tokens"])return delete r["expand-tokens"],n.each(r,function(n,i){r[i]=t.Util.expandToken(n,e)}),!0}function R(e){var t=n.pick(e,"fn","inverse","hash","data");return t.data=n.omit(e.data,"cid","view","yield","root","_parent"),t}function U(e,t){function r(e,t){return n.every(e,function(e,n){return t[n]===e})}return e._helperName!==t._helperName?!1:(e=e._helperOptions,t=t._helperOptions,e.args.length===t.args.length&&r(e.args,t.args)&&n.isEqual(n.keys(e.options),n.keys(t.options))&&n.every(e.options,function(i,s){if(s==="data"||s==="hash")return r(e.options[s],t.options[s]);if(s==="fn"||s==="inverse"){if(t.options[s]===i)return!0;var o=t.options[s]||{};return i&&n.has(i,"program")&&!i.depth&&o.program===i.program}return t.options[s]===i}))}function z(e,r){function i(t,i){var s=this[e],o=m(this,r.$el);return t===s?this:(s&&this.unbindDataObject(s),t?(this[e]=t,r.loading&&r.loading.call(this),this.bindDataObject(e,t,n.extend({},this.options,i)),o&&o.attr(r.cidAttrName,t.cid),t.trigger("set",t,s)):(this[e]=!1,r.change&&r.change.call(this,!1),o&&o.removeAttr(r.cidAttrName)),this.trigger("change:data-object",e,t,s),this)}r=g[e]=n.defaults({name:"_"+e+"Events",event:!0},r),r.ctor=function(){if(this[e]){var t=this[e];this[e]=null,this[r.set](t)}},t.View.prototype[r.set]=i}function W(e,t,n){var r=this;w(n,"_"+e+"Events",!0,function(e){S(r,t,e[0],e[1],e[2]||r)})}function X(e,t){e.load?e.load(function(){t&&t.success&&t.success(e)},t):e.fetch(t)}function V(e,t){return n.isFunction(e)?e:t[e]}function J(e,t){if(t&&t.serializing)return;var n=this.getObjectOptions(e)||{};this.conditionalRender(n.render)}function nt(e){var t=this.getObjectOptions(e)||undefined;this.shouldRender(t&&t.render)&&this.renderCollection&&this.renderCollection()}function rt(e){var t=this.getObjectOptions(e)||undefined;this.shouldRender(t&&t.render)&&this.ensureRendered()}function it(){this.itemFilter&&this.collection.forEach(st,this)}function st(e){var t=this.getCollectionElement();this.itemFilter&&t.find("["+$+'="'+e.cid+'"]')[ot.call(this,e)?"show":"hide"]()}function ot(e){return this.itemFilter.call(this,e,this.collection.indexOf(e))}function ut(){var e=this.getCollectionElement();this.emptyClass&&e.removeClass(this.emptyClass),e.removeAttr(Z),e.empty()}function at(){var e=this.getCollectionElement();this.emptyClass&&e.addClass(this.emptyClass),e.attr(Z,!0),this.appendEmpty()}function lt(e,t){return n.each(e,function(r,i){if(n.isObject(r))return lt(r,t);t(r,i,e)===!1&&delete e[i]}),e}function ct(){dt.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})}function ht(e,t,n){var i=0;r("select,input,textarea",t.root||e.el).each(function(){if(!t.children&&e!==r(this).view({helper:!1}))return;this.type!=="button"&&this.type!=="cancel"&&this.type!=="submit"&&this.name&&(n(this,i),++i)})}function pt(e,t,n,r){var i,s=e,o=t.split("["),u=n.mode;for(var a=0;a<o.length-1;++a){i=o[a].replace("]","");if(!s[i]){if(u!=="serialize")return r(undefined,i);s[i]={}}s=s[i]}i=o[o.length-1].replace("]",""),r(s,i)}function dt(){this.$("form").removeAttr("data-submit-wait")}function vt(e){var t=e.getObjectOptions(e.model)||{};return t.populate===!0?{}:t.populate}function gt(e,t){t=t||{},t.target=this,this.trigger(e,t),n.each(this.children,function(n){n.trigger(e,t)})}function yt(){++this._renderCount,this.$el.attr(mt,this.cid)}function bt(){if(!this.$("["+mt+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function wt(){return this.$("["+mt+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function Et(e){return function(){var t=n.toArray(arguments);t.unshift(e),this.parent.trigger.apply(this.parent,t)}}function xt(e){var t=I(this);if(!this[e]){var n=t[e];n&&(this[e]=n)}}function kt(e){var t=r(this),n=t.view({helper:!1}),i=t.attr(Tt),s=t.attr(Nt),o=!1;i&&(o=n[i].call(n,e)),s&&n.trigger(s,e),this.tagName==="A"&&o===!1&&e.preventDefault()}function At(){Ot(),Lt=t._fastClickEventName||"click",r(document).on(Lt,Ct,kt)}function Ot(){Lt&&r(document).off(Lt,Ct,kt)}function Ht(e,t){function o(){if(r===i.history.getFragment())return;s=!0,a.cancel(),t&&t()}function u(){i.history.off("route",o),s||e.apply(this,arguments)}var r=i.history.getFragment(),s=!1;i.history.on("route",o);var a=n.bind(u,this);return a.cancel=function(){i.history.off("route",o)},a}function Bt(e,t,r){if(this.isPopulated())return n.defer(e,this);arguments.length===2&&!n.isFunction(t)&&n.isObject(t)&&(r=t,t=!1);var i=this,s=!1,o=Ht(n.bind(e,i),function(){s=!0,i._request&&(i._aborted=!0,i._request.abort()),t&&t.call(i,!1)});this.fetch(n.defaults({success:o,error:function(){o.cancel(),!s&&t&&t.apply(i,[!0].concat(n.toArray(arguments)))}},r))}function jt(e,t){if(e.resetQueue)this.fetchQueue=undefined;else if(this.fetchQueue){var r=(this.fetchQueue[0]||{}).reset;if(r!==e.reset)throw new Error(c("mixed-fetch"))}if(!this.fetchQueue){this.fetchQueue=[e],e=n.defaults({success:Ft(this,this.fetchQueue,"success"),error:Ft(this,this.fetchQueue,"error"),complete:Ft(this,this.fetchQueue,"complete")},e);if(t){var i=t.call(this,e);return this.fetchQueue&&(this.fetchQueue._promise=i),i}return e}return this.fetchQueue.push(e),this.fetchQueue._promise}function Ft(e,t,r){return function(){var i=arguments;n.each(t,function(e){e[r]&&e[r].apply(this,i)},this),e.fetchQueue===t&&(e.fetchQueue=undefined)}}function qt(){this.render()}r.fn.forEach||(r.fn.forEach=function(e,t){r.fn.each.call(this,function(n){e.call(t||this,this,n)})});var s="data-view-name",o="data-view-cid",u="data-view-helper",a={};Handlebars.templates||(Handlebars.templates={}),t.templatePathPrefix="",t.Views={},t.bindSection=function(e,n,r){return r||(r=n,n=undefined),function(){try{return r.apply(this,arguments)}catch(i){t.onException(e,i,n)}}},t.runSection=function(e,n,r){return t.bindSection(e,n,r)()},t.onException=function(e,t){throw t},t.templates=Handlebars.templates,t.View=i.View.extend({constructor:function(){this._constructorArg=arguments[0];var e=i.View.apply(this,arguments);return delete this._constructorArg,n.each(g,function(t){t.ctor&&t.ctor.call(this,e)},this),e},_configure:function(){},_ensureElement:function(){return f.call(this),i.View.prototype._ensureElement.call(this)},toString:function(){return"[object View."+this.name+"]"},setElement:function(){var e=i.View.prototype.setElement.apply(this,arguments);return this.name&&this.$el.attr(s,this.name),this.$el.attr(o,this.cid),e},_addChild:function(e){return this.children[e.cid]?e:(e.retain(),this.children[e.cid]=e,e.parent&&e.parent!==this&&!e._helperOptions&&e.parent._removeChild(e),e.parent=this,this.trigger("child",e),e)},_removeChild:function(e){return delete this.children[e.cid],e.parent=null,e.release(),e},_destroy:function(e){n.each(this._boundDataObjectsByCid,this.unbindDataObject,this),this.trigger("destroyed"),delete a[this.cid],n.each(this.children,function(e){this._removeChild(e)},this),this.el&&(this.undelegateEvents(),this.remove(),this.off()),this.el=this.$el=undefined,this.parent=undefined,this.model=this.collection=this._collection=undefined,this._helperOptions=undefined},render:function(e){var r=this;if(!r.el)return;return t.runSection("thorax-render",{name:r.name},function(){if(r._rendering)throw new Error(c("nested-render"));r._previousHelpers=n.filter(r.children,function(e){return e._helperOptions});var i={};n.each(r.children,function(e,t){e._helperOptions||(i[t]=e)}),r.children=i,r.trigger("before:rendered"),r._rendering=!0;try{n.isUndefined(e)||!n.isElement(e)&&!t.Util.is$(e)&&(!e||!e.el)&&!n.isString(e)&&!n.isFunction(e)?(v.call(r,"template",{required:!0}),e=r.renderTemplate(r.template)):n.isFunction(e)&&(e=r.renderTemplate(e)),n.each(r._previousHelpers,function(e){r._removeChild(e)},r),r._previousHelpers=undefined,r.html(e&&e.el||e&&e.string||e),++r._renderCount,r.trigger("rendered")}finally{r._rendering=!1}}),e},context:function(){return n.extend({},this.model&&this.model.attributes||{})},_getContext:function(){return n.extend({},this,m(this,"context")||{})},_getData:function(e){return{view:this,cid:n.uniqueId("t"),yield:function(){return e.fn&&e.fn(e)}}},renderTemplate:function(e,r,i){var s;return r=r||this._getContext(),n.isFunction(e)?s=e:s=t.Util.getTemplate(e,i),s?s(r,{helpers:this.helpers,data:this._getData(r)}):""},ensureRendered:function(){!this._renderCount&&this.render()},shouldRender:function(e){return e||e==null&&this._renderCount},conditionalRender:function(e){this.shouldRender(e)&&this.render()},appendTo:function(e){this.ensureRendered(),r(e).append(this.el),this.trigger("ready",{target:this})},html:function(e){if(n.isUndefined(e))return this.el.innerHTML;this.trigger("before:append");var t=this._replaceHTML(e);return this.trigger("append"),t},release:function(){--this._referenceCount,this._referenceCount<=0&&this._destroy()},retain:function(e){++this._referenceCount,e&&this.listenTo(e,"destroyed",e.release)},_replaceHTML:function(e){return this.el.innerHTML="",this.$el.append(e)},_anchorClick:function(e){var t=r(e.currentTarget),n=t.attr("href");return n&&(n[0]==="#"||n[0]==="/"&&n[1]!=="/")?(i.history.navigate(n,{trigger:!0}),!1):!0}}),t.View.extend=function(){y(this);var e=i.View.extend.apply(this,arguments);return e.__parent__=this,b(e),e},h(t.View,t.Views),r.fn.view=function(e){e=n.defaults(e||{},{helper:!0});var t="["+o+"]";e.helper||(t+=":not(["+u+"])");var i=r(this).closest(t);return i&&a[i.attr(o)]||!1};var g={},C;t.Util={getViewInstance:function(e,n){var r=t.Util.getViewClass(e,!0);return r?new r(n||{}):e},getViewClass:function(e,r){return n.isString(e)?p(t,"Views",e,r):n.isFunction(e)?e:!1},getTemplate:function(e,n){var r=t.templatePathPrefix,i;r&&e.substr(0,r.length)!==r&&(e=r+e),e=e.replace(/\.handlebars$/,""),i=Handlebars.templates[e],i||(e+=".handlebars",i=Handlebars.templates[e]);if(!i&&!n)throw new Error("templates: "+e+" does not exist.");return i},is$:function(e){return n.isObject(e)&&"length"in e},expandToken:function(e,t,r){if(e&&e.indexOf&&e.indexOf("{{")>=0){var i=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,s,o=[];function u(e,t){if(e.match(/^("|')/)&&e.match(/("|')$/))return e.replace(/(^("|')|('|")$)/g,"");var i=e.split("."),s=i.length;for(var o=0;t&&o<s;o++)i[o]!=="this"&&(t=t[i[o]]);return r&&n.isString(t)?encodeURIComponent(t):t}while(s=i.exec(e))if(s[1]){var a=s[1].split(/\s+/);if(a.length>1){var f=a.shift();a=n.map(a,function(e){return u(e,t)}),Handlebars.helpers[f]?o.push(Handlebars.helpers[f].apply(t,a)):o.push(s[0])}else o.push(u(a[0],t))}else o.push(s[0]);e=o.join("")}return e},tag:function(e,r,i){var s=n.omit(e,"tagName"),o=e.tagName||"div",u=k(o);if(u&&r)throw new Error(c("void-tag-content"));var a="<"+o+" "+n.map(s,function(e,r){if(n.isUndefined(e)||r==="expand-tokens")return"";var s=e;return i&&(s=t.Util.expandToken(e,i)),(r==="className"?"class":r)+'="'+Handlebars.Utils.escapeExpression(s)+'"'}).join(" ")+">";return u?a:a+(n.isUndefined(r)?"":r)+"</"+o+">"}},t.Mixins={},n.extend(t.View,{mixin:function(e){t.Mixins[e](this)},registerMixin:function(e,r,i){t.Mixins[e]=function(e){var t=!!e.cid;i&&n.extend(t?e:e.prototype,i),t?r.call(e):e.on("configure",r)}}}),t.View.prototype.mixin=function(e){t.Mixins[e](this)};var L=t.View.prototype.on;g.event={name:"_events",configure:function(){var e=this;w(this.constructor,"_events",!0,function(t){e.on.apply(e,t)}),w(this,"events",!1,function(t,n){e.on(n,t,e)})}},n.extend(t.View,{on:function(e,t){return y(this),E(this,e,t)?this:(n.isObject(e)?n.each(e,function(e,t){this.on(t,e)},this):n.isArray(t)?n.each(t,function(t){this._events.push([e,t])},this):this._events.push([e,t]),this)}}),n.extend(t.View.prototype,{on:function(e,t,r){return E(this,e,t,r)?this:(n.isObject(e)&&arguments.length<3?n.each(e,function(e,n){this.on(n,e,t||this)},this):n.each(n.isArray(t)?t:[t],function(t){var n=H.call(this,e,t,r||this);n.type==="DOM"&&!this._eventsDelegated?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(n)):this._addEvent(n)},this),this)},delegateEvents:function(e){this.undelegateEvents(),e&&(n.isFunction(e)&&(e=e.call(this)),this._eventsToDelegate=[],this.on(e)),this._eventsToDelegate&&n.each(this._eventsToDelegate,this._addEvent,this),this._eventsDelegated=!0},_addEvent:function(e){if(e.handler._thoraxBind)return L.call(this,e.name,e.handler,e.context||this);var n=P.call(this,e.type+"-event:",e);if(e.type==="view")e.context&&e.context!==this&&e.context instanceof t.View?S(e.context,this,e.name,n,e.context):L.call(this,e.name,n,e.context||this);else{e.nested||(n=D(n,this.cid));var r=e.name+".delegateEvents"+this.cid;e.selector?this.$el.on(r,e.selector,n):this.$el.on(r,n)}}}),t.View.prototype.bind=t.View.prototype.on,t.View.on("ready",function(e){if(!this._isReady){this._isReady=!0;function t(t){t._isReady||t.trigger("ready",e)}n.each(this.children,t),this.on("child",t)}});var A=/^(nested\s+)?(\S+)(?:\s+(.+))?/,O=[],M;_(["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","input","focus","blur"]);var B="data-view-tmp",j={},F={_ensureElement:function(){t.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(u,this._helperName)},_getContext:function(){return this.parent._getContext.apply(this.parent,arguments)}};t.HelperView=t.View.extend(F),Handlebars.registerViewHelper=function(e,r,i){arguments.length===2&&(r.factory?i=r.callback:(i=r,r=t.HelperView));var s=r.attributeWhiteList;Handlebars.registerHelper(e,function(){var o=n.toArray(arguments),u=o.pop(),a=T(u).view,f=q(this,u.hash),l={inverse:u.inverse,options:u.hash,declaringView:a,parent:I(a),_helperName:e,_helperOptions:{options:R(u),args:n.clone(o)}};N(u.hash);var c=n.clone(u.hash);n.each(s,function(e,t){delete c[t],n.isUndefined(u.hash[t])||(l[e]=u.hash[t])}),c.tagName&&(l.tagName=c.tagName),l.attributes=function(){var e=r.prototype&&r.prototype.attributes||{};return n.isFunction(e)&&(e=e.apply(this,arguments)),n.extend(e,n.omit(c,["tagName"])),e.className&&(e["class"]=e.className,delete e.className),e},u.fn?l.template=u.fn:r&&r.prototype&&!r.prototype.template&&(l.template=Handlebars.VM.noop);var h=n.find(a._previousHelpers,function(e){return U(l,e)});if(!h){if(r.factory){h=r.factory(o,l);if(!h)return"";h._helperName=l._helperName,h._helperOptions=l._helperOptions}else h=new r(l);if(!h.el)throw new Error("insert-destroyed-factory");a._previousHelpers=n.without(a._previousHelpers,h),o.push(h),a._addChild(h),a.trigger.apply(a,["helper",e].concat(o)),a.trigger.apply(a,["helper:"+e].concat(o)),i&&i.apply(this,o)}else{if(!h.el)throw new Error("insert-destroyed");a._previousHelpers=n.without(a._previousHelpers,h),a.children[h.cid]=h}return c[B]=h.cid,r.modifyHTMLAttributes&&r.modifyHTMLAttributes(c,h),new Handlebars.SafeString(t.Util.tag(c,"",f?this:null))});var o=Handlebars.helpers[e];return o},t.View.on("append",function(e,t){(e||this.$el).find("["+B+"]").forEach(function(e){var n=e.getAttribute(B),i=this.children[n];i&&(j[n]?(i.render(j[n]),delete j[n]):i.ensureRendered(),r(e).replaceWith(i.el),t&&t(i.el))},this)}),n.extend(t.View.prototype,{getObjectOptions:function(e){return e&&this._objectOptionsByCid[e.cid]},bindDataObject:function(e,t,r){if(this._boundDataObjectsByCid[t.cid])return!1;this._boundDataObjectsByCid[t.cid]=t;var r=this._modifyDataObjectOptions(t,n.extend({},g[e].defaultOptions,r));this._objectOptionsByCid[t.cid]=r,W.call(this,e,t,this.constructor),W.call(this,e,t,this);var i=g[e];return i.bindCallback&&i.bindCallback.call(this,t,r),t.shouldFetch&&t.shouldFetch(r)?X(t,r):g[e].change&&g[e].change.call(this,t,r),!0},unbindDataObject:function(e){return this._boundDataObjectsByCid[e.cid]?(delete this._boundDataObjectsByCid[e.cid],this.stopListening(e),delete this._objectOptionsByCid[e.cid],!0):!1},_modifyDataObjectOptions:function(e,t){return t}});var $="data-model-cid";t.Model=i.Model.extend({isEmpty:function(){return!this.isPopulated()},isPopulated:function(){var e=n.clone(this.attributes),t=m(this,"defaults")||{};for(var r in t){if(e[r]!=t[r])return!0;delete e[r]}var i=n.keys(e);return i.length>1||i.length===1&&i[0]!==this.idAttribute},shouldFetch:function(e){var t;try{t=m(this,"url")}catch(n){t=!1}return e.fetch&&!!t&&!this.isPopulated()}}),t.Models={},h(t.Model,t.Models),z("model",{set:"setModel",defaultOptions:{render:undefined,fetch:!0,success:!1,invalid:!0},change:J,$el:"$el",cidAttrName:$}),t.View.on({model:{invalid:function(e,t){this.getObjectOptions(e).invalid&&this.trigger("invalid",t,e)},error:function(e,t,n){this.trigger("error",t,e)},change:function(e,t){g.model.change.call(this,e,t)}}}),r.fn.model=function(e){var t=r(this),n=t.closest("["+$+"]"),i=n&&n.attr($);if(i){var e=e||t.view();if(e&&e.model&&e.model.cid===i)return e.model||!1;var s=t.collection(e);if(s)return s.get(i)}return!1};var K=i.Collection.prototype.fetch,Q=i.Collection.prototype.set,G=t.View.prototype._replaceHTML,Y="data-collection-cid",Z="data-collection-empty",et="data-collection-element",tt=1;t.Collection=i.Collection.extend({model:t.Model||i.Model,initialize:function(){return this.cid=n.uniqueId("collection"),i.Collection.prototype.initialize.apply(this,arguments)},isEmpty:function(){return this.length>0?!1:this.length===0&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!m(this,"url")},shouldFetch:function(e){return e.fetch&&!!m(this,"url")&&!this.isPopulated()},fetch:function(e){e=e||{};var t=e.success;return e.success=function(e,n){e._fetched=!0,t&&t(e,n)},K.apply(this,arguments)},set:function(e,t){return this._fetched=!!e,Q.call(this,e,t)}}),n.extend(t.View.prototype,{getCollectionViews:function(e){return n.filter(this.children,function(n){return n instanceof t.CollectionView?!e||n.collection===e:!1})},updateFilter:function(e){n.invoke(this.getCollectionViews(e),"updateFilter")}}),t.Collections={},h(t.Collection,t.Collections),z("collection",{set:"setCollection",bindCallback:rt,defaultOptions:{render:undefined,fetch:!0,success:!1,invalid:!0,change:!0},change:nt,$el:"getCollectionElement",cidAttrName:Y}),t.CollectionView=t.View.extend({_defaultTemplate:Handlebars.VM.noop,_collectionSelector:"["+et+"]",_replaceHTML:function(e){if(!(this.collection&&this.getObjectOptions(this.collection)&&this._renderCount))return G.call(this,e);var t,n=this.getCollectionElement();t=G.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)},render:function(){var e=this.shouldRender();t.View.prototype.render.apply(this,arguments),e||this.renderCollection()},appendItem:function(e,t,i){if(!e)return;var s,o=this.getCollectionElement(),u=this.collection;i=n.defaults(i||{},{filter:!0}),t&&t.el&&(t=o.children().indexOf(t.el)+1),e.el||n.isString(e)?(s=e,e=!1):(t=t||u.indexOf(e)||0,s=this.renderItem.call(this,e,t));if(s){s.cid&&(s.ensureRendered(),this._addChild(s)),n.isString(s)&&!s.match(/^\s*</m)&&(s="<div>"+s+"</div>");var a=s.$el||r(r.trim(s)).filter(function(){return this.nodeType===tt});e&&a.attr($,e.cid);var f=t>0?u.at(t-1):!1;if(!f)o.prepend(a);else{var l=o.children("["+$+'="'+f.cid+'"]').last();l.after(a)}this.trigger("append",null,function(t){t.setAttribute($,e.cid)}),i.silent||this.trigger("rendered:item",this,u,e,a,t),i.filter&&st.call(this,e)}return s},updateItem:function(e){var t=this.getCollectionElement(),n=t.find("["+$+'="'+e.cid+'"]');if(n.attr(o))return;this.removeItem(n),this.appendItem(e)},removeItem:function(e){var t=e;if(e.cid){var i=this.getCollectionElement();t=i.find("["+$+'="'+e.cid+'"]')}if(!t.length)return!1;var s=t.find("["+o+"]").map(function(e,t){return r(t).attr(o)});return t.remove(),s.push(t.attr(o)),n.each(s,function(e){var t=this.children[e];t&&this._removeChild(t)},this),!0},renderCollection:function(){this.collection?(this.collection.isEmpty()?at.call(this):(ut.call(this),this.collection.forEach(function(e,t){this.appendItem(e,t)},this)),this.trigger("rendered:collection",this,this.collection)):at.call(this)},emptyClass:"empty",renderEmpty:function(){this.emptyView||d.call(this,"emptyView",{extension:"-empty"}),!this.emptyTemplate&&!this.emptyView&&v.call(this,"emptyTemplate",{extension:"-empty",required:!1});if(this.emptyView){var e={};this.emptyTemplate&&(e.template=this.emptyTemplate);var n=t.Util.getViewInstance(this.emptyView,e);return n.ensureRendered(),n}return this.emptyTemplate&&this.renderTemplate(this.emptyTemplate)},renderItem:function(e,n){this.itemView||d.call(this,"itemView",{extension:"-item",required:!1}),!this.itemTemplate&&!this.itemView&&v.call(this,"itemTemplate",{extension:"-item",required:!this.itemView});if(this.itemView){var r={model:e};return this.itemTemplate&&(r.template=this.itemTemplate),t.Util.getViewInstance(this.itemView,r)}return this.renderTemplate(this.itemTemplate,this.itemContext.call(this,e,n))},itemContext:function(e){return e.attributes},appendEmpty:function(){var e=this.getCollectionElement();e.empty();var t=this.renderEmpty.call(this);t&&this.appendItem(t,0,{silent:!0,filter:!1}),this.trigger("rendered:empty",this,this.collection)},getCollectionElement:function(){var e=this.$(this._collectionSelector);return e.length===0?this.$el:e},updateFilter:function(){it.call(this)}}),t.CollectionView.on({collection:{reset:nt,sort:nt,change:function(e){var t=this.getObjectOptions(this.collection);t&&t.change&&this.updateItem(e),st.call(this,e)},add:function(e){var t=this.getCollectionElement();if(t.length){this.collection.length===1&&ut.call(this);var n=this.collection.indexOf(e);this.appendItem(e,n)}},remove:function(e){var t=this.getCollectionElement();this.removeItem(e),this.collection.length===0&&t.length&&at.call(this)}}}),t.View.on({collection:{invalid:function(e,t){this.getObjectOptions(e).invalid&&this.trigger("invalid",t,e)},error:function(e,t,n){this.trigger("error",t,e)}}}),r.fn.collection=function(e){if(e&&e.collection)return e.collection;var t=r(this),n=t.closest("["+Y+"]"),i=n&&n.attr(Y);if(i){e=t.view();if(e)return e.collection}return!1},g.model.defaultOptions.populate=!0;var ft=g.model.change;g.model.change=function(e,t){this._isChanging=!0,ft.apply(this,arguments),this._isChanging=!1;if(t&&t.serializing)return;var n=vt(this);this._renderCount&&n&&this.populate(!n.context&&this.model.attributes,n)},n.extend(t.View.prototype,{serialize:function(){var e,t,r;for(var i=0;i<arguments.length;++i)n.isFunction(arguments[i])?e=arguments[i]:n.isObject(arguments[i])&&("stopPropagation"in arguments[i]&&"preventDefault"in arguments[i]?r=arguments[i]:t=arguments[i]);if(r&&!this._preventDuplicateSubmission(r))return;t=n.extend({set:!0,validate:!0,children:!0},t||{});var s=t.attributes||{},o=this,u=[];ht(this,t,function(e){var r=o._getInputValue(e,t,u);n.isUndefined(r)||pt(s,e.name,{mode:"serialize"},function(e,t){e[t]?n.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:e[t]=r})}),t._silent||this.trigger("serialize",s,t);if(t.validate){var a=this.validateInput(s);a&&a.length&&(u=u.concat(a)),this.trigger("validate",s,u,t);if(u.length){this.trigger("invalid",u);return}}return t.set&&this.model&&!this.model.set(s,{silent:t.silent,serializing:!0})?!1:(e&&e.call(this,s,n.bind(dt,this)),s)},_preventDuplicateSubmission:function(e,t){e.preventDefault();var n=r(e.target);return(e.target.tagName||"").toLowerCase()!=="form"&&(n=r(e.target).closest("form")),n.attr("data-submit-wait")?!1:(n.attr("data-submit-wait","true"),t&&t.call(this,e),!0)},populate:function(e,t){t=n.extend({children:!0},t||{});var r,e=e||this._getContext();ht(this,t,function(t){pt(e,t.name,{mode:"populate"},function(e,i){r=e&&e[i];if(!n.isUndefined(r)){var s=t.type==="checkbox"||t.type==="radio";s&&n.isBoolean(r)?t.checked=r:s?t.checked=r==t.value:t.value=r}})}),++this._populateCount,t._silent||this.trigger("populate",e)},validateInput:function(){},_getInputValue:function(e){if(e.type!=="checkbox"&&e.type!=="radio"){if(e.multiple===!0){var t=[];return r("option",e).each(function(){this.selected&&t.push(this.value)}),t}return e.value}if(e.checked)return e.getAttribute("value")||!0},_populateCount:0}),t.View.on({"before:rendered":function(){if(!this._renderCount||(this.model&&this.model.cid)!==this._formModelCid)return;var e=this.getObjectOptions(this.model);this.previousFormData=lt(this.serialize(n.extend({set:!1,validate:!1,_silent:!0},e)),function(e){return e!==""&&e!=null})},rendered:function(){var e=vt(this);e&&!this._isChanging&&!this._populateCount&&this.populate(!e.context&&this.model.attributes,e),this.previousFormData&&this.populate(this.previousFormData,n.extend({_silent:!0},e)),this._formModelCid=this.model&&this.model.cid,this.previousFormData=null}}),t.View.on({invalid:ct,error:ct,deactivated:function(){this.$el&&dt.call(this)}});var mt="data-layout-cid";t.LayoutView=t.View.extend({_defaultTemplate:Handlebars.VM.noop,render:function(){var e=t.View.prototype.render.apply(this,arguments);return this.template===Handlebars.VM.noop?yt.call(this):bt.call(this),e},setView:function(e,r){r=n.extend({scroll:!0},r||{}),n.isString(e)&&(e=new(t.Util.registryGet(t,"Views",e,!1))),this.ensureRendered();var i=this._view,s,o,u;return e===i?!1:(this.trigger("change:view:start",e,i,r),o=n.bind(function(){i&&(i.$el&&i.$el.remove(),gt.call(i,"deactivated",r),this._removeChild(i))},this),s=n.bind(function(){if(e){e.ensureRendered(),gt.call(this,"activated",r),e.trigger("activated",r),this._view=e;var t=wt.call(this);this._view.appendTo(t),this._addChild(e)}else this._view=undefined},this),u=n.bind(function(){this.trigger("change:view:end",e,i,r)},this),r.transition?r.transition(e,i,s,o,u):(o(),s(),u()),e)},getView:function(){return this._view}}),Handlebars.registerHelper("layout-element",function(e){var n=T(e).view;if(!n.getView)throw new Error(c("layout-element-helper"));return e.hash[mt]=n.cid,N(e.hash),new Handlebars.SafeString(t.Util.tag.call(this,e.hash,"",this))}),t.CollectionHelperView=t.CollectionView.extend({events:{"rendered:item":Et("rendered:item"),"rendered:collection":Et("rendered:collection"),"rendered:empty":Et("rendered:empty")},getCollectionElement:function(){return this.$el},constructor:function(e){e.options["item-template"]&&(e.itemTemplate=t.Util.getTemplate(e.options["item-template"])),e.options["empty-template"]&&(e.emptyTemplate=t.Util.getTemplate(e.options["empty-template"])),!e.itemTemplate&&e.template&&e.template!==Handlebars.VM.noop&&(e.itemTemplate=e.template,e.template=Handlebars.VM.noop),!e.emptyTemplate&&e.inverse&&e.inverse!==Handlebars.VM.noop&&(e.emptyTemplate=e.inverse,e.inverse=Handlebars.VM.noop);var r=n.isFunction(e.itemContext),i=n.isFunction(e.itemFilter),s=t.HelperView.call(this,e);return r?this.itemContext=n.bind(this.itemContext,this.parent):n.isString(this.itemContext)&&(this.itemContext=n.bind(this.parent[this.itemContext],this.parent)),i?this.itemFilter=n.bind(this.itemFilter,this.parent):n.isString(this.itemFilter)&&(this.itemFilter=n.bind(this.parent[this.itemFilter],this.parent)),this.parent.name&&(!this.emptyView&&!this.parent.renderEmpty&&(this.emptyView=t.Util.getViewClass(this.parent.name+"-empty",!0)),!this.emptyTemplate&&!this.parent.renderEmpty&&(this.emptyTemplate=t.Util.getTemplate(this.parent.name+"-empty",!0)),!this.itemView&&!this.parent.renderItem&&(this.itemView=t.Util.getViewClass(this.parent.name+"-item",!0)),!this.itemTemplate&&!this.parent.renderItem&&(this.itemTemplate=t.Util.getTemplate(this.parent.name+"-item",!!this.itemView))),s},setAsPrimaryCollectionHelper:function(){n.each(St,function(e){xt.call(this,e)},this);var e=this;n.each(["itemFilter","itemContext","renderItem","renderEmpty"],function(t){e.parent[t]&&(e[t]=function(){return e.parent[t].apply(e.parent,arguments)})})}}),n.extend(t.CollectionHelperView.prototype,F),t.CollectionHelperView.attributeWhiteList={"item-context":"itemContext","item-filter":"itemFilter","item-template":"itemTemplate","empty-template":"emptyTemplate","item-view":"itemView","empty-view":"emptyView","empty-class":"emptyClass"};var St=["itemTemplate","itemView","emptyTemplate","emptyView"];Handlebars.registerViewHelper("collection",t.CollectionHelperView,function(e,t){arguments.length===1&&(t=e,e=t.parent.collection,e&&t.setAsPrimaryCollectionHelper(),t.$el.attr(et,"true"),t.listenTo(t.parent,"change:data-object",function(e,n){e==="collection"&&(t.setAsPrimaryCollectionHelper(),t.setCollection(n))})),e&&t.setCollection(e)}),Handlebars.registerHelper("collection-element",function(e){if(!T(e).view.renderCollection)throw new Error(c("collection-element-helper"));var n=e.hash;return N(n),n.tagName=n.tagName||"div",n[et]=!0,new Handlebars.SafeString(t.Util.tag.call(this,n,"",this))}),Handlebars.registerHelper("empty",function(e,t){arguments.length===1&&(t=e);var n=T(t).view;return arguments.length===1&&(e=n.model),n._emptyListeners||(n._emptyListeners={}),e&&!n._emptyListeners[e.cid]&&e.models&&"length"in e&&(n._emptyListeners[e.cid]=!0,n.listenTo(e,"remove",function(){e.length===0&&n.render()}),n.listenTo(e,"add",function(){e.length===1&&n.render()}),n.listenTo(e,"reset",function(){n.render()})),!e||e.isEmpty()?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("template",function(e,t){var r=n.extend({fn:t&&t.fn},this,t?t.hash:{}),i=T(t).view.renderTemplate(e,r);return new Handlebars.SafeString(i)}),Handlebars.registerHelper("yield",function(e){return T(e).yield&&e.data.yield()}),Handlebars.registerHelper("url",function(e){e=e||"";var r;if(arguments.length>2)r=n.map(n.head(arguments,arguments.length-1),encodeURIComponent).join("/");else{var s=arguments[1],o=s&&s.hash||s;o&&o["expand-tokens"]?r=t.Util.expandToken(e,this,!0):r=e}if(i.history._hasPushState){var u=i.history.options.root;return u==="/"&&r.substr(0,1)==="/"?r:u+r}return"#"+r}),Handlebars.registerViewHelper("view",{factory:function(e,n){var r=e.length>=1?e[0]:t.View;return t.Util.getViewInstance(r,n.options)},modifyHTMLAttributes:function(e,t){e.tagName=t.el.tagName.toLowerCase()},callback:function(e){var t=arguments[arguments.length-1],r=t._helperOptions.options,i=t.cid;if(!n.isString(e)&&r.hash&&n.keys(r.hash).length>0)throw new Error(c("view-helper-hash-args"));r.fn&&(j[i]=r.fn)}});var Tt="data-call-method",Nt="data-trigger-event";Handlebars.registerHelper("button",function(e,n){arguments.length===1&&(n=e,e=n.hash.method);var r=n.hash,i=r["expand-tokens"];delete r["expand-tokens"];if(!e&&!n.hash.trigger)throw new Error(c("button-trigger"));return N(r),r.tagName=r.tagName||"button",r.trigger&&(r[Nt]=r.trigger),delete r.trigger,e&&(r[Tt]=e),new Handlebars.SafeString(t.Util.tag(r,n.fn?n.fn(this):"",i?this:null))}),Handlebars.registerHelper("link",function(){var e=n.toArray(arguments),r=e.pop(),i=r.hash,s=e.length===0?[i.href]:e,o=i["expand-tokens"];delete i["expand-tokens"];if(!s[0]&&s[0]!=="")throw new Error(c("link-href"));return N(i),s.push(r),i.href=Handlebars.helpers.url.apply(this,s),i.tagName=i.tagName||"a",i.trigger&&(i[Nt]=r.hash.trigger),delete i.trigger,i[Tt]="_anchorClick",new Handlebars.SafeString(t.Util.tag(i,r.fn?r.fn(this):"",o?this:null))});var Ct="["+Tt+"], ["+Nt+"]",Lt;r(document).ready(function(){t._fastClickEventName||At()});var Mt="data-element-tmp";Handlebars.registerHelper("element",function(e,r){N(r.hash);var i=n.uniqueId("element"),s=T(r).view;return r.hash[Mt]=i,s._elementsByCid||(s._elementsByCid={}),s._elementsByCid[i]=e,new Handlebars.SafeString(t.Util.tag(r.hash))}),t.View.on("append",function(e,t){(e||this.$el).find("["+Mt+"]").forEach(function(e){var i=r(e),s=i.attr(Mt),o=this._elementsByCid[s];n.isFunction(o)&&(o=o.call(this)),i.replaceWith(o),t&&t(o)},this)}),Handlebars.registerHelper("super",function(e){var r=T(e).view,i=r.constructor&&r.constructor.__super__;if(i){var s=i.template;if(!s){if(!i.name)throw new Error(c("super-parent"));s=i.name}return n.isString(s)&&(s=t.Util.getTemplate(s,!1)),new Handlebars.SafeString(s(this,e))}return""});var _t="load:start",Dt="load:end",Pt;t.setRootObject=function(e){Pt=e},t.loadHandler=function(e,r,s){var o=n.uniqueId("load");return function(u,a,f){function h(){if(c.timeout&&!c.run)return;var n=l._loadingTimeoutDuration!==undefined?l._loadingTimeoutDuration:t.View.prototype._loadingTimeoutDuration;c.timeout=setTimeout(t.bindSection("load-start",function(){c.events.length&&(c.run=!0,e.call(l,c.message,c.background,c))}),n*1e3)}var l=s||this;l._loadInfo=l._loadInfo||{};var c=l._loadInfo[o];c?(clearTimeout(c.endTimeout),c.message=u,!a&&c.background&&(c.background=!1,h())):(c=l._loadInfo[o]=n.extend({isLoading:function(){return c.events.length},cid:o,events:[],timeout:0,message:u,background:!!a},i.Events),h());if(n.indexOf(c.events,f)>=0)return;c.events.push(f),f.on(Dt,function p(){var e=l._loadingTimeoutEndDuration;e===void 0&&(e=t.View.prototype._loadingTimeoutEndDuration);var i=c.events,s=n.indexOf(i,f);s>=0&&!f.isLoading()&&(i.splice(s,1),n.indexOf(i,f)<0&&f.off(Dt,p)),i.length||(clearTimeout(c.endTimeout),c.endTimeout=setTimeout(t.bindSection("load-end",function(){i.length||(c.run&&(r&&r.call(l,c.background,c),c.trigger(Dt,c)),clearTimeout(c.timeout),c=l._loadInfo[o]=undefined)}),e*1e3))})}},t.forwardLoadEvents=function(e,t,n){function r(i,s,o){n&&e.off(_t,r),t.trigger(_t,i,s,o)}return e.on(_t,r),{off:function(){e.off(_t,r)}}},t.mixinLoadable=function(e,t){n.extend(e,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(e,n,i){var s=t?this.parent:this;if(!s||!s.el)return;!s.nonBlockingLoad&&!n&&Pt&&Pt!==this&&Pt.trigger(_t,e,n,i),s._isLoading=!0,r(s.el).addClass(s._loadingClassName),s.trigger("change:load-state","start",n)},onLoadEnd:function(){var e=t?this.parent:this;if(!e||!e.el)return;e._isLoading=!1,r(e.el).removeClass(e._loadingClassName),e.trigger("change:load-state","end")}})},t.mixinLoadableEvents=function(e,t){n.extend(e,{_loadCount:0,isLoading:function(){return this._loadCount>0},loadStart:function(e,n){this._loadCount++;var r=t?this.parent:this;r.trigger(_t,e,n,r)},loadEnd:function(){this._loadCount--;var e=t?this.parent:this;e.trigger(Dt,e)}})},t.mixinLoadable(t.View.prototype),t.mixinLoadableEvents(t.View.prototype),t.HelperView&&(t.mixinLoadable(t.HelperView.prototype,!0),t.mixinLoadableEvents(t.HelperView.prototype,!0)),t.CollectionHelperView&&(t.mixinLoadable(t.CollectionHelperView.prototype,!0),t.mixinLoadableEvents(t.CollectionHelperView.prototype,!0)),t.sync=function(e,t,n){var r=this,s=n.complete;return n.complete=function(){r._request=undefined,r._aborted=!1,s&&s.apply(this,arguments)},this._request=i.sync.apply(this,arguments),this._request};var It=[];t.Model&&It.push(t.Model),t.Collection&&It.push(t.Collection),n.each(It,function(e){var r=e.prototype.fetch;t.mixinLoadableEvents(e.prototype,!1),n.extend(e.prototype,{sync:t.sync,fetch:function(i){i=i||{},e===t.Collection&&(n.find(["reset","remove","add","update"],function(e){return!n.isUndefined(i[e])})||(i.reset=!0));if(!i.loadTriggered){var s=this;function o(e){var t=i[e];i[e]=function(){s.loadEnd(),t&&t.apply(this,arguments)}}o("success"),o("error"),s.loadStart(undefined,i.background)}return jt.call(this,i||{},r)},load:function(e,r,i){arguments.length===2&&!n.isFunction(r)&&(i=r,r=!1),i=i||{},!i.background&&!this.isPopulated()&&Pt&&(this.isLoading()?Pt.trigger(_t,i.message,i.background,this):t.forwardLoadEvents(this,Pt,!0)),Bt.call(this,e,r,i)}})}),t.Util.bindToRoute=Ht,t.View.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.ignoreFetchError,t.background=this.nonBlockingLoad,t},t.HelperView.prototype._modifyDataObjectOptions=t.CollectionHelperView.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.parent.ignoreFetchError,t.background=this.parent.nonBlockingLoad,t},g.collection.loading=function(){var e=this.loadingView,r=this.loadingTemplate,i=this.loadingPlacement;if(e||r){var s=t.loadHandler(n.bind(function(){var n;this.collection.length===0&&this.$el.empty();if(e){var s=t.Util.getViewInstance(e);this._addChild(s),r?s.render(r):s.render(),n=s}else n=this.renderTemplate(r);var o=i?i.call(this):this.collection.length;this.appendItem(n,o),this.$el.children().eq(o).attr("data-loading-element",this.collection.cid)},this),n.bind(function(){this.$el.find('[data-loading-element="'+this.collection.cid+'"]').remove()},this),this.collection);this.listenTo(this.collection,"load:start",s)}},t.CollectionHelperView&&n.extend(t.CollectionHelperView.attributeWhiteList,{"loading-template":"loadingTemplate","loading-view":"loadingView","loading-placement":"loadingPlacement"}),t.View.on({"load:start":t.loadHandler(function(e,t,n){this.onLoadStart(e,t,n)},function(e,t){this.onLoadEnd(t)}),collection:{"load:start":function(e,t,n){this.trigger(_t,e,t,n)}},model:{"load:start":function(e,t,n){this.trigger(_t,e,t,n)}}}),Handlebars.registerHelper("loading",function(e){var t=T(e).view;return t.off("change:load-state",qt,t),t.on("change:load-state",qt,t),t._isLoading?e.fn(this):e.inverse(this)});var Rt=/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),Ut=!!navigator.userAgent.match(/Trident\/7\./);Rt&&t.View.on("before:append",function(){this._renderCount>0&&(n.each(this._elementsByCid,function(e){r(e).detach()}),n.each(this.children,function(e){e.$el.detach()}))});if(Rt||Ut)t.CollectionView.prototype._replaceHTML=function(e){if(!this.getObjectOptions(this.collection)||!this._renderCount)return G.call(this,e);var t,n=this.getCollectionElement().clone(!0,!0);t=G.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)},t.View.prototype._replaceHTML=function(e){while(this.el.hasChildNodes())this.el.removeChild(this.el.childNodes[0]);return this.$el.append(e)};return t});