// Copyright (c) 2011-2012 @WalmartLabs
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to
// deal in the Software without restriction, including without limitation the
// rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
// sell copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.
//

(function(){function f(e){while(e._helperName)e=e.parent;return e}function l(e){_.isArray(e)?this.mixin.apply(this,e):this.mixin(e)}function g(e,t){return function(n){var r=$(n.target).view({helper:!1});r&&r.cid==t&&e(n)}}function y(t,n){var r=typeof n=="function"?n:this[n];if(!r)throw new Error('Event "'+n+'" does not exist '+(this.name||this.cid)+":"+t);return _.bind(function(){try{r.apply(this,arguments)}catch(n){e.onException("thorax-exception: "+(this.name||this.cid)+":"+t,n)}},this)}function b(e,t,n){var r={originalName:e,handler:typeof t=="string"?this[t]:t};if(e.match(m)){var i=d.exec(e);r.name=i[1],r.type="DOM",r.selector=i[2]}else r.name=e,r.type="view";return r.context=n,r}function S(e,t){_.each(t,function(t,n){_.isArray(t)?t.forEach(function(t){e.push([n,t])},this):e.push([n,t])})}function x(e,t){return typeof e=="function"?e:t[e]}function T(e){e.forEach(function(e){this.model.on(e[0],x(e[1],this),e[2]||this)},this)}function N(e){e.forEach(function(e){this.model.off(e[0],x(e[1],this),e[2]||this)},this)}function D(e,t){t.forEach(function(t){this.on(e,t[0],function(){var e=_.toArray(arguments);return e.unshift(this),x(t[1],this.parent).apply(this.parent,e)},this)},this)}function P(){this.options.filter&&this.collection.forEach(function(e){H.call(this,e)},this)}function H(e){this.options.filter&&$("["+w+'="'+e.cid+'"]')[B.call(this,e)?"show":"hide"]()}function B(e,t){return(typeof this.options.filter=="string"?this.parent[this.options.filter]:this.options.filter).call(this.parent,e,this.collection.indexOf(e))}function j(){this.collection.length===1&&this.$el.length&&(this.$el.removeAttr(O),this.$el.empty())}function F(){this.collection.length===0&&this.$el.length&&(this.$el.attr(O,!0),this.appendEmpty())}function R(e,t,n){var r=0;this.$("select,input,textarea",e.root||this.el).each(function(){this.type!=="button"&&this.type!=="cancel"&&this.type!=="submit"&&this.name&&this.name!==""&&(t.call(n||this,r,this),++r)})}function U(e,t,n,r){var i,s,o=e,u=t.split("["),a=n.mode;for(s=0;s<u.length-1;++s){i=u[s].replace("]","");if(!o[i]){if(a!="serialize")return r.call(this,!1,i);o[i]={}}o=o[i]}i=u[u.length-1].replace("]",""),r.call(this,o,i)}function z(){this.$("form").removeAttr("data-submit-wait")}function W(){Backbone.history||(Backbone.history=new Backbone.History),Backbone.history.on("route",X,this),this.on("destroyed",function(){Backbone.history.off("route",X,this)})}function X(e,t){this===e&&this.trigger.apply(this,["route"].concat(Array.prototype.slice.call(arguments,1)))}function J(){++this._renderCount,this.$el.attr(V,this.cid)}function K(){if(!this.$("["+V+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function Q(){return this.$("["+V+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function et(e,t){function i(i){var o=n===Backbone.history.getFragment();if(r)return;if(i&&o)return;r=!0,Backbone.history.off("route",s);var u=Array.prototype.slice.call(arguments,1);!i&&o?e.apply(this,u):t&&t.apply(this,u)}var n=Backbone.history.getFragment(),r,s=_.bind(i,this,!0);return Backbone.history.on("route",s),_.bind(i,this,!1)}function tt(e,t,n){if(this.isPopulated())return e(this);arguments.length===2&&typeof t!="function"&&_.isObject(t)&&(n=t,t=!1),this.fetch(_.defaults({success:et(e,t&&_.bind(t,this,!1)),error:t&&_.bind(t,this,!0)},n))}function nt(e,t){e.resetQueue&&(this.fetchQueue=undefined),this.fetchQueue?this.fetchQueue.push(e):(this.fetchQueue=[e],e=_.defaults({success:rt(this,this.fetchQueue,"success"),error:rt(this,this.fetchQueue,"error"),complete:rt(this,this.fetchQueue,"complete")},e),t.call(this,e))}function rt(e,t,n){return function(){var r=arguments;t.forEach(function(e){e[n]&&e[n].apply(this,r)},this),e.fetchQueue===t&&(e.fetchQueue=undefined)}}var e;$.fn.forEach||($.fn.forEach=function(e,t){$.fn.each.call(this,function(n){e.call(t||this,this,n)})}),typeof exports!="undefined"?e=exports:e=this.Thorax={},e.VERSION="2.0.0b3";var t="handlebars",n=new RegExp("\\."+t+"$"),r="data-view-name",i="data-view-cid",s="data-view-tmp",o="data-view-helper",u="data-element-tmp";_.extend(e,{templatePathPrefix:"",_viewsIndexedByCid:{},templates:{},Views:{},onException:function(e,t){throw t}}),e.Util={createRegistryWrapper:function(e,t){var n=e.extend;e.extend=function(){var e=n.apply(this,arguments);return e.prototype.name&&(t[e.prototype.name]=e),e}},registryGet:function(t,n,r,i){if(n==="templates"){var s=e.templatePathPrefix;s&&s.length&&r&&r.substr(0,s.length)!==s&&(r=s+r)}var o=t[n],u;if(r.match(/\./)){var a=r.split(/\./);r=a.pop(),a.forEach(function(e){o=o[e]})}else u=o[r];if(!o&&!i)throw new Error(n+": "+r+" does not exist.");var u=o[r];return n==="templates"&&typeof u=="string"&&(u=o[r]=Handlebars.compile(u)),u},getViewInstance:function(t,n){n["class"]&&(n.className=n["class"]),n.tag&&(n.tagName=n.tag);if(typeof t=="string"){var r=e.Util.registryGet(e,"Views",t,!1);return r.cid?_.extend(r,n||{}):new r(n)}return typeof t=="function"?new t(n):t},getValue:function(e,t){return!e||!e[t]?null:_.isFunction(e[t])?e[t].apply(e,Array.prototype.slice.call(arguments,2)):e[t]},is$:function(e){return typeof e=="object"&&"length"in e},expandToken:function(e,t){if(e&&e.indexOf&&e.indexOf("{{")>=0){var n=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,r,i=[];function s(e,t){var n=e.split("."),r=n.length;for(var i=0;t&&i<r;i++)n[i]!=="this"&&(t=t[n[i]]);return t}while(r=n.exec(e))if(r[1]){var o=r[1].split(/\s+/);if(o.length>1){var u=o.shift();o=o.map(function(e){return s(e,t)}),Handlebars.helpers[u]?i.push(Handlebars.helpers[u].apply(t,o)):i.push(r[0])}else i.push(s(o[0],t))}else i.push(r[0]);e=i.join("")}return e},tag:function(t,n,r){var i=_.clone(t),s=i.tag||i.tagName||"div";return i.tag&&delete i.tag,i.tagName&&delete i.tagName,"<"+s+" "+_.map(i,function(t,n){if(typeof t=="undefined")return"";var i=t;return r&&(i=e.Util.expandToken(t,r)),n+'="'+Handlebars.Utils.escapeExpression(i)+'"'}).join(" ")+">"+(typeof n=="undefined"?"":n)+"</"+s+">"},htmlAttributesFromOptions:function(e){var t={};return e.tag&&(t.tag=e.tag),e.tagName&&(t.tagName=e.tagName),e["class"]&&(t["class"]=e["class"]),e.id&&(t.id=e.id),t},_cloneEvents:function(e,t,n){e[n]=_.clone(t[n]),_.each(e[n],function(e,r){_.isArray(e)&&(t[n][r]=_.clone(e))})}},e.View=Backbone.View.extend({constructor:function(){var t=e.View.__super__.constructor.apply(this,arguments);if(this.model){var n=this.model;this.model=null,this.setModel(n)}return t},_configure:function(t){this._modelEvents=[],this._collectionEvents=[],e._viewsIndexedByCid[this.cid]=this,this.children={},this._renderCount=0,_.extend(this,t||{}),typeof this.template=="string"?this.template=Handlebars.compile(this.template):this.name&&!this.template&&(this.template=e.Util.registryGet(e,"templates",this.name,!0)),this.constructor.mixins&&_.each(this.constructor.mixins,l,this),this.mixins&&_.each(this.mixins,l,this),this.constructor._events&&this.constructor._events.forEach(function(e){this.on.apply(this,e)},this),this.events&&_.each(e.Util.getValue(this,"events"),function(e,t){this.on(t,e,this)},this)},_ensureElement:function(){Backbone.View.prototype._ensureElement.call(this),this.name&&this.$el.attr(r,this.name),this.$el.attr(i,this.cid)},_addChild:function(e){return this.children[e.cid]=e,e.parent||(e.parent=this),e},destroy:function(t){t=_.defaults(t||{},{children:!0}),this.trigger("destroyed"),delete e._viewsIndexedByCid[this.cid],_.each(this.children,function(e){t.children&&(e.parent=null,e.destroy())}),t.children&&(this.children={})},render:function(t){if(typeof t=="undefined"||!_.isElement(t)&&!e.Util.is$(t)&&(!t||!t.el)&&typeof t!="string"&&typeof t!="function"){if(!this.template){this.name&&(this.template=e.Util.registryGet(e,"templates",this.name,!0));if(!this.template)throw new Error("View "+(this.name||this.cid)+".render() was called with no content and no template set on the view.")}t=this.renderTemplate(this.template)}else typeof t=="function"&&(t=this.renderTemplate(t));return this.html(t&&t.el||t&&t.string||t),++this._renderCount,this.trigger("rendered"),t},context:function(){return this},_getContext:function(t){var n=_.extend({},e.Util.getValue(this,"context"),t||{},{cid:_.uniqueId("t"),yield:function(){return n.fn&&n.fn(n)},_view:this});return n},renderTemplate:function(e,t,n){var r;t=this._getContext(t),typeof e=="function"?r=e:r=this._loadTemplate(e);if(!r){if(n)return"";throw new Error("Unable to find template "+e)}return r(t)},_loadTemplate:function(t,n){return e.Util.registryGet(e,"templates",t,n)},ensureRendered:function(){!this._renderCount&&this.render()},html:function(e){if(typeof e=="undefined")return this.el.innerHTML;var t=this.$el.html(e);return this._appendViews(),this._appendElements(),t}}),e.View.extend=function(){var t=Backbone.View.extend.apply(this,arguments);return t.mixins=_.clone(this.mixins),e.Util._cloneEvents(this,t,"_events"),e.Util._cloneEvents(this,t,"_modelEvents"),e.Util._cloneEvents(this,t,"_collectionEvents"),t},e.Util.createRegistryWrapper(e.View,e.Views),Handlebars.registerHelper("super",function(){var t=this._view.constructor&&this._view.constructor.__super__;if(t){var n=t.template;if(!n){if(!t.name)throw new Error("Cannot use super helper when parent has no name or template.");n=e.Util.registryGet(e,"templates",t.name,!1)}return typeof n=="string"&&(n=Handlebars.compile(n)),new Handlebars.SafeString(n(this))}return""}),Handlebars.registerHelper("template",function(t,n){var r=_.extend({fn:n&&n.fn},this,n?n.hash:{}),i=e.View.prototype.renderTemplate.call(this._view,t,r);return new Handlebars.SafeString(i)});var a={};Handlebars.registerHelper("view",function(t,n){arguments.length===1&&(n=t,t=e.View);var r=e.Util.getViewInstance(t,n?n.hash:{}),i=r.cid+"-"+_.uniqueId("placeholder");this._view._addChild(r),this._view.trigger("child",r),n.fn&&(a[i]=n.fn);var o=e.Util.htmlAttributesFromOptions(n.hash);return o[s]=i,new Handlebars.SafeString(e.Util.tag.call(this,o))}),e.HelperView=e.View.extend({_ensureElement:function(){e.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(o,this._helperName)},context:function(){return this.parent.context.apply(this.parent,arguments)}}),Handlebars.registerViewHelper=function(t,n,r){arguments.length===2&&(options={},r=arguments[1],n=e.HelperView),Handlebars.registerHelper(t,function(){var i=_.toArray(arguments),o=i.pop(),u={template:o.fn,inverse:o.inverse,options:o.hash,parent:f(this._view),_helperName:t};o.hash.id&&(u.id=o.hash.id),o.hash["class"]&&(u.className=o.hash["class"]),o.hash.className&&(u.className=o.hash.className),o.hash.tag&&(u.tagName=o.hash.tag),o.hash.tagName&&(u.tagName=o.hash.tagName);var a=new n(u);i.push(a),this._view.children[a.cid]=a,this._view.trigger.apply(this._view,["helper",t].concat(i)),this._view.trigger.apply(this._view,["helper:"+t].concat(i));var l=e.Util.htmlAttributesFromOptions(o.hash);return l[s]=a.cid,r.apply(this,i),new Handlebars.SafeString(e.Util.tag(l,""))});var i=Handlebars.helpers[t];return i},e.View.prototype._appendViews=function(e,t){(e||this.$el).find("["+s+"]").forEach(function(e){var n=e.getAttribute(s),r=n.replace(/\-placeholder\d+$/,""),i=this.children[r];_.isFunction(i)&&(i=i.call(this._view)),i&&(a[n]?i.render(a[n](i._getContext())):i.ensureRendered(),$(e).replaceWith(i.el),typeof jQuery!="undefined"&&$===jQuery&&this._renderCount>1&&i.delegateEvents(),t&&t(i.el))},this)},Handlebars.registerHelper("element",function(t,n){var r=_.uniqueId("element"),i=e.Util.htmlAttributesFromOptions(n.hash);return i[u]=r,this._view._elementsByCid||(this._view._elementsByCid={}),this._view._elementsByCid[r]=t,new Handlebars.SafeString(e.Util.tag.call(this,i))}),e.View.prototype._appendElements=function(e,t){(e||this.$el).find("["+u+"]").forEach(function(e){var n=e.getAttribute(u),r=this._elementsByCid[n];_.isFunction(r)&&(r=r.call(this._view)),$(e).replaceWith(r),t&&t(r)},this)},$.fn.view=function(t){t=_.defaults(t||{},{helper:!0});var n="["+i+"]";t.helper||(n+=":not(["+o+"])");var r=$(this).closest(n);return r&&e._viewsIndexedByCid[r.attr(i)]||!1},_.extend(e.View,{mixins:[],mixin:function(e){this.mixins.push(e)}});var c=e.View.prototype.destroy,h=e.View.prototype.on,p=e.View.prototype.delegateEvents;_.extend(e.View,{_events:[],on:function(e,t){return e==="model"&&typeof t=="object"?S(this._modelEvents,t):e==="collection"&&typeof t=="object"?S(this._collectionEvents,t):(typeof e=="object"?_.each(e,function(e,t){this.on(t,e)},this):_.isArray(t)?t.forEach(function(t){this._events.push([e,t])},this):this._events.push([e,t]),this)}}),_.extend(e.View.prototype,{freeze:function(e){this.model&&this._unbindModelEvents(),e=_.defaults(e||{},{dom:!0,children:!0}),this._eventArgumentsToUnbind&&this._eventArgumentsToUnbind.forEach(function(e){e[0].off(e[1],e[2],e[3])}),this._eventArgumentsToUnbind=[],this.off(),e.dom&&this.undelegateEvents(),this.trigger("freeze"),e.children&&_.each(this.children,function(t,n){t.freeze(e)},this)},destroy:function(){var e=c.apply(this,arguments);return this.freeze(),e},on:function(e,t,n){if(e==="model"&&typeof t=="object")return S(this._modelEvents,t);if(e==="collection"&&typeof t=="object")return S(this._collectionEvents,t);if(typeof e=="object"){if(arguments.length===1)_.each(e,function(e,t){this.on(t,e,this)},this);else if(arguments.length>1){this._eventArgumentsToUnbind||(this._eventArgumentsToUnbind=[]);var r=Array.prototype.slice.call(arguments);this._eventArgumentsToUnbind.push(r),r[0].on.apply(r[0],r.slice(1))}}else(_.isArray(t)?t:[t]).forEach(function(t){var r=b.call(this,e,t,n||this);r.type==="DOM"?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(r)):this._addEvent(r)},this);return this},delegateEvents:function(e){this.undelegateEvents(),e&&(_.isFunction(e)&&(e=e.call(this)),this._eventsToDelegate=[],this.on(e)),this._eventsToDelegate&&this._eventsToDelegate.forEach(this._addEvent,this)},_addEvent:function(e){if(e.type==="view")e.name.split(/\s+/).forEach(function(t){h.call(this,t,y.call(this,"view-event:"+e.name,e.handler),e.context||this)},this);else{var t=g(y.call(this,"dom-event:"+e.name,e.handler),this.cid);if(e.selector){var n=e.name+".delegateEvents"+this.cid;typeof jQuery!="undefined"&&$===jQuery?_.defer(_.bind(function(){this.$el.on(n,e.selector,t)},this)):this.$el.on(n,e.selector,t)}else this.$el.on(n,t)}}});var d=/^(\S+)(?:\s+(.+))?/,v=["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","focus","blur"],m=new RegExp("^("+v.join("|")+")"),w="data-model-cid",E="data-model-name";e.Model=Backbone.Model.extend({isEmpty:function(){return this.isPopulated()},isPopulated:function(){var e=_.clone(this.attributes),t=_.isFunction(this.defaults)?this.defaults():this.defaults||{};for(var n in t){if(e[n]!=t[n])return!0;delete e[n]}var r=_.keys(e);return r.length>1||r.length===1&&r[0]!=="id"}}),e.Models={},e.Util.createRegistryWrapper(e.Model,e.Models),e.View._modelEvents=[],_.extend(e.View.prototype,{context:function(){return _.extend({},this,this.model&&this.model.attributes||{})},_bindModelEvents:function(){T.call(this,this.constructor._modelEvents),T.call(this,this._modelEvents)},_unbindModelEvents:function(){this.model.trigger("freeze"),N.call(this,this.constructor._modelEvents),N.call(this,this._modelEvents)},setModel:function(t,n){var r=this.model;if(t===r)return this;r&&this._unbindModelEvents();if(t){this.$el.attr(w,t.cid),t.name&&this.$el.attr(E,t.name),this.model=t,this._setModelOptions(n),this._bindModelEvents(n),this.model.trigger("set",this.model,r);if(e.Util.shouldFetch(this.model,this._modelOptions)){var i=this._modelOptions.success;this._loadModel(this.model,this._modelOptions)}else this._onModelChange()}else this._modelOptions=!1,this.model=!1,this._onModelChange(),this.$el.removeAttr(w),this.$el.attr(E);return this},_onModelChange:function(){(!this._modelOptions||this._modelOptions&&this._modelOptions.render)&&this.render()},_loadModel:function(e,t){e.fetch(t)},_setModelOptions:function(e){return this._modelOptions||(this._modelOptions={fetch:!0,success:!1,render:!0,errors:!0}),_.extend(this._modelOptions,e||{}),this._modelOptions}}),e.View.on({model:{error:function(e,t){this._modelOptions.errors&&this.trigger("error",t)},change:function(){this._onModelChange()}}}),e.Util.shouldFetch=function(t,n){var r=e.Util.getValue,i=!t.collection&&t._byCid&&t._byId;return url=!t.collection&&r(t,"urlRoot")||t.collection&&r(t.collection,"url")||i&&r(t,"url"),url&&n.fetch&&!(t.isPopulated&&t.isPopulated()||(i?e.Collection&&e.Collection.prototype.isPopulated.call(t):e.Model.prototype.isPopulated.call(t)))},$.fn.model=function(){var e=$(this),t=e.closest("["+w+"]"),n=t&&t.attr(w);if(n){var r=e.view();if(r&&r.model&&r.model.cid===n)return r.model||!1;var i=e.collection(r);if(i)return i._byCid[n]||!1}return!1};var C=Backbone.Collection.prototype.fetch,k=Backbone.Collection.prototype.reset,L="data-collection-cid",A="data-collection-name",O="data-collection-empty",w="data-model-cid",E="data-model-name",M=1;e.Collection=Backbone.Collection.extend({model:e.Model||Backbone.Model,isEmpty:function(){return this.length>0?!1:this.length===0&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!e.Util.getValue(this,"url")},fetch:function(e){e=e||{};var t=e.success;return e.success=function(e,n){e._fetched=!0,t&&t(e,n)},C.apply(this,arguments)},reset:function(e,t){return this._fetched=!!e,k.call(this,e,t)}}),e.Collections={},e.Util.createRegistryWrapper(e.Collection,e.Collections),e.View._collectionEvents=[],e.CollectionView=e.HelperView.extend({constructor:function(t){e.CollectionView.__super__.constructor.call(this,t),this.options||(this.options={}),this.collection&&this.setCollection(this.collection),e.CollectionView._optionNames.forEach(function(e){t[e]&&(this.options[e]=t[e])},this)},_setCollectionOptions:function(e,t){return _.extend({fetch:!0,success:!1,errors:!0},t||{})},setCollection:function(t,n){return this.collection=t,t&&(t.cid=t.cid||_.uniqueId("collection"),this.$el.attr(L,t.cid),t.name&&this.$el.attr(A,t.name),this.options=this._setCollectionOptions(t,_.extend({},this.options,n)),D.call(this,t,this.parent._collectionEvents),D.call(this,t,this.parent.constructor._collectionEvents),t.trigger("set",t),e.Util.shouldFetch(t,this.options)?this._loadCollection(t):this.reset()),this},_loadCollection:function(e){e.fetch(this.options)},appendItem:function(e,t,n){if(!e)return;var r;n=n||{},t&&t.el&&(t=this.$el.children().indexOf(t.el)+1),e.el||typeof e=="string"?(r=e,e=!1):(t=t||this.collection.indexOf(e)||0,r=this.renderItem(e,t));if(r){r.cid&&this._addChild(r),typeof r=="string"&&!r.match(/^\s*\</m)&&(r="<div>"+r+"</div>");var i=r.el?[r.el]:_.filter($(r),function(e){return e.nodeType===M});e&&$(i).attr(w,e.cid);var s=t>0?this.collection.at(t-1):!1;if(!s)this.$el.prepend(i);else{var o=this.$el.find("["+w+'="'+s.cid+'"]').last();o.after(i)}this._appendViews(null,function(t){t.setAttribute(w,e.cid)}),this._appendElements(null,function(t){t.setAttribute(w,e.cid)}),n.silent||this.parent.trigger("rendered:item",this,this.collection,e,i,t),H.call(this,e)}return r},updateItem:function(e){this.removeItem(e),this.appendItem(e)},removeItem:function(e){var t=this.$("["+w+'="'+e.cid+'"]');if(!t.length)return!1;var n=t.attr(i);return this.children[n]&&delete this.children[n],t.remove(),!0},reset:function(){this.render()},render:function(){this.$el.empty(),this.collection&&(this.collection.isEmpty()?(this.$el.attr(O,!0),this.appendEmpty()):(this.$el.removeAttr(O),this.collection.forEach(function(e,t){this.appendItem(e,t)},this)),this.parent.trigger("rendered:collection",this,this.collection),P.call(this)),++this._renderCount},renderEmpty:function(){var t={};if(this.options["empty-view"]){this.options["empty-context"]&&(t.context=_.bind(function(){return(_.isFunction(this.options["empty-context"])?this.options["empty-context"]:this.parent[this.options["empty-context"]]).call(this.parent)},this));var n=e.Util.getViewInstance(this.options["empty-view"],t);return this.options["empty-template"]?n.render(this.renderTemplate(this.options["empty-template"],t.context?t.context():{})):n.render(),n}var r=this.options["empty-template"]||this.parent.name&&this._loadTemplate(this.parent.name+"-empty",!0),i;return this.options["empty-context"]?i=(_.isFunction(this.options["empty-context"])?this.options["empty-context"]:this.parent[this.options["empty-context"]]).call(this.parent):i={},r&&this.renderTemplate(r,i)},renderItem:function(t,n){if(this.options["item-view"]){var r={model:t};this.options["item-context"]&&(r.context=_.bind(function(){return(_.isFunction(this.options["item-context"])?this.options["item-context"]:this.parent[this.options["item-context"]]).call(this.parent,t,n)},this)),this.options["item-template"]&&(r.template=this.options["item-template"]);var i=e.Util.getViewInstance(this.options["item-view"],r);return i.ensureRendered(),i}var s=this.options["item-template"]||this.parent.name&&this.parent._loadTemplate(this.parent.name+"-item",!0);if(!s)throw new Error("collection helper in View: "+(this.parent.name||this.parent.cid)+" requires an item template.");var o;return this.options["item-context"]?o=(_.isFunction(this.options["item-context"])?this.options["item-context"]:this.parent[this.options["item-context"]]).call(this.parent,t,n):o=t.attributes,this.renderTemplate(s,o)},appendEmpty:function(){this.$el.empty();var e=this.renderEmpty();e&&this.appendItem(e,0,{silent:!0}),this.parent.trigger("rendered:empty",this,this.collection)}}),e.CollectionView._optionNames=["item-template","empty-template","item-view","empty-view","item-context","empty-context","filter"],e.View.on({collection:{filter:function(e){P.call(e)},change:function(e,t){e.options["item-view"]||e.updateItem(t),H.call(e,t)},add:function(e,t,n){j.call(e);if(e.$el.length){var r=n.indexOf(t);e.appendItem(t,r)}},remove:function(e,t,n){e.$el.find("["+w+'="'+t.cid+'"]').remove();for(var r in e.children)if(e.children[r].model&&e.children[r].model.cid===t.cid){e.children[r].destroy(),delete e.children[r];break}F.call(e)},reset:function(e,t){e.reset()},error:function(e,t){e.options.errors&&(e.trigger("error",t),this.trigger("error",t))}}}),Handlebars.registerViewHelper("collection",e.CollectionView,function(e,t){arguments.length===1&&(t=e,e=this._view.collection),e&&(_.extend(t.options,{"item-template":t.template&&t.template!==Handlebars.VM.noop?t.template:t.options["item-template"],"empty-template":t.inverse&&t.inverse!==Handlebars.VM.noop?t.inverse:t.options["empty-template"],"item-context":t.options["item-context"]||t.parent.itemContext,"empty-context":t.options["empty-context"]||t.parent.emptyContext,filter:t.options.filter}),t.setCollection(e))}),Handlebars.registerViewHelper("empty",function(e,t){var n,r;arguments.length===1&&(t=e,e=!1,r=!0);var i=t.render;t.render=function(){return r?n=!this.parent.model||this.parent.model&&!this.parent.model.isEmpty():e?n=e.isEmpty():n=!0,n?(this.parent.trigger("rendered:empty",this,e),i.call(this,this.template)):i.call(this,this.inverse)};if(e){function s(){e.length===0&&t.render()}function o(){e.length===1&&t.render()}function u(){t.render()}t.on(e,"remove",s),t.on(e,"add",o),t.on(e,"reset",u)}t.render()}),$.fn.collection=function(e){var t=$(this),n=t.closest("["+L+"]"),r=n&&n.attr(L);if(r){e=e||t.view();if(e)return e.collection}return!1};var I=/:(\w+)/g,q="data-call-method";Handlebars.registerHelper("url",function(t){var n=t.match(I),r=this;return n&&(t=t.replace(I,function(t,n){return r[n]?e.Util.getValue(r,n):t})),t=e.Util.expandToken(t,r),(Backbone.history._hasPushState?Backbone.history.options.root:"#")+t}),Handlebars.registerHelper("button",function(t,n){return n.hash.tag=n.hash.tag||n.hash.tagName||"button",n.hash[q]=t,new Handlebars.SafeString(e.Util.tag.call(this,n.hash,n.fn?n.fn(this):"",this))}),Handlebars.registerHelper("link",function(t,n){return n.hash.tag=n.hash.tag||n.hash.tagName||"a",n.hash.href=Handlebars.helpers.url.call(this,t),n.hash[q]="_anchorClick",new Handlebars.SafeString(e.Util.tag.call(this,n.hash,n.fn?n.fn(this):"",this))}),$(function(){$(document).on("click","["+q+"]",function(e){var t=$(e.target),n=t.view({helper:!1}),r=t.attr(q);n[r].call(n,e)})}),e.View.prototype._anchorClick=function(e){var t=$(e.currentTarget),n=t.attr("href");n&&(n[0]==="#"||n[0]==="/"&&n[1]!=="/")&&(Backbone.history.navigate(n,{trigger:!0}),e.preventDefault())},e.View.prototype._setModelOptions&&function(){var t=e.View.prototype._onModelChange,n=e.View.prototype._setModelOptions;_.extend(e.View.prototype,{_onModelChange:function(){var e=t.call(this);return this._modelOptions.populate&&this.populate(this.model.attributes),e},_setModelOptions:function(e){return e||(e={}),"populate"in e||(e.populate=!0),n.call(this,e)}})}(),_.extend(e.View.prototype,{serialize:function(){var e,t,n;for(var r=0;r<arguments.length;++r)typeof arguments[r]=="function"?e=arguments[r]:typeof arguments[r]=="object"&&("stopPropagation"in arguments[r]&&"preventDefault"in arguments[r]?n=arguments[r]:t=arguments[r]);if(n&&!this._preventDuplicateSubmission(n))return;t=_.extend({set:!0,validate:!0},t||{});var i=t.attributes||{},s=this,o=[];R.call(this,t,function(){var e=s._getInputValue(this,t,o);typeof e!="undefined"&&U.call(this,i,this.name,{mode:"serialize"},function(t,n){t[n]?_.isArray(t[n])?t[n].push(e):t[n]=[t[n],e]:t[n]=e})}),this.trigger("serialize",i,t);if(t.validate){var u=this.validateInput(i);u&&u.length&&(o=o.concat(u)),this.trigger("validate",i,o,t);if(o.length){this.trigger("error",o);return}}return t.set&&this.model&&!this.model.set(i,{silent:!0})?!1:(e&&e.call(this,i,_.bind(z,this)),i)},_preventDuplicateSubmission:function(e,t){e.preventDefault();var n=$(e.target);return(e.target.tagName||"").toLowerCase()!=="form"&&(n=$(e.target).closest("form")),n.attr("data-submit-wait")?!1:(n.attr("data-submit-wait","true"),t&&t.call(this,e),!0)},populate:function(e){var t,e=e||this._getContext(this.model);R.call(this,{},function(){U.call(this,e,this.name,{mode:"populate"},function(e,n){e&&typeof (t=e[n])!="undefined"&&(this.type==="checkbox"&&_.isBoolean(t)?this.checked=t:this.type==="checkbox"||this.type==="radio"?this.checked=t==this.value:this.value=t)})}),this.trigger("populate",e)},validateInput:function(e,t,n){},_getInputValue:function(e,t,n){if(e.type!=="checkbox"&&e.type!=="radio"){if(e.multiple===!0){var r=[];return $("option",e).each(function(){this.selected&&r.push(this.value)}),r}return e.value}if(e.checked)return e.value}}),e.View.on({error:function(){z.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})},deactivated:function(){z.call(this)}}),e.Router=Backbone.Router.extend({constructor:function(){var t=e.Router.__super__.constructor.apply(this,arguments);return W.call(this),t},route:function(e,t,n){return Backbone.Router.prototype.route.call(this,e,t,function(){return this.trigger.apply(this,["route:before",t].concat(Array.prototype.slice.call(arguments))),n.apply(this,arguments)})}}),e.Routers={},e.Util.createRegistryWrapper(e.Router,e.Routers);var V="data-layout-cid";e.LayoutView=e.View.extend({render:function(t){var n;this.name&&(n=e.Util.registryGet(e,"templates",this.name,!0));if(t||this.template||n){var r=e.View.prototype.render.call(this,t||this.template||n);return K.call(this),r}J.call(this)},setView:function(t,n){n=_.extend({scroll:!0,destroy:!0},n||{}),typeof t=="string"&&(t=new(e.Util.registryGet(e,"Views",t,!1))),this.ensureRendered();var r=this._view;return t==r?!1:(n.destroy&&t&&(t._shouldDestroyOnNextSetView=!0),this.trigger("change:view:start",t,r,n),r&&r.trigger("deactivated",n),t&&t.trigger("activated",n),r&&r.el&&r.el.parentNode&&r.$el.remove(),t&&this._addChild(t),t&&t.ensureRendered(),t&&Q.call(this).appendChild(t.el),this._view=t,r&&delete this.children[r.cid],r&&r._shouldDestroyOnNextSetView&&r.destroy(),this._view&&this._view.trigger("ready",n),this.trigger("change:view:end",t,r,n),t)},getView:function(){return this._view}}),Handlebars.registerHelper("layout",function(t){return t.hash[V]=this._view.cid,new Handlebars.SafeString(e.Util.tag.call(this,t.hash,"",this))}),e.ViewController=e.LayoutView.extend({constructor:function(){var t=e.ViewController.__super__.constructor.apply(this,arguments);return this._bindRoutes(),W.call(this),this.on("route:before",function(e,t){this.parent&&this.parent.getView&&this.parent.getView()!==this&&this.parent.setView(this,{destroy:!1})},this),t}}),_.extend(e.ViewController.prototype,e.Router.prototype);var G="load:start",Y="load:end",Z;e.setRootObject=function(e){Z=e},e.loadHandler=function(t,n){return function(r,i,s){function u(){clearTimeout(o._loadStart.timeout),o._loadStart.timeout=setTimeout(function(){try{o._loadStart.run=!0,t.call(o,o._loadStart.message,o._loadStart.background,o._loadStart)}catch(n){e.onException("loadStart",n)}},a*1e3)}var o=this;if(!o._loadStart){var a=o._loadingTimeoutDuration;a===void 0&&(a=e.View.prototype._loadingTimeoutDuration),o._loadStart=_.extend({events:[],timeout:0,message:r,background:!!i},Backbone.Events),u()}else clearTimeout(o._loadStart.endTimeout),o._loadStart.message=r,!i&&o._loadStart.background&&(o._loadStart.background=!1,u());o._loadStart.events.push(s),s.bind(Y,function f(){s.off(Y,f);var t=o._loadingTimeoutEndDuration;t===void 0&&(t=e.View.prototype._loadingTimeoutEndDuration);var r=o._loadStart.events,i=r.indexOf(s);i>=0&&r.splice(i,1),r.length||(o._loadStart.endTimeout=setTimeout(function(){try{if(!r.length){var t=o._loadStart.run;t&&(n.call(o,o._loadStart.background,o._loadStart),o._loadStart.trigger(Y,o._loadStart)),clearTimeout(o._loadStart.timeout),o._loadStart=undefined}}catch(i){e.onException("loadEnd",i)}},t*1e3))})}},e.forwardLoadEvents=function(e,t,n){function r(i,s,o){n&&e.off(G,r),t.trigger(G,i,s,o)}return e.on(G,r),{off:function(){e.off(G,r)}}},e.mixinLoadable=function(e,t){_.extend(e,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(e,n,r){var i=t?this.parent:this;!i.nonBlockingLoad&&!n&&Z&&Z.trigger(G,e,n,r),$(i.el).addClass(i._loadingClassName),i._loadingCallbacks&&i._loadingCallbacks.forEach(function(e){e()})},onLoadEnd:function(e,n){var r=t?this.parent:this;$(r.el).removeClass(r._loadingClassName),r._loadingCallbacks&&r._loadingCallbacks.forEach(function(e){e()})}})},e.mixinLoadableEvents=function(e,t){_.extend(e,{loadStart:function(e,n){var r=t?this.parent:this;r.trigger(G,e,n,r)},loadEnd:function(){var e=t?this.parent:this;e.trigger(Y,e)}})},e.mixinLoadable(e.View.prototype),e.mixinLoadableEvents(e.View.prototype),e.sync=function(e,t,n){var r=this,i=n.complete;return n.complete=function(){r._request=undefined,r._aborted=!1,i&&i.apply(this,arguments)},this._request=Backbone.sync.apply(this,arguments),this.trigger("request",this._request),this._request};var it=[];e.Model&&it.push(e.Model),e.Collection&&it.push(e.Collection),_.each(it,function(t){var n=t.prototype.fetch;e.mixinLoadableEvents(t.prototype,!1),_.extend(t.prototype,{sync:e.sync,fetch:function(e){e=e||{};var t=this,r=e.complete;return e.complete=function(){r&&r.apply(this,arguments),t.loadEnd()},t.loadStart(undefined,e.background),nt.call(this,e||{},n)},load:function(t,n,r){arguments.length===2&&typeof n!="function"&&(r=n,n=!1),r=r||{},!r.background&&!this.isPopulated()&&Z&&e.forwardLoadEvents(this,Z,!0);var i=this;tt.call(this,t,function(e){e||i._request&&(i._aborted=!0,i._request.abort()),n&&n.apply&&n.apply(this,arguments)},r)}})}),e.Util.bindToRoute=et,e.Router&&(e.Router.bindToRoute=e.Router.prototype.bindToRoute=et),e.Model&&(function(){var t=e.View.prototype._setModelOptions;e.View.prototype._setModelOptions=function(e){return t.call(this,_.defaults({ignoreErrors:this.ignoreFetchError,background:this.nonBlockingLoad},e||{}))}}(),e.View.prototype._loadModel=function(e,t){e.load?e.load(function(){t.success&&t.success(e)},t):e.fetch(t)});if(e.Collection){e.mixinLoadable(e.CollectionView.prototype),e.mixinLoadableEvents(e.CollectionView.prototype);var st=e.CollectionView.prototype._setCollectionOptions;e.CollectionView.prototype._setCollectionOptions=function(e,t){return st.call(this,e,_.defaults({ignoreErrors:this.ignoreFetchError,background:this.nonBlockingLoad},t||{}))},e.CollectionView.prototype._loadCollection=function(e,t){e.load?e.load(function(){t.success&&t.success(e)},t):e.fetch(t)}}e.View.on({"load:start":e.loadHandler(function(e,t,n){this.onLoadStart(e,t,n)},function(e,t){this.onLoadEnd(t)}),collection:{"load:start":function(e,t,n,r){this.trigger(G,t,n,r)}},model:{"load:start":function(e,t,n){this.trigger(G,e,t,n)}}}),Handlebars.registerViewHelper("loading",function(e){_render=e.render,e.render=function(){return e.parent.$el.hasClass(e.parent._loadingClassName)?_render.call(this,e.fn):_render.call(this,e.inverse)};var t=_.bind(e.render,e);e.parent._loadingCallbacks=e.parent._loadingCallbacks||[],e.parent._loadingCallbacks.push(t),e.on("freeze",function(){e.parent._loadingCallbacks=_.without(e.parent._loadingCallbacks,t)}),e.render()}),e.View.on("helper:collection",function(t){arguments.length===2&&(t=arguments[1]),t.collection||(t.collection=t.parent.collection);if(t.options["loading-view"]||t.options["loading-template"]){var n,r=e.loadHandler(_.bind(function(){t.collection.length===0&&t.$el.empty();if(t.options["loading-view"]){var r=e.Util.getViewInstance(t.options["loading-view"],{collection:t.collection});t._addChild(r),t.options["loading-template"]?r.render(t.options["loading-template"]):r.render(),n=r}else n=t.renderTemplate(t.options["loading-template"],{collection:t.collection});t.appendItem(n,t.collection.length),t.$el.children().last().attr("data-loading-element",t.collection.cid)},this),_.bind(function(){t.$el.find('[data-loading-element="'+t.collection.cid+'"]').remove()},this));t.on(t.collection,"load:start",r)}}),e.CollectionView&&(e.CollectionView._optionNames.push("loading-template"),e.CollectionView._optionNames.push("loading-view"))})();