// Copyright (c) 2011-2013 @WalmartLabs
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to
// deal in the Software without restriction, including without limitation the
// rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
// sell copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.
//

(function(e){function o(){this.helpers&&_.each(this.helpers,function(e,t){var n=this;this.helpers[t]=function(){var t=_.toArray(arguments),r=_.last(t);return r.context=this,e.apply(n,t)}},this)}function u(e,t){var n=e.extend;e.extend=function(){var e=n.apply(this,arguments);return e.prototype.name&&(t[e.prototype.name]=e),e}}function a(e,t,n,r){var i=e[t],s;if(_.indexOf(n,".")>=0){var o=n.split(/\./);n=o.pop(),_.each(o,function(e){i=i[e]})}i&&(s=i[n]);if(!s&&!r)throw new Error(t+": "+n+" does not exist.");return s}function f(e,t){var n;_.isString(this[e])?n=s.Util.getTemplate(this[e],!0):this.name&&!_.isFunction(this[e])&&(n=s.Util.getTemplate(this.name+(t.extension||""),!0)),!n&&e==="template"&&this._defaultTemplate&&(n=this._defaultTemplate),n&&!_.isFunction(this[e])&&(this[e]=n);if(t.required&&!_.isFunction(this[e]))throw new Error("View "+(this.name||this.cid)+" requires: "+e)}function l(e,t,n){return!e||!e[t]?null:_.isFunction(e[t])?e[t].call(n||e):e[t]}function h(e){_.each(c,function(t){e[t.name]||(e[t.name]=[])})}function p(e){_.each(c,function(t){e[t.name]=[]})}function d(e,t,n,r){var i=[];_.has(e,t)&&i.push(e);var s=e;if(n)while(s=s.__parent__)_.has(s,t)&&i.push(s);else{s=s.constructor;while(s)s.prototype&&_.has(s.prototype,t)&&i.push(s.prototype),s=s.__super__&&s.__super__.constructor}var o=i.length;while(o--)_.each(l(i[o],t,e),r)}function v(e,t,n,r){if(_.isObject(n)){var i=c[t];if(i&&i.event)return m(e["_"+t+"Events"],n,r),!0}}function m(e,t,n){_.each(t,function(t,r){_.isArray(t)?_.each(t,function(t){e.push([r,t,n])}):e.push([r,t,n])})}function g(e){if(!e||!e.data)throw new Error("Handlebars template compiled without data, use: Handlebars.compile(template, {data: true})");return e.data}function b(e){e.tag&&(e.tagName=e.tag,delete e.tag),e["class"]&&(e.className=e["class"],delete e["class"])}function T(e){S.push.apply(S,e),x=new RegExp("^(nested\\s+)?("+S.join("|")+")(?:\\s|$)")}function N(t,n){return function(r){var i=e(r.target).view({helper:!1});i&&i.cid===n&&(r.originalContext=this,t(r))}}function C(e,t){function o(){try{r.apply(i,arguments)}catch(t){s.onException("thorax-exception: "+(i.name||i.cid)+":"+e,t)}}e+=t.originalName;var n=t.handler,r=_.isFunction(n)?n:this[n];if(!r)throw new Error('Event "'+n+'" does not exist '+(this.name||this.cid)+":"+e);var i=t.context||this;return o._callback=r,o}function k(e,t,n){var r={originalName:e,handler:_.isString(t)?this[t]:t};if(e.match(x)){var i=E.exec(e);r.nested=!!i[1],r.name=i[2],r.type="DOM",r.selector=i[3]}else r.name=e,r.type="view";return r.context=n,r}function M(e){while(e._helperName&&e._helperName!=="view")e=e.parent;return e}function D(e){var t=_.pick(e,"fn","inverse","hash","data");return t.data=_.omit(e.data,"cid","view","yield"),t}function P(e,t){function n(e,t){return _.every(e,function(e,n){return t[n]===e})}return e._helperName!==t._helperName?!1:(e=e._helperOptions,t=t._helperOptions,e.args.length===t.args.length&&n(e.args,t.args)&&_.isEqual(_.keys(e.options),_.keys(t.options))&&_.every(e.options,function(r,i){if(i==="data"||i==="hash")return n(e.options[i],t.options[i]);if(i==="fn"||i==="inverse"){if(t.options[i]===r)return!0;var s=t.options[i]||{};return r&&_.has(r,"program")&&!r.depth&&s.program===r.program}return t.options[i]===r}))}function H(e,t){function n(n,r){var i=this[e],s=l(this,t.$el);return n===i?this:(i&&this.unbindDataObject(i),n?(this[e]=n,t.loading&&t.loading.call(this),this.bindDataObject(e,n,_.extend({},this.options,r)),s&&s.attr(t.cidAttrName,n.cid),n.trigger("set",n,i)):(this[e]=!1,t.change&&t.change.call(this,!1),s&&s.removeAttr(t.cidAttrName)),this.trigger("change:data-object",e,n,i),this)}t=c[e]=_.defaults({name:"_"+e+"Events",event:!0},t),t.ctor=function(){if(this[e]){var n=this[e];this[e]=null,this[t.set](n)}},s.View.prototype[t.set]=n}function B(e,t,n){var r=this;d(n,"_"+e+"Events",!0,function(e){function o(){if(r.el)n.apply(i,arguments);else{if(s)throw new Error("destroyed-event:"+r.name+":"+e[0]);s++}}var n=F(e[1],r),i=e[2]||r,s=0;o._callback=n,r.listenTo(t,e[0],o)})}function j(e,t){e.load?e.load(function(){t&&t.success&&t.success(e)},t):e.fetch(t)}function F(e,t){return _.isFunction(e)?e:t[e]}function q(e){var t=e&&this._objectOptionsByCid[e.cid];this.conditionalRender(t&&t.render)}function J(e){var t=e&&this._objectOptionsByCid[e.cid]||undefined;this.shouldRender(t&&t.render)&&this.renderCollection&&this.renderCollection()}function K(e){var t=e&&this._objectOptionsByCid[e.cid]||undefined;this.shouldRender(t&&t.render)&&this.ensureRendered()}function Q(){this.itemFilter&&this.collection.forEach(G,this)}function G(e){var t=this.getCollectionElement();this.itemFilter&&t.find("["+I+'="'+e.cid+'"]')[Y.call(this,e)?"show":"hide"]()}function Y(e){return this.itemFilter(e,this.collection.indexOf(e))}function Z(){var e=this.getCollectionElement();this.emptyClass&&e.removeClass(this.emptyClass),e.removeAttr(X),e.empty()}function et(){var e=this.getCollectionElement();this.emptyClass&&e.addClass(this.emptyClass),e.attr(X,!0),this.appendEmpty()}function nt(t,n,r){var i=0,s=this;this.$("select,input,textarea",t.root||this.el).each(function(){if(!t.children&&s!==e(this).view({helper:!1}))return;this.type!=="button"&&this.type!=="cancel"&&this.type!=="submit"&&this.name&&this.name!==""&&(n.call(r||this,i,this),++i)})}function rt(e,t,n,r){var i,s=e,o=t.split("["),u=n.mode;for(var a=0;a<o.length-1;++a){i=o[a].replace("]","");if(!s[i]){if(u!=="serialize")return r.call(this,!1,i);s[i]={}}s=s[i]}i=o[o.length-1].replace("]",""),r.call(this,s,i)}function it(){this.$("form").removeAttr("data-submit-wait")}function ot(e,t){t=t||{},t.target=this,this.trigger(e,t),_.each(this.children,function(n){n.trigger(e,t)})}function ut(){++this._renderCount,this.$el.attr(st,this.cid)}function at(){if(!this.$("["+st+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function ft(){return this.$("["+st+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function lt(){Backbone.history||(Backbone.history=new Backbone.History),Backbone.history.on("route",ct,this),this.on("destroyed",function(){Backbone.history.off("route",ct,this)})}function ct(e){this===e&&this.trigger.apply(this,["route"].concat(Array.prototype.slice.call(arguments,1)))}function pt(e){return function(){var t=_.toArray(arguments);t.unshift(e),this.parent.trigger.apply(this.parent,t)}}function vt(e){var t=M(this);if(!this[e]){var n=t[e];n&&(this[e]=n)}}function bt(t){var n=e(t.target),r=n.view({helper:!1}),i=n.attr(mt),s=n.attr(gt),o=!1;i&&(o=r[i].call(r,t)),s&&r.trigger(s,t),n.tagName==="A"&&o===!1&&t.preventDefault()}function Et(){St(),wt=s._fastClickEventName||"click",e(document).on(wt,yt,bt)}function St(){wt&&e(document).off(wt,yt,bt)}function kt(e,t){function i(){if(n===Backbone.history.getFragment())return;r=!0,o.cancel(),t&&t()}function s(){Backbone.history.off("route",i),r||e.apply(this,arguments)}var n=Backbone.history.getFragment(),r=!1;Backbone.history.on("route",i);var o=_.bind(s,this);return o.cancel=function(){Backbone.history.off("route",i)},o}function Lt(e,t,n){if(this.isPopulated())return _.defer(e,this);arguments.length===2&&!_.isFunction(t)&&_.isObject(t)&&(n=t,t=!1);var r=this,i=!1,s=kt(_.bind(e,r),function(){i=!0,r._request&&(r._aborted=!0,r._request.abort()),t&&t.call(r,!1)});this.fetch(_.defaults({success:s,error:function(){s.cancel(),!i&&t&&t.apply(r,[!0].concat(_.toArray(arguments)))}},n))}function At(e,t){e.resetQueue&&(this.fetchQueue=undefined);if(!this.fetchQueue)return this.fetchQueue=[e],e=_.defaults({success:Ot(this,this.fetchQueue,"success"),error:Ot(this,this.fetchQueue,"error"),complete:Ot(this,this.fetchQueue,"complete")},e),t&&t.call(this,e),e;this.fetchQueue.push(e)}function Ot(e,t,n){return function(){var r=arguments;_.each(t,function(e){e[n]&&e[n].apply(this,r)},this),e.fetchQueue===t&&(e.fetchQueue=undefined)}}function _t(){this.render()}e.fn.forEach||(e.fn.forEach=function(t,n){e.fn.each.call(this,function(e){t.call(n||this,this,e)})});var t="data-view-name",n="data-view-cid",r="data-view-helper",i={};Handlebars.templates||(Handlebars.templates={});var s=this.Thorax={VERSION:"2.0.0rc4",templatePathPrefix:"",Views:{},onException:function(e,t){throw t},templates:Handlebars.templates};s.View=Backbone.View.extend({constructor:function(){var e=Backbone.View.apply(this,arguments);return _.each(c,function(t){t.ctor&&t.ctor.call(this,e)},this),e},_configure:function(e){var t=this;this._objectOptionsByCid={},this._boundDataObjectsByCid={},_.each(c,function(e){t[e.name]=[]}),i[this.cid]=this,this.children={},this._renderCount=0,_.extend(this,e||{}),o.call(this),_.each(c,function(e){e.configure&&e.configure.call(this)},this)},setElement:function(){var e=Backbone.View.prototype.setElement.apply(this,arguments);return this.name&&this.$el.attr(t,this.name),this.$el.attr(n,this.cid),e},_addChild:function(e){return this.children[e.cid]=e,e.parent||(e.parent=this),this.trigger("child",e),e},_removeChild:function(e){return delete this.children[e.cid],e.parent=null,e},destroy:function(e){e=_.defaults(e||{},{children:!0}),_.each(this._boundDataObjectsByCid,this.unbindDataObject,this),this.trigger("destroyed"),delete i[this.cid],_.each(this.children,function(t){this._removeChild(t),e.children&&t.destroy()},this),this.parent&&this.parent._removeChild(this),this.el&&(this.undelegateEvents(),this.remove()),this.el=this.$el=undefined,this.parent=undefined,this.model=this.collection=this._collection=undefined,this._helperOptions=undefined},render:function(e){if(this._rendering)throw new Error("nested-render");this._previousHelpers=_.filter(this.children,function(e){return e._helperOptions});var t={};_.each(this.children,function(e,n){e._helperOptions||(t[n]=e)}),this.children=t,this._rendering=!0;try{_.isUndefined(e)||!_.isElement(e)&&!s.Util.is$(e)&&(!e||!e.el)&&!_.isString(e)&&!_.isFunction(e)?(f.call(this,"template",{required:!0}),e=this.renderTemplate(this.template)):_.isFunction(e)&&(e=this.renderTemplate(e))}finally{this._rendering=!1}return _.each(this._previousHelpers,function(e){e.destroy(),e.parent=undefined}),this._previousHelpers=undefined,this.html(e&&e.el||e&&e.string||e),++this._renderCount,this.trigger("rendered"),e},context:function(){return _.extend({},this.model&&this.model.attributes||{})},_getContext:function(){return _.extend({},this,l(this,"context")||{})},_getData:function(e){return{view:this,cid:_.uniqueId("t"),yield:function(){return e.fn&&e.fn(e)}}},_getHelpers:function(){return this.helpers?_.extend({},Handlebars.helpers,this.helpers):Handlebars.helpers},renderTemplate:function(e,t,n){var r;return t=t||this._getContext(),_.isFunction(e)?r=e:r=s.Util.getTemplate(e,n),r?r(t,{helpers:this._getHelpers(),data:this._getData(t)}):""},ensureRendered:function(){!this._renderCount&&this.render()},shouldRender:function(e){return e||e==null&&this._renderCount},conditionalRender:function(e){this.shouldRender(e)&&this.render()},appendTo:function(t){this.ensureRendered(),e(t).append(this.el),this.trigger("ready",{target:this})},html:function(e){if(_.isUndefined(e))return this.el.innerHTML;this.trigger("before:append");var t=this._replaceHTML(e);return this.trigger("append"),t},_replaceHTML:function(e){return this.el.innerHTML="",this.$el.append(e)},_anchorClick:function(t){var n=e(t.currentTarget),r=n.attr("href");return r&&(r[0]==="#"||r[0]==="/"&&r[1]!=="/")?(Backbone.history.navigate(r,{trigger:!0}),!1):!0}}),s.View.extend=function(){h(this);var e=Backbone.View.extend.apply(this,arguments);return e.__parent__=this,p(e),e},u(s.View,s.Views),e.fn.view=function(t){t=_.defaults(t||{},{helper:!0});var s="["+n+"]";t.helper||(s+=":not(["+r+"])");var o=e(this).closest(s);return o&&i[o.attr(n)]||!1};var c={},y=["id","className","tagName"];s.Util={getViewInstance:function(e,t){t=t||{};if(_.isString(e)){var n=a(s,"Views",e,!1);return n.cid?_.extend(n,t||{}):new n(t)}return _.isFunction(e)?new e(t):e},getTemplate:function(e,t){var n=s.templatePathPrefix,r;n&&e.substr(0,n.length)!==n&&(e=n+e),e=e.replace(/\.handlebars$/,""),r=Handlebars.templates[e],r||(e+=".handlebars",r=Handlebars.templates[e]);if(!r&&!t)throw new Error("templates: "+e+" does not exist.");return r},is$:function(e){return _.isObject(e)&&"length"in e},expandToken:function(e,t){if(e&&e.indexOf&&e.indexOf("{{")>=0){var n=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,r,i=[];function s(e,t){if(e.match(/^("|')/)&&e.match(/("|')$/))return e.replace(/(^("|')|('|")$)/g,"");var n=e.split("."),r=n.length;for(var i=0;t&&i<r;i++)n[i]!=="this"&&(t=t[n[i]]);return t}while(r=n.exec(e))if(r[1]){var o=r[1].split(/\s+/);if(o.length>1){var u=o.shift();o=_.map(o,function(e){return s(e,t)}),Handlebars.helpers[u]?i.push(Handlebars.helpers[u].apply(t,o)):i.push(r[0])}else i.push(s(o[0],t))}else i.push(r[0]);e=i.join("")}return e},tag:function(e,t,n){var r=_.omit(e,"tagName"),i=e.tagName||"div";return"<"+i+" "+_.map(r,function(e,t){if(_.isUndefined(e)||t==="expand-tokens")return"";var r=e;return n&&(r=s.Util.expandToken(e,n)),(t==="className"?"class":t)+'="'+Handlebars.Utils.escapeExpression(r)+'"'}).join(" ")+">"+(_.isUndefined(t)?"":t)+"</"+i+">"}},s.Mixins={},c.mixins={name:"mixins",configure:function(){_.each(this.constructor.mixins,this.mixin,this),_.each(this.mixins,this.mixin,this)}},_.extend(s.View,{mixin:function(e){h(this),this.mixins.push(e)},registerMixin:function(e,t,n){s.Mixins[e]=[t,n]}}),s.View.prototype.mixin=function(e){this._appliedMixins||(this._appliedMixins=[]);if(_.indexOf(this._appliedMixins,e)===-1){this._appliedMixins.push(e);if(_.isFunction(e))e.call(this);else{var t=s.Mixins[e];_.extend(this,t[1]),_.isArray(t[0])?t[0][0].apply(this,t[0][1]):t[0].apply(this,_.toArray(arguments).slice(1))}}};var w=s.View.prototype.on;c.event={name:"_events",configure:function(){var e=this;d(this.constructor,"_events",!0,function(t){e.on.apply(e,t)}),d(this,"events",!1,function(t,n){e.on(n,t,e)})}},_.extend(s.View,{on:function(e,t){return h(this),v(this,e,t)?this:(_.isObject(e)?_.each(e,function(e,t){this.on(t,e)},this):_.isArray(t)?_.each(t,function(t){this._events.push([e,t])},this):this._events.push([e,t]),this)}}),_.extend(s.View.prototype,{on:function(e,t,n){return v(this,e,t,n)?this:(_.isObject(e)&&arguments.length<3?_.each(e,function(e,n){this.on(n,e,t||this)},this):_.each(_.isArray(t)?t:[t],function(t){var r=k.call(this,e,t,n||this);r.type==="DOM"?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(r)):this._addEvent(r)},this),this)},delegateEvents:function(e){this.undelegateEvents(),e&&(_.isFunction(e)&&(e=e.call(this)),this._eventsToDelegate=[],this.on(e)),this._eventsToDelegate&&_.each(this._eventsToDelegate,this._addEvent,this)},_addEvent:function(e){if(e.type==="view")_.each(e.name.split(/\s+/),function(t){w.call(this,t,C.call(this,"view-event:",e),e.context||this)},this);else{var t=C.call(this,"dom-event:",e);e.nested||(t=N(t,this.cid));var n=e.name+".delegateEvents"+this.cid;e.selector?this.$el.on(n,e.selector,t):this.$el.on(n,t)}}}),s.View.on("ready",function(e){if(!this._isReady){this._isReady=!0;function t(t){t.trigger("ready",e)}_.each(this.children,t),this.on("child",t)}});var E=/^(nested\s+)?(\S+)(?:\s+(.+))?/,S=[],x;T(["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","focus","blur"]);var L="data-view-tmp",A={},O={_ensureElement:function(){s.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(r,this._helperName)},_getContext:function(){return this.parent._getContext.apply(this.parent,arguments)}};s.HelperView=s.View.extend(O),Handlebars.registerViewHelper=function(e,t,n){arguments.length===2&&(t.factory?n=t.callback:(n=t,t=s.HelperView)),Handlebars.registerHelper(e,function(){var r=_.toArray(arguments),i=r.pop(),o=g(i).view,u={template:i.fn||Handlebars.VM.noop,inverse:i.inverse,options:i.hash,declaringView:o,parent:M(o),_helperName:e,_helperOptions:{options:D(i),args:_.clone(r)}};b(i.hash),_.extend(u,_.pick(i.hash,y));var a=_.find(o._previousHelpers,function(e){return P(u,e)});if(!a){if(t.factory){a=t.factory(r,u);if(!a)return"";a._helperName=u._helperName,a._helperOptions=u._helperOptions}else a=new t(u);r.push(a),o._addChild(a),o.trigger.apply(o,["helper",e].concat(r)),o.trigger.apply(o,["helper:"+e].concat(r)),n&&n.apply(this,r)}else o._previousHelpers=_.without(o._previousHelpers,a),o.children[a.cid]=a;var f=_.pick(i.hash,y);f[L]=a.cid;var l=i.hash["expand-tokens"];return new Handlebars.SafeString(s.Util.tag(f,"",l?this:null))});var r=Handlebars.helpers[e];return r},s.View.on("append",function(t,n){(t||this.$el).find("["+L+"]").forEach(function(t){var r=t.getAttribute(L),i=this.children[r];i&&(A[r]?(i.render(A[r]),delete A[r]):i.ensureRendered(),e(t).replaceWith(i.el),n&&n(i.el))},this)}),_.extend(s.View.prototype,{bindDataObject:function(e,t,n){if(this._boundDataObjectsByCid[t.cid])return!1;this._boundDataObjectsByCid[t.cid]=t;var n=this._modifyDataObjectOptions(t,_.extend({},c[e].defaultOptions,n));this._objectOptionsByCid[t.cid]=n,B.call(this,e,t,this.constructor),B.call(this,e,t,this);var r=c[e];return r.bindCallback&&r.bindCallback.call(this,t,n),t.shouldFetch&&t.shouldFetch(n)?j(t,n):c[e].change&&c[e].change.call(this,t,n),!0},unbindDataObject:function(e){return this._boundDataObjectsByCid[e.cid]?(delete this._boundDataObjectsByCid[e.cid],this.stopListening(e),delete this._objectOptionsByCid[e.cid],!0):!1},_modifyDataObjectOptions:function(e,t){return t}});var I="data-model-cid";s.Model=Backbone.Model.extend({isEmpty:function(){return!this.isPopulated()},isPopulated:function(){var e=_.clone(this.attributes),t=l(this,"defaults")||{};for(var n in t){if(e[n]!=t[n])return!0;delete e[n]}var r=_.keys(e);return r.length>1||r.length===1&&r[0]!==this.idAttribute},shouldFetch:function(e){var t;try{t=l(this,"url")}catch(n){t=!1}return e.fetch&&!!t&&!this.isPopulated()}}),s.Models={},u(s.Model,s.Models),H("model",{set:"setModel",defaultOptions:{render:undefined,fetch:!0,success:!1,errors:!0},change:q,$el:"$el",cidAttrName:I}),s.View.on({model:{error:function(e,t){this._objectOptionsByCid[e.cid].errors&&this.trigger("error",t,e)},change:function(e){q.call(this,e)}}}),e.fn.model=function(t){var n=e(this),r=n.closest("["+I+"]"),i=r&&r.attr(I);if(i){var t=t||n.view();if(t&&t.model&&t.model.cid===i)return t.model||!1;var s=n.collection(t);if(s)return s.get(i)}return!1};var R=Backbone.Collection.prototype.fetch,U=Backbone.Collection.prototype.reset,z=s.View.prototype._replaceHTML,W="data-collection-cid",X="data-collection-empty",V="data-collection-element",$=1;s.Collection=Backbone.Collection.extend({model:s.Model||Backbone.Model,initialize:function(){return this.cid=_.uniqueId("collection"),Backbone.Collection.prototype.initialize.apply(this,arguments)},isEmpty:function(){return this.length>0?!1:this.length===0&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!l(this,"url")},shouldFetch:function(e){return e.fetch&&!!l(this,"url")&&!this.isPopulated()},fetch:function(e){e=e||{};var t=e.success;return e.success=function(e,n){e._fetched=!0,t&&t(e,n)},R.apply(this,arguments)},reset:function(e,t){return this._fetched=!!e,U.call(this,e,t)}}),s.Collections={},u(s.Collection,s.Collections),H("collection",{set:"setCollection",bindCallback:K,defaultOptions:{render:undefined,fetch:!0,success:!1,errors:!0},change:J,$el:"getCollectionElement",cidAttrName:W}),s.CollectionView=s.View.extend({_defaultTemplate:Handlebars.VM.noop,_collectionSelector:"["+V+"]",_replaceHTML:function(e){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return z.call(this,e);var t,n=this.getCollectionElement();t=z.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)},render:function(){var e=this.shouldRender();s.View.prototype.render.apply(this,arguments),e||this.renderCollection()},appendItem:function(t,n,r){if(!t)return;var i,s=this.getCollectionElement();r=_.defaults(r||{},{filter:!0}),n&&n.el&&(n=s.children().indexOf(n.el)+1),t.el||_.isString(t)?(i=t,t=!1):(n=n||this.collection.indexOf(t)||0,i=this.renderItem(t,n));if(i){i.cid&&(i.ensureRendered(),this._addChild(i)),_.isString(i)&&!i.match(/^\s*</m)&&(i="<div>"+i+"</div>");var o=i.$el?i.$el:_.filter(e(e.trim(i)),function(e){return e.nodeType===$});t&&e(o).attr(I,t.cid);var u=n>0?this.collection.at(n-1):!1;if(!u)s.prepend(o);else{var a=s.children("["+I+'="'+u.cid+'"]').last();a.after(o)}this.trigger("append",null,function(e){e.setAttribute(I,t.cid)}),!r.silent&&this.trigger("rendered:item",this,this.collection,t,o,n),r.filter&&G.call(this,t)}return i},updateItem:function(e){var t=this.getCollectionElement(),r=t.find("["+I+'="'+e.cid+'"]');if(r.attr(n))return;this.removeItem(r),this.appendItem(e)},removeItem:function(e){var t=e;if(e.cid){var r=this.getCollectionElement();t=r.find("["+I+'="'+e.cid+'"]')}if(!t.length)return!1;t.remove();var i=t.attr(n),s=this.children[i];return s&&(this._removeChild(s),s.destroy()),!0},renderCollection:function(){this.collection?(this.collection.isEmpty()?et.call(this):(Z.call(this),this.collection.forEach(function(e,t){this.appendItem(e,t)},this)),this.trigger("rendered:collection",this,this.collection)):et.call(this)},emptyClass:"empty",renderEmpty:function(){!this.emptyTemplate&&!this.emptyView&&f.call(this,"emptyTemplate",{extension:"-empty",required:!1});if(this.emptyView){var e={};this.emptyTemplate&&(e.template=this.emptyTemplate);var t=s.Util.getViewInstance(this.emptyView,e);return t.ensureRendered(),t}return this.emptyTemplate&&this.renderTemplate(this.emptyTemplate)},renderItem:function(e,t){!this.itemTemplate&&!this.itemView&&f.call(this,"itemTemplate",{extension:"-item",required:!this.itemView});if(this.itemView){var n={model:e};return this.itemTemplate&&(n.template=this.itemTemplate),s.Util.getViewInstance(this.itemView,n)}return this.renderTemplate(this.itemTemplate,this.itemContext(e,t))},itemContext:function(e){return e.attributes},appendEmpty:function(){var e=this.getCollectionElement();e.empty();var t=this.renderEmpty();t&&this.appendItem(t,0,{silent:!0,filter:!1}),this.trigger("rendered:empty",this,this.collection)},getCollectionElement:function(){var e=this.$(this._collectionSelector);return e.length===0?this.$el:e}}),s.CollectionView.on({collection:{reset:J,sort:J,filter:function(){Q.call(this)},change:function(e){this.updateItem(e),G.call(this,e)},add:function(e){var t=this.getCollectionElement();this.collection.length===1&&t.length&&Z.call(this);if(t.length){var n=this.collection.indexOf(e);this.appendItem(e,n)}},remove:function(e){var t=this.getCollectionElement();this.removeItem(e),this.collection.length===0&&t.length&&et.call(this)}}}),s.View.on({collection:{error:function(e,t){this._objectOptionsByCid[e.cid].errors&&this.trigger("error",t,e)}}}),e.fn.collection=function(t){if(t&&t.collection)return t.collection;var n=e(this),r=n.closest("["+W+"]"),i=r&&r.attr(W);if(i){t=n.view();if(t)return t.collection}return!1},c.model.defaultOptions.populate=!0;var tt=c.model.change;c.model.change=function(){tt.apply(this,arguments);var e=this.model&&this._objectOptionsByCid[this.model.cid];e&&e.populate&&this.populate(this.model.attributes,e.populate===!0?{}:e.populate)},c.model.defaultOptions.populate=!0,_.extend(s.View.prototype,{serialize:function(){var e,t,n;for(var r=0;r<arguments.length;++r)_.isFunction(arguments[r])?e=arguments[r]:_.isObject(arguments[r])&&("stopPropagation"in arguments[r]&&"preventDefault"in arguments[r]?n=arguments[r]:t=arguments[r]);if(n&&!this._preventDuplicateSubmission(n))return;t=_.extend({set:!0,validate:!0,children:!0,silent:!0},t||{});var i=t.attributes||{},s=this,o=[];nt.call(this,t,function(){var e=s._getInputValue(this,t,o);_.isUndefined(e)||rt.call(this,i,this.name,{mode:"serialize"},function(t,n){t[n]?_.isArray(t[n])?t[n].push(e):t[n]=[t[n],e]:t[n]=e})}),this.trigger("serialize",i,t);if(t.validate){var u=this.validateInput(i);u&&u.length&&(o=o.concat(u)),this.trigger("validate",i,o,t);if(o.length){this.trigger("error",o);return}}return t.set&&this.model&&!this.model.set(i,{silent:t.silent})?!1:(e&&e.call(this,i,_.bind(it,this)),i)},_preventDuplicateSubmission:function(t,n){t.preventDefault();var r=e(t.target);return(t.target.tagName||"").toLowerCase()!=="form"&&(r=e(t.target).closest("form")),r.attr("data-submit-wait")?!1:(r.attr("data-submit-wait","true"),n&&n.call(this,t),!0)},populate:function(e,t){t=_.extend({children:!0},t||{});var n,e=e||this._getContext();nt.call(this,t,function(){rt.call(this,e,this.name,{mode:"populate"},function(e,t){n=e&&e[t],_.isUndefined(n)||(this.type==="checkbox"&&_.isBoolean(n)?this.checked=n:this.type==="checkbox"||this.type==="radio"?this.checked=n==this.value:this.value=n)})}),this.trigger("populate",e)},validateInput:function(){},_getInputValue:function(t){if(t.type!=="checkbox"&&t.type!=="radio"){if(t.multiple===!0){var n=[];return e("option",t).each(function(){this.selected&&n.push(this.value)}),n}return t.value}if(t.checked)return t.value}}),s.View.on({error:function(){it.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})},deactivated:function(){it.call(this)}});var st="data-layout-cid";s.LayoutView=s.View.extend({_defaultTemplate:Handlebars.VM.noop,render:function(){var e=s.View.prototype.render.apply(this,arguments);return this.template===Handlebars.VM.noop?ut.call(this):at.call(this),e},setView:function(e,t){t=_.extend({scroll:!0,destroy:!0},t||{}),_.isString(e)&&(e=new(s.Util.registryGet(s,"Views",e,!1))),this.ensureRendered();var n=this._view;return e===n?!1:(t.destroy&&e&&(e._shouldDestroyOnNextSetView=!0),this.trigger("change:view:start",e,n,t),n&&(this._removeChild(n),n.$el.remove(),ot.call(n,"deactivated",t),n._shouldDestroyOnNextSetView&&n.destroy()),e?(ot.call(this,"activated",t),e.trigger("activated",t),this._addChild(e),this._view=e,this._view.appendTo(ft.call(this))):this._view=undefined,this.trigger("change:view:end",e,n,t),e)},getView:function(){return this._view}}),Handlebars.registerHelper("layout-element",function(e){var t=g(e).view;if(!t.getView)throw new Error("layout-element must be used within a LayoutView");return e.hash[st]=t.cid,b(e.hash),new Handlebars.SafeString(s.Util.tag.call(this,e.hash,"",this))}),s.Router=Backbone.Router.extend({constructor:function(){var e=s.Router.__super__.constructor.apply(this,arguments);return lt.call(this),e},route:function(e,t,n){return n||(n=this[t]),Backbone.Router.prototype.route.call(this,e,t,function(){return this.trigger.apply(this,["route:before",e,t].concat(Array.prototype.slice.call(arguments))),n.apply(this,arguments)})}}),s.Routers={},u(s.Router,s.Routers),s.CollectionHelperView=s.CollectionView.extend({events:{"rendered:item":pt("rendered:item"),"rendered:collection":pt("rendered:collection"),"rendered:empty":pt("rendered:empty")},constructor:function(e){_.each(ht,function(t,n){if(e.options[n]){var r=e.options[n];if(t==="itemTemplate"||t==="emptyTemplate")r=s.Util.getTemplate(r);e[t]=r}}),!e.itemTemplate&&e.template&&e.template!==Handlebars.VM.noop&&(e.itemTemplate=e.template,e.template=Handlebars.VM.noop),!e.emptyTemplate&&e.inverse&&e.inverse!==Handlebars.VM.noop&&(e.emptyTemplate=e.inverse,e.inverse=Handlebars.VM.noop);var t=s.HelperView.call(this,e);return this.parent.name&&(this.emptyTemplate||(this.emptyTemplate=s.Util.getTemplate(this.parent.name+"-empty",!0)),this.itemTemplate||(this.itemTemplate=s.Util.getTemplate(this.parent.name+"-item",!!this.itemView))),t},setAsPrimaryCollectionHelper:function(){_.each(dt,function(e){vt.call(this,e)},this);var e=this;_.each(["itemFilter","itemContext","renderItem","renderEmpty"],function(t){e.parent[t]&&!this[t]&&(e[t]=function(){return e.parent[t].apply(e.parent,arguments)})})}}),_.extend(s.CollectionHelperView.prototype,O);var ht={"item-template":"itemTemplate","empty-template":"emptyTemplate","item-view":"itemView","empty-view":"emptyView","empty-class":"emptyClass"},dt=["itemTemplate","itemView","emptyTemplate","emptyView"];Handlebars.registerViewHelper("collection",s.CollectionHelperView,function(e,t){arguments.length===1&&(t=e,e=t.parent.collection,e&&t.setAsPrimaryCollectionHelper(),t.$el.attr(V,"true"),t.listenTo(t.parent,"change:data-object",function(e,n){e==="collection"&&(t.setAsPrimaryCollectionHelper(),t.setCollection(n))})),e&&t.setCollection(e)}),Handlebars.registerHelper("collection-element",function(e){if(!g(e).view.renderCollection)throw new Error("collection-element helper must be declared inside of a CollectionView");var t=e.hash;return b(t),t.tagName=t.tagName||"div",t[V]=!0,new Handlebars.SafeString(s.Util.tag.call(this,t,"",this))}),Handlebars.registerHelper("empty",function(e,t){arguments.length===1&&(t=e);var n=g(t).view;return arguments.length===1&&(e=n.model),n._emptyListeners||(n._emptyListeners={}),e&&!n._emptyListeners[e.cid]&&e.models&&"length"in e&&(n._emptyListeners[e.cid]=!0,n.listenTo(e,"remove",function(){e.length===0&&n.render()}),n.listenTo(e,"add",function(){e.length===1&&n.render()}),n.listenTo(e,"reset",function(){n.render()})),!e||e.isEmpty()?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("template",function(e,t){var n=_.extend({fn:t&&t.fn},this,t?t.hash:{}),r=g(t).view.renderTemplate(e,n);return new Handlebars.SafeString(r)}),Handlebars.registerHelper("yield",function(e){return g(e).yield&&e.data.yield()}),Handlebars.registerHelper("url",function(e){var t;if(arguments.length>2)t=_.map(_.head(arguments,arguments.length-1),encodeURIComponent).join("/");else{var n=arguments[1],r=n&&n.hash||n;r&&r["expand-tokens"]?t=s.Util.expandToken(e,this):t=e}if(Backbone.history._hasPushState){var i=Backbone.history.options.root;return i==="/"&&t.substr(0,1)==="/"?t:i+t}return"#"+t}),Handlebars.registerViewHelper("view",{factory:function(e,t){var n=e.length>=1?e[0]:s.View;return s.Util.getViewInstance(n,t.options)},callback:function(){var e=arguments[arguments.length-1],t=e._helperOptions.options,n=e.cid;t.fn&&(A[n]=t.fn)}});var mt="data-call-method",gt="data-trigger-event";Handlebars.registerHelper("button",function(e,t){arguments.length===1&&(t=e,e=t.hash.method);var n=t.hash,r=n["expand-tokens"];delete n["expand-tokens"];if(!e&&!t.hash.trigger)throw new Error("button helper must have a method name as the first argument or a 'trigger', or a 'method' attribute specified.");return b(n),n.tagName=n.tagName||"button",n.trigger&&(n[gt]=n.trigger),delete n.trigger,e&&(n[mt]=e),new Handlebars.SafeString(s.Util.tag(n,t.fn?t.fn(this):"",r?this:null))}),Handlebars.registerHelper("link",function(){var e=_.toArray(arguments),t=e.pop(),n=t.hash,r=e.length===0?[n.href]:e,i=n["expand-tokens"];delete n["expand-tokens"];if(!r[0]&&r[0]!=="")throw new Error("link helper requires an href as the first argument or an 'href' attribute");return b(n),r.push(t),n.href=Handlebars.helpers.url.apply(this,r),n.tagName=n.tagName||"a",n.trigger&&(n[gt]=t.hash.trigger),delete n.trigger,n[mt]="_anchorClick",new Handlebars.SafeString(s.Util.tag(n,t.fn?t.fn(this):"",i?this:null))});var yt="["+mt+"], ["+gt+"]",wt;e(document).ready(function(){s._fastClickEventName||Et()});var xt="data-element-tmp";Handlebars.registerHelper("element",function(e,t){b(t.hash);var n=_.uniqueId("element"),r=g(t).view,i=_.pick(t.hash,y);return i[xt]=n,r._elementsByCid||(r._elementsByCid={}),r._elementsByCid[n]=e,new Handlebars.SafeString(s.Util.tag(i))}),s.View.on("append",function(t,n){(t||this.$el).find("["+xt+"]").forEach(function(t){var r=e(t),i=r.attr(xt),s=this._elementsByCid[i];_.isFunction(s)&&(s=s.call(this)),r.replaceWith(s),n&&n(s)},this)}),Handlebars.registerHelper("super",function(e){var t=g(e).view,n=t.constructor&&t.constructor.__super__;if(n){var r=n.template;if(!r){if(!n.name)throw new Error("Cannot use super helper when parent has no name or template.");r=n.name}return _.isString(r)&&(r=s.Util.getTemplate(r,!1)),new Handlebars.SafeString(r(this,e))}return""});var Tt="load:start",Nt="load:end",Ct;s.setRootObject=function(e){Ct=e},s.loadHandler=function(e,t,n){var r=_.uniqueId("load");return function(i,o,u){function l(){if(f.timeout&&!f.run)return;var t=a._loadingTimeoutDuration!==undefined?a._loadingTimeoutDuration:s.View.prototype._loadingTimeoutDuration;f.timeout=setTimeout(function(){try{f.run=!0,e.call(a,f.message,f.background,f)}catch(t){s.onException("loadStart",t)}},t*1e3)}var a=n||this;a._loadInfo=a._loadInfo||{};var f=a._loadInfo[r];f?(clearTimeout(f.endTimeout),f.message=i,!o&&f.background&&(f.background=!1,l())):(f=a._loadInfo[r]=_.extend({isLoading:function(){return f.events.length},cid:r,events:[],timeout:0,message:i,background:!!o},Backbone.Events),l());if(_.indexOf(f.events,u)>=0)return;f.events.push(u),u.on(Nt,function c(){var e=a._loadingTimeoutEndDuration;e===void 0&&(e=s.View.prototype._loadingTimeoutEndDuration);var n=f.events,i=_.indexOf(n,u);i>=0&&!u.isLoading()&&(n.splice(i,1),_.indexOf(n,u)<0&&u.off(Nt,c)),n.length||(clearTimeout(f.endTimeout),f.endTimeout=setTimeout(function(){try{n.length||(f.run&&(t.call(a,f.background,f),f.trigger(Nt,f)),clearTimeout(f.timeout),f=a._loadInfo[r]=undefined)}catch(e){s.onException("loadEnd",e)}},e*1e3))})}},s.forwardLoadEvents=function(e,t,n){function r(i,s,o){n&&e.off(Tt,r),t.trigger(Tt,i,s,o)}return e.on(Tt,r),{off:function(){e.off(Tt,r)}}},s.mixinLoadable=function(t,n){_.extend(t,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(t,r,i){var s=n?this.parent:this;if(!s||!s.el)return;!s.nonBlockingLoad&&!r&&Ct&&Ct!==this&&Ct.trigger(Tt,t,r,i),s._isLoading=!0,e(s.el).addClass(s._loadingClassName),s.trigger("change:load-state","start",r)},onLoadEnd:function(){var t=n?this.parent:this;if(!t||!t.el)return;t._isLoading=!1,e(t.el).removeClass(t._loadingClassName),t.trigger("change:load-state","end")}})},s.mixinLoadableEvents=function(e,t){_.extend(e,{_loadCount:0,isLoading:function(){return this._loadCount>0},loadStart:function(e,n){this._loadCount++;var r=t?this.parent:this;r.trigger(Tt,e,n,r)},loadEnd:function(){this._loadCount--;var e=t?this.parent:this;e.trigger(Nt,e)}})},s.mixinLoadable(s.View.prototype),s.mixinLoadableEvents(s.View.prototype),s.HelperView&&(s.mixinLoadable(s.HelperView.prototype,!0),s.mixinLoadableEvents(s.HelperView.prototype,!0)),s.CollectionHelperView&&(s.mixinLoadable(s.CollectionHelperView.prototype,!0),s.mixinLoadableEvents(s.CollectionHelperView.prototype,!0)),s.sync=function(e,t,n){var r=this,i=n.complete;return n.complete=function(){r._request=undefined,r._aborted=!1,i&&i.apply(this,arguments)},this._request=Backbone.sync.apply(this,arguments),this._request};var Mt=[];s.Model&&Mt.push(s.Model),s.Collection&&Mt.push(s.Collection),_.each(Mt,function(e){var t=e.prototype.fetch;s.mixinLoadableEvents(e.prototype,!1),_.extend(e.prototype,{sync:s.sync,fetch:function(e){e=e||{};var n=this,r=e.complete;return e.complete=function(){r&&r.apply(this,arguments),n.loadEnd()},n.loadStart(undefined,e.background),At.call(this,e||{},t)},load:function(e,t,n){arguments.length===2&&!_.isFunction(t)&&(n=t,t=!1),n=n||{},!n.background&&!this.isPopulated()&&Ct&&s.forwardLoadEvents(this,Ct,!0),Lt.call(this,e,t,n)}})}),s.Util.bindToRoute=kt,s.Router&&(s.Router.bindToRoute=s.Router.prototype.bindToRoute=kt),s.View.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.ignoreFetchError,t.background=this.nonBlockingLoad,t},s.HelperView.prototype._modifyDataObjectOptions=s.CollectionHelperView.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.parent.ignoreFetchError,t.background=this.parent.nonBlockingLoad,t},c.collection.loading=function(){var e=this.loadingView,t=this.loadingTemplate,n=this.loadingPlacement;if(e||t){var r=s.loadHandler(_.bind(function(){var r;this.collection.length===0&&this.$el.empty();if(e){var i=s.Util.getViewInstance(e);this._addChild(i),t?i.render(t):i.render(),r=i}else r=this.renderTemplate(t);var o=n?n.call(this):this.collection.length;this.appendItem(r,o),this.$el.children().eq(o).attr("data-loading-element",this.collection.cid)},this),_.bind(function(){this.$el.find('[data-loading-element="'+this.collection.cid+'"]').remove()},this),this.collection);this.listenTo(this.collection,"load:start",r)}},ht&&(ht["loading-template"]="loadingTemplate",ht["loading-view"]="loadingView",ht["loading-placement"]="loadingPlacement"),s.View.on({"load:start":s.loadHandler(function(e,t,n){this.onLoadStart(e,t,n)},function(e,t){this.onLoadEnd(t)}),collection:{"load:start":function(e,t,n){this.trigger(Tt,e,t,n)}},model:{"load:start":function(e,t,n){this.trigger(Tt,e,t,n)}}}),Handlebars.registerHelper("loading",function(e){var t=g(e).view;return t.off("change:load-state",_t,t),t.on("change:load-state",_t,t),t._isLoading?e.fn(this):e.inverse(this)});var Dt=/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());Dt&&(s.View.on("before:append",function(){this._renderCount>0&&(_.each(this._elementsByCid,function(t){e(t).detach()}),_.each(this.children,function(e){e.$el.detach()}))}),s.CollectionView.prototype._replaceHTML=function(e){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return z.call(this,e);var t,n=this.getCollectionElement().clone(!0,!0);t=z.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)})})(jQuery);