!function(e,t){"undefined"!=typeof exports?t(e,exports,require("underscore"),Backbone):"function"==typeof define&&define.amd?define(["underscore","jquery","backbone","exports"],function(n,r,i,s){e.Thorax=t(e,s,n,r,i)}):e.Thorax=t(e,{},e._,e.jQuery||e.Zepto||e.ender||e.$,e.Backbone)}(this,function(e,t,n,r,i){function s(){this.helpers&&n.each(this.helpers,function(e,t){var r=this;this.helpers[t]=function(){var t=n.toArray(arguments),i=n.last(t);return i.context=this,e.apply(r,t)}},this)}function o(e,t){var n=e.extend;e.extend=function(){var e=n.apply(this,arguments);return e.prototype.name&&(t[e.prototype.name]=e),e}}function u(e,t,r,i){var s,o=e[t];if(n.indexOf(r,".")>=0){var u=r.split(/\./);r=u.pop(),n.each(u,function(e){o=o[e]})}if(o&&(s=o[r]),s||i)return s;throw new Error(t+": "+r+" does not exist.")}function a(e,r){var i;if(n.isString(this[e])?i=t.Util.getTemplate(this[e],!0):this.name&&!n.isFunction(this[e])&&(i=t.Util.getTemplate(this.name+(r.extension||""),!0)),!i&&"template"===e&&this._defaultTemplate&&(i=this._defaultTemplate),i&&!n.isFunction(this[e])&&(this[e]=i),r.required&&!n.isFunction(this[e]))throw new Error("View "+(this.name||this.cid)+" requires: "+e)}function f(e,t,r){return e&&e[t]?n.isFunction(e[t])?e[t].call(r||e):e[t]:null}function l(e){n.each(st,function(t){e[t.name]||(e[t.name]=[])})}function c(e){n.each(st,function(t){e[t.name]=[]})}function h(e,t,r,i){var s=[];n.has(e,t)&&s.push(e);var o=e;if(r)for(;o=o.__parent__;)n.has(o,t)&&s.push(o);else for(o=o.constructor;o;)o.prototype&&n.has(o.prototype,t)&&s.push(o.prototype),o=o.__super__&&o.__super__.constructor;for(var u=s.length;u--;)n.each(f(s[u],t,e),i)}function p(e,t,r,i){if(n.isObject(r)){var s=st[t];if(s&&s.event)return d(e["_"+t+"Events"],r,i),!0}}function d(e,t,r){n.each(t,function(t,i){n.isArray(t)?n.each(t,function(t){e.push([i,t,r])}):e.push([i,t,r])})}function v(e){if(!e||!e.data)throw new Error("Handlebars template compiled without data, use: Handlebars.compile(template, {data: true})");return e.data}function m(e){e.tag&&(e.tagName=e.tag,delete e.tag),e["class"]&&(e.className=e["class"],delete e["class"])}function g(e){lt.push.apply(lt,e),at=new RegExp("^(nested\\s+)?("+lt.join("|")+")(?:\\s|$)")}function y(e,t){return function(n){var i=r(n.target).view({helper:!1});i&&i.cid===t&&(n.originalContext=this,e(n))}}function b(e,r){function i(){try{o.apply(u,arguments)}catch(n){t.onException("thorax-exception: "+(u.name||u.cid)+":"+e,n)}}e+=r.originalName;var s=r.handler,o=n.isFunction(s)?s:this[s];if(!o)throw new Error('Event "'+s+'" does not exist '+(this.name||this.cid)+":"+e);var u=r.context||this;return i._callback=o,i}function w(e,t,r){var i={originalName:e,handler:n.isString(t)?this[t]:t};if(e.match(at)){var s=ft.exec(e);i.nested=!!s[1],i.name=s[2],i.type="DOM",i.selector=s[3]}else i.name=e,i.type="view";return i.context=r,i}function E(e){for(;e._helperName&&"view"!==e._helperName;)e=e.parent;return e}function S(e){var t=n.pick(e,"fn","inverse","hash","data");return t.data=n.omit(e.data,"cid","view","yield"),t}function x(e,t){function r(e,t){return n.every(e,function(e,n){return t[n]===e})}return e._helperName!==t._helperName?!1:(e=e._helperOptions,t=t._helperOptions,e.args.length===t.args.length&&r(e.args,t.args)&&n.isEqual(n.keys(e.options),n.keys(t.options))&&n.every(e.options,function(i,s){if("data"===s||"hash"===s)return r(e.options[s],t.options[s]);if("fn"===s||"inverse"===s){if(t.options[s]===i)return!0;var o=t.options[s]||{};return i&&n.has(i,"program")&&!i.depth&&o.program===i.program}return t.options[s]===i}))}function T(e,r){function i(t,i){var s=this[e],o=f(this,r.$el);return t===s?this:(s&&this.unbindDataObject(s),t?(this[e]=t,r.loading&&r.loading.call(this),this.bindDataObject(e,t,n.extend({},this.options,i)),o&&o.attr(r.cidAttrName,t.cid),t.trigger("set",t,s)):(this[e]=!1,r.change&&r.change.call(this,!1),o&&o.removeAttr(r.cidAttrName)),this.trigger("change:data-object",e,t,s),this)}r=st[e]=n.defaults({name:"_"+e+"Events",event:!0},r),r.ctor=function(){if(this[e]){var t=this[e];this[e]=null,this[r.set](t)}},t.View.prototype[r.set]=i}function N(e,t,n){var r=this;h(n,"_"+e+"Events",!0,function(e){function n(){if(r.el)i.apply(s,arguments);else{if(o)throw new Error("destroyed-event:"+r.name+":"+e[0]);o++}}var i=k(e[1],r),s=e[2]||r,o=0;n._callback=i,r.listenTo(t,e[0],n)})}function C(e,t){e.load?e.load(function(){t&&t.success&&t.success(e)},t):e.fetch(t)}function k(e,t){return n.isFunction(e)?e:t[e]}function L(e){var t=e&&this._objectOptionsByCid[e.cid];this.conditionalRender(t&&t.render)}function A(e){var t=e&&this._objectOptionsByCid[e.cid]||void 0;this.shouldRender(t&&t.render)&&this.renderCollection&&this.renderCollection()}function O(e){var t=e&&this._objectOptionsByCid[e.cid]||void 0;this.shouldRender(t&&t.render)&&this.ensureRendered()}function M(){this.itemFilter&&this.collection.forEach(_,this)}function _(e){var t=this.getCollectionElement();this.itemFilter&&t.find("["+dt+'="'+e.cid+'"]')[D.call(this,e)?"show":"hide"]()}function D(e){return this.itemFilter(e,this.collection.indexOf(e))}function P(){var e=this.getCollectionElement();this.emptyClass&&e.removeClass(this.emptyClass),e.removeAttr(bt),e.empty()}function H(){var e=this.getCollectionElement();this.emptyClass&&e.addClass(this.emptyClass),e.attr(bt,!0),this.appendEmpty()}function B(e,t,n){var i=0,s=this;this.$("select,input,textarea",e.root||this.el).each(function(){(e.children||s===r(this).view({helper:!1}))&&"button"!==this.type&&"cancel"!==this.type&&"submit"!==this.type&&this.name&&""!==this.name&&(t.call(n||this,i,this),++i)})}function j(e,t,n,r){for(var i,s=e,o=t.split("["),u=n.mode,a=0;a<o.length-1;++a){if(i=o[a].replace("]",""),!s[i]){if("serialize"!==u)return r.call(this,!1,i);s[i]={}}s=s[i]}i=o[o.length-1].replace("]",""),r.call(this,s,i)}function F(){this.$("form").removeAttr("data-submit-wait")}function I(e,t){t=t||{},t.target=this,this.trigger(e,t),n.each(this.children,function(n){n.trigger(e,t)})}function q(){++this._renderCount,this.$el.attr(xt,this.cid)}function R(){if(!this.$("["+xt+'="'+this.cid+'"]')[0])throw new Error("No layout element found in "+(this.name||this.cid))}function U(){return this.$("["+xt+'="'+this.cid+'"]')[0]||this.el[0]||this.el}function z(){i.history||(i.history=new i.History),i.history.on("route",W,this),this.on("destroyed",function(){i.history.off("route",W,this)})}function W(e){this===e&&this.trigger.apply(this,["route"].concat(Array.prototype.slice.call(arguments,1)))}function X(e){return function(){var t=n.toArray(arguments);t.unshift(e),this.parent.trigger.apply(this.parent,t)}}function V(e){var t=E(this);if(!this[e]){var n=t[e];n&&(this[e]=n)}}function $(e){var t=r(e.target),n=t.view({helper:!1}),i=t.attr(Ct),s=t.attr(kt),o=!1;i&&(o=n[i].call(n,e)),s&&n.trigger(s,e),"A"===t.tagName&&o===!1&&e.preventDefault()}function J(){K(),Lt=t._fastClickEventName||"click",r(document).on(Lt,At,$)}function K(){Lt&&r(document).off(Lt,At,$)}function Q(e,t){function r(){o!==i.history.getFragment()&&(u=!0,a.cancel(),t&&t())}function s(){i.history.off("route",r),u||e.apply(this,arguments)}var o=i.history.getFragment(),u=!1;i.history.on("route",r);var a=n.bind(s,this);return a.cancel=function(){i.history.off("route",r)},a}function G(e,t,r){if(this.isPopulated())return n.defer(e,this);2===arguments.length&&!n.isFunction(t)&&n.isObject(t)&&(r=t,t=!1);var i=this,s=!1,o=Q(n.bind(e,i),function(){s=!0,i._request&&(i._aborted=!0,i._request.abort()),t&&t.call(i,!1)});this.fetch(n.defaults({success:o,error:function(){o.cancel(),!s&&t&&t.apply(i,[!0].concat(n.toArray(arguments)))}},r))}function Y(e,t){return e.resetQueue&&(this.fetchQueue=void 0),this.fetchQueue?(this.fetchQueue.push(e),void 0):(this.fetchQueue=[e],e=n.defaults({success:Z(this,this.fetchQueue,"success"),error:Z(this,this.fetchQueue,"error"),complete:Z(this,this.fetchQueue,"complete")},e),t&&t.call(this,e),e)}function Z(e,t,r){return function(){var i=arguments;n.each(t,function(e){e[r]&&e[r].apply(this,i)},this),e.fetchQueue===t&&(e.fetchQueue=void 0)}}function et(){this.render()}r.fn.forEach||(r.fn.forEach=function(e,t){r.fn.each.call(this,function(n){e.call(t||this,this,n)})});var tt="data-view-name",nt="data-view-cid",rt="data-view-helper",it={};Handlebars.templates||(Handlebars.templates={}),t.VERSION="2.0.0rc4",t.templatePathPrefix="",t.Views={},t.onException=function(e,t){throw t},t.templates=Handlebars.templates,t.View=i.View.extend({constructor:function(){var e=i.View.apply(this,arguments);return n.each(st,function(t){t.ctor&&t.ctor.call(this,e)},this),e},_configure:function(e){var t=this;this._objectOptionsByCid={},this._boundDataObjectsByCid={},n.each(st,function(e){t[e.name]=[]}),it[this.cid]=this,this.children={},this._renderCount=0,n.extend(this,e||{}),s.call(this),n.each(st,function(e){e.configure&&e.configure.call(this)},this)},setElement:function(){var e=i.View.prototype.setElement.apply(this,arguments);return this.name&&this.$el.attr(tt,this.name),this.$el.attr(nt,this.cid),e},_addChild:function(e){return this.children[e.cid]=e,e.parent||(e.parent=this),this.trigger("child",e),e},_removeChild:function(e){return delete this.children[e.cid],e.parent=null,e},destroy:function(e){e=n.defaults(e||{},{children:!0}),n.each(this._boundDataObjectsByCid,this.unbindDataObject,this),this.trigger("destroyed"),delete it[this.cid],n.each(this.children,function(t){this._removeChild(t),e.children&&t.destroy()},this),this.parent&&this.parent._removeChild(this),this.el&&(this.undelegateEvents(),this.remove()),this.el=this.$el=void 0,this.parent=void 0,this.model=this.collection=this._collection=void 0,this._helperOptions=void 0},render:function(e){if(this._rendering)throw new Error("nested-render");this._previousHelpers=n.filter(this.children,function(e){return e._helperOptions});var r={};n.each(this.children,function(e,t){e._helperOptions||(r[t]=e)}),this.children=r,this._rendering=!0;try{!n.isUndefined(e)&&(n.isElement(e)||t.Util.is$(e)||e&&e.el||n.isString(e)||n.isFunction(e))?n.isFunction(e)&&(e=this.renderTemplate(e)):(a.call(this,"template",{required:!0}),e=this.renderTemplate(this.template))}finally{this._rendering=!1}return n.each(this._previousHelpers,function(e){e.destroy(),e.parent=void 0}),this._previousHelpers=void 0,this.html(e&&e.el||e&&e.string||e),++this._renderCount,this.trigger("rendered"),e},context:function(){return n.extend({},this.model&&this.model.attributes||{})},_getContext:function(){return n.extend({},this,f(this,"context")||{})},_getData:function(e){return{view:this,cid:n.uniqueId("t"),yield:function(){return e.fn&&e.fn(e)}}},_getHelpers:function(){return this.helpers?n.extend({},Handlebars.helpers,this.helpers):Handlebars.helpers},renderTemplate:function(e,r,i){var s;return r=r||this._getContext(),s=n.isFunction(e)?e:t.Util.getTemplate(e,i),s?s(r,{helpers:this._getHelpers(),data:this._getData(r)}):""},ensureRendered:function(){!this._renderCount&&this.render()},shouldRender:function(e){return e||null==e&&this._renderCount},conditionalRender:function(e){this.shouldRender(e)&&this.render()},appendTo:function(e){this.ensureRendered(),r(e).append(this.el),this.trigger("ready",{target:this})},html:function(e){if(n.isUndefined(e))return this.el.innerHTML;this.trigger("before:append");var t=this._replaceHTML(e);return this.trigger("append"),t},_replaceHTML:function(e){return this.el.innerHTML="",this.$el.append(e)},_anchorClick:function(e){var t=r(e.currentTarget),n=t.attr("href");return n&&("#"===n[0]||"/"===n[0]&&"/"!==n[1])?(i.history.navigate(n,{trigger:!0}),!1):!0}}),t.View.extend=function(){l(this);var e=i.View.extend.apply(this,arguments);return e.__parent__=this,c(e),e},o(t.View,t.Views),r.fn.view=function(e){e=n.defaults(e||{},{helper:!0});var t="["+nt+"]";e.helper||(t+=":not(["+rt+"])");var i=r(this).closest(t);return i&&it[i.attr(nt)]||!1};var st={},ot=["id","className","tagName"];t.Util={getViewInstance:function(e,r){if(r=r||{},n.isString(e)){var i=u(t,"Views",e,!1);return i.cid?n.extend(i,r||{}):new i(r)}return n.isFunction(e)?new e(r):e},getTemplate:function(e,n){var r,i=t.templatePathPrefix;if(i&&e.substr(0,i.length)!==i&&(e=i+e),e=e.replace(/\.handlebars$/,""),r=Handlebars.templates[e],r||(e+=".handlebars",r=Handlebars.templates[e]),!r&&!n)throw new Error("templates: "+e+" does not exist.");return r},is$:function(e){return n.isObject(e)&&"length"in e},expandToken:function(e,t){function r(e,t){if(e.match(/^("|')/)&&e.match(/("|')$/))return e.replace(/(^("|')|('|")$)/g,"");for(var n=e.split("."),r=n.length,i=0;t&&r>i;i++)"this"!==n[i]&&(t=t[n[i]]);return t}if(e&&e.indexOf&&e.indexOf("{{")>=0){for(var i,s=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,o=[];i=s.exec(e);)if(i[1]){var u=i[1].split(/\s+/);if(u.length>1){var a=u.shift();u=n.map(u,function(e){return r(e,t)}),Handlebars.helpers[a]?o.push(Handlebars.helpers[a].apply(t,u)):o.push(i[0])}else o.push(r(u[0],t))}else o.push(i[0]);e=o.join("")}return e},tag:function(e,r,i){var s=n.omit(e,"tagName"),o=e.tagName||"div";return"<"+o+" "+n.map(s,function(e,r){if(n.isUndefined(e)||"expand-tokens"===r)return"";var s=e;return i&&(s=t.Util.expandToken(e,i)),("className"===r?"class":r)+'="'+Handlebars.Utils.escapeExpression(s)+'"'}).join(" ")+">"+(n.isUndefined(r)?"":r)+"</"+o+">"}},t.Mixins={},st.mixins={name:"mixins",configure:function(){n.each(this.constructor.mixins,this.mixin,this),n.each(this.mixins,this.mixin,this)}},n.extend(t.View,{mixin:function(e){l(this),this.mixins.push(e)},registerMixin:function(e,n,r){t.Mixins[e]=[n,r]}}),t.View.prototype.mixin=function(e){if(this._appliedMixins||(this._appliedMixins=[]),-1===n.indexOf(this._appliedMixins,e))if(this._appliedMixins.push(e),n.isFunction(e))e.call(this);else{var r=t.Mixins[e];n.extend(this,r[1]),n.isArray(r[0])?r[0][0].apply(this,r[0][1]):r[0].apply(this,n.toArray(arguments).slice(1))}};var ut=t.View.prototype.on;st.event={name:"_events",configure:function(){var e=this;h(this.constructor,"_events",!0,function(t){e.on.apply(e,t)}),h(this,"events",!1,function(t,n){e.on(n,t,e)})}},n.extend(t.View,{on:function(e,t){return l(this),p(this,e,t)?this:(n.isObject(e)?n.each(e,function(e,t){this.on(t,e)},this):n.isArray(t)?n.each(t,function(t){this._events.push([e,t])},this):this._events.push([e,t]),this)}}),n.extend(t.View.prototype,{on:function(e,t,r){return p(this,e,t,r)?this:(n.isObject(e)&&arguments.length<3?n.each(e,function(e,n){this.on(n,e,t||this)},this):n.each(n.isArray(t)?t:[t],function(t){var n=w.call(this,e,t,r||this);"DOM"===n.type?(this._eventsToDelegate||(this._eventsToDelegate=[]),this._eventsToDelegate.push(n)):this._addEvent(n)},this),this)},delegateEvents:function(e){this.undelegateEvents(),e&&(n.isFunction(e)&&(e=e.call(this)),this._eventsToDelegate=[],this.on(e)),this._eventsToDelegate&&n.each(this._eventsToDelegate,this._addEvent,this)},_addEvent:function(e){if("view"===e.type)n.each(e.name.split(/\s+/),function(t){ut.call(this,t,b.call(this,"view-event:",e),e.context||this)},this);else{var t=b.call(this,"dom-event:",e);e.nested||(t=y(t,this.cid));var r=e.name+".delegateEvents"+this.cid;e.selector?this.$el.on(r,e.selector,t):this.$el.on(r,t)}}}),t.View.on("ready",function(e){function t(t){t.trigger("ready",e)}this._isReady||(this._isReady=!0,n.each(this.children,t),this.on("child",t))});var at,ft=/^(nested\s+)?(\S+)(?:\s+(.+))?/,lt=[];g(["mousedown","mouseup","mousemove","mouseover","mouseout","touchstart","touchend","touchmove","click","dblclick","keyup","keydown","keypress","submit","change","focus","blur"]);var ct="data-view-tmp",ht={},pt={_ensureElement:function(){t.View.prototype._ensureElement.apply(this,arguments),this.$el.attr(rt,this._helperName)},_getContext:function(){return this.parent._getContext.apply(this.parent,arguments)}};t.HelperView=t.View.extend(pt),Handlebars.registerViewHelper=function(e,r,i){2===arguments.length&&(r.factory?i=r.callback:(i=r,r=t.HelperView)),Handlebars.registerHelper(e,function(){var s=n.toArray(arguments),o=s.pop(),u=v(o).view,a={template:o.fn||Handlebars.VM.noop,inverse:o.inverse,options:o.hash,declaringView:u,parent:E(u),_helperName:e,_helperOptions:{options:S(o),args:n.clone(s)}};m(o.hash),n.extend(a,n.pick(o.hash,ot));var f=n.find(u._previousHelpers,function(e){return x(a,e)});if(f)u._previousHelpers=n.without(u._previousHelpers,f),u.children[f.cid]=f;else{if(r.factory){if(f=r.factory(s,a),!f)return"";f._helperName=a._helperName,f._helperOptions=a._helperOptions}else f=new r(a);s.push(f),u._addChild(f),u.trigger.apply(u,["helper",e].concat(s)),u.trigger.apply(u,["helper:"+e].concat(s)),i&&i.apply(this,s)}var l=n.pick(o.hash,ot);l[ct]=f.cid;var c=o.hash["expand-tokens"];return new Handlebars.SafeString(t.Util.tag(l,"",c?this:null))});var s=Handlebars.helpers[e];return s},t.View.on("append",function(e,t){(e||this.$el).find("["+ct+"]").forEach(function(e){var n=e.getAttribute(ct),i=this.children[n];i&&(ht[n]?(i.render(ht[n]),delete ht[n]):i.ensureRendered(),r(e).replaceWith(i.el),t&&t(i.el))},this)}),n.extend(t.View.prototype,{bindDataObject:function(e,t,r){if(this._boundDataObjectsByCid[t.cid])return!1;this._boundDataObjectsByCid[t.cid]=t;var r=this._modifyDataObjectOptions(t,n.extend({},st[e].defaultOptions,r));this._objectOptionsByCid[t.cid]=r,N.call(this,e,t,this.constructor),N.call(this,e,t,this);var i=st[e];return i.bindCallback&&i.bindCallback.call(this,t,r),t.shouldFetch&&t.shouldFetch(r)?C(t,r):st[e].change&&st[e].change.call(this,t,r),!0},unbindDataObject:function(e){return this._boundDataObjectsByCid[e.cid]?(delete this._boundDataObjectsByCid[e.cid],this.stopListening(e),delete this._objectOptionsByCid[e.cid],!0):!1},_modifyDataObjectOptions:function(e,t){return t}});var dt="data-model-cid";t.Model=i.Model.extend({isEmpty:function(){return!this.isPopulated()},isPopulated:function(){var e=n.clone(this.attributes),t=f(this,"defaults")||{};for(var r in t){if(e[r]!=t[r])return!0;delete e[r]}var i=n.keys(e);return i.length>1||1===i.length&&i[0]!==this.idAttribute},shouldFetch:function(e){var t;try{t=f(this,"url")}catch(n){t=!1}return e.fetch&&!!t&&!this.isPopulated()}}),t.Models={},o(t.Model,t.Models),T("model",{set:"setModel",defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:L,$el:"$el",cidAttrName:dt}),t.View.on({model:{error:function(e,t){this._objectOptionsByCid[e.cid].errors&&this.trigger("error",t,e)},change:function(e){L.call(this,e)}}}),r.fn.model=function(e){var t=r(this),n=t.closest("["+dt+"]"),i=n&&n.attr(dt);if(i){var e=e||t.view();if(e&&e.model&&e.model.cid===i)return e.model||!1;var s=t.collection(e);if(s)return s.get(i)}return!1};var vt=i.Collection.prototype.fetch,mt=i.Collection.prototype.reset,gt=t.View.prototype._replaceHTML,yt="data-collection-cid",bt="data-collection-empty",wt="data-collection-element",Et=1;t.Collection=i.Collection.extend({model:t.Model||i.Model,initialize:function(){return this.cid=n.uniqueId("collection"),i.Collection.prototype.initialize.apply(this,arguments)},isEmpty:function(){return this.length>0?!1:0===this.length&&this.isPopulated()},isPopulated:function(){return this._fetched||this.length>0||!this.length&&!f(this,"url")},shouldFetch:function(e){return e.fetch&&!!f(this,"url")&&!this.isPopulated()},fetch:function(e){e=e||{};var t=e.success;return e.success=function(e,n){e._fetched=!0,t&&t(e,n)},vt.apply(this,arguments)},reset:function(e,t){return this._fetched=!!e,mt.call(this,e,t)}}),t.Collections={},o(t.Collection,t.Collections),T("collection",{set:"setCollection",bindCallback:O,defaultOptions:{render:void 0,fetch:!0,success:!1,errors:!0},change:A,$el:"getCollectionElement",cidAttrName:yt}),t.CollectionView=t.View.extend({_defaultTemplate:Handlebars.VM.noop,_collectionSelector:"["+wt+"]",_replaceHTML:function(e){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return gt.call(this,e);var t,n=this.getCollectionElement();t=gt.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)},render:function(){var e=this.shouldRender();t.View.prototype.render.apply(this,arguments),e||this.renderCollection()},appendItem:function(e,t,i){if(e){var s,o=this.getCollectionElement();if(i=n.defaults(i||{},{filter:!0}),t&&t.el&&(t=o.children().indexOf(t.el)+1),e.el||n.isString(e)?(s=e,e=!1):(t=t||this.collection.indexOf(e)||0,s=this.renderItem(e,t)),s){s.cid&&(s.ensureRendered(),this._addChild(s)),n.isString(s)&&!s.match(/^\s*</m)&&(s="<div>"+s+"</div>");var u=s.$el?s.$el:n.filter(r(r.trim(s)),function(e){return e.nodeType===Et});e&&r(u).attr(dt,e.cid);var a=t>0?this.collection.at(t-1):!1;if(a){var f=o.children("["+dt+'="'+a.cid+'"]').last();f.after(u)}else o.prepend(u);this.trigger("append",null,function(t){t.setAttribute(dt,e.cid)}),!i.silent&&this.trigger("rendered:item",this,this.collection,e,u,t),i.filter&&_.call(this,e)}return s}},updateItem:function(e){var t=this.getCollectionElement(),n=t.find("["+dt+'="'+e.cid+'"]');n.attr(nt)||(this.removeItem(n),this.appendItem(e))},removeItem:function(e){var t=e;if(e.cid){var n=this.getCollectionElement();t=n.find("["+dt+'="'+e.cid+'"]')}if(!t.length)return!1;t.remove();var r=t.attr(nt),i=this.children[r];return i&&(this._removeChild(i),i.destroy()),!0},renderCollection:function(){this.collection?(this.collection.isEmpty()?H.call(this):(P.call(this),this.collection.forEach(function(e,t){this.appendItem(e,t)},this)),this.trigger("rendered:collection",this,this.collection)):H.call(this)},emptyClass:"empty",renderEmpty:function(){if(this.emptyTemplate||this.emptyView||a.call(this,"emptyTemplate",{extension:"-empty",required:!1}),this.emptyView){var e={};this.emptyTemplate&&(e.template=this.emptyTemplate);var n=t.Util.getViewInstance(this.emptyView,e);return n.ensureRendered(),n}return this.emptyTemplate&&this.renderTemplate(this.emptyTemplate)},renderItem:function(e,n){if(this.itemTemplate||this.itemView||a.call(this,"itemTemplate",{extension:"-item",required:!this.itemView}),this.itemView){var r={model:e};return this.itemTemplate&&(r.template=this.itemTemplate),t.Util.getViewInstance(this.itemView,r)}return this.renderTemplate(this.itemTemplate,this.itemContext(e,n))},itemContext:function(e){return e.attributes},appendEmpty:function(){var e=this.getCollectionElement();e.empty();var t=this.renderEmpty();t&&this.appendItem(t,0,{silent:!0,filter:!1}),this.trigger("rendered:empty",this,this.collection)},getCollectionElement:function(){var e=this.$(this._collectionSelector);return 0===e.length?this.$el:e}}),t.CollectionView.on({collection:{reset:A,sort:A,filter:function(){M.call(this)},change:function(e){this.updateItem(e),_.call(this,e)},add:function(e){var t=this.getCollectionElement();if(1===this.collection.length&&t.length&&P.call(this),t.length){var n=this.collection.indexOf(e);this.appendItem(e,n)}},remove:function(e){var t=this.getCollectionElement();this.removeItem(e),0===this.collection.length&&t.length&&H.call(this)}}}),t.View.on({collection:{error:function(e,t){this._objectOptionsByCid[e.cid].errors&&this.trigger("error",t,e)}}}),r.fn.collection=function(e){if(e&&e.collection)return e.collection;var t=r(this),n=t.closest("["+yt+"]"),i=n&&n.attr(yt);return i&&(e=t.view())?e.collection:!1},st.model.defaultOptions.populate=!0;var St=st.model.change;st.model.change=function(){St.apply(this,arguments);var e=this.model&&this._objectOptionsByCid[this.model.cid];e&&e.populate&&this.populate(this.model.attributes,e.populate===!0?{}:e.populate)},st.model.defaultOptions.populate=!0,n.extend(t.View.prototype,{serialize:function(){for(var e,t,r,i=0;i<arguments.length;++i)n.isFunction(arguments[i])?e=arguments[i]:n.isObject(arguments[i])&&("stopPropagation"in arguments[i]&&"preventDefault"in arguments[i]?r=arguments[i]:t=arguments[i]);if(!r||this._preventDuplicateSubmission(r)){t=n.extend({set:!0,validate:!0,children:!0,silent:!0},t||{});var s=t.attributes||{},o=this,u=[];if(B.call(this,t,function(){var e=o._getInputValue(this,t,u);n.isUndefined(e)||j.call(this,s,this.name,{mode:"serialize"},function(t,r){t[r]?n.isArray(t[r])?t[r].push(e):t[r]=[t[r],e]:t[r]=e})}),this.trigger("serialize",s,t),t.validate){var a=this.validateInput(s);if(a&&a.length&&(u=u.concat(a)),this.trigger("validate",s,u,t),u.length)return this.trigger("error",u),void 0}return t.set&&this.model&&!this.model.set(s,{silent:t.silent})?!1:(e&&e.call(this,s,n.bind(F,this)),s)}},_preventDuplicateSubmission:function(e,t){e.preventDefault();var n=r(e.target);return"form"!==(e.target.tagName||"").toLowerCase()&&(n=r(e.target).closest("form")),n.attr("data-submit-wait")?!1:(n.attr("data-submit-wait","true"),t&&t.call(this,e),!0)},populate:function(e,t){t=n.extend({children:!0},t||{});var r,e=e||this._getContext();B.call(this,t,function(){j.call(this,e,this.name,{mode:"populate"},function(e,t){r=e&&e[t],n.isUndefined(r)||("checkbox"===this.type&&n.isBoolean(r)?this.checked=r:"checkbox"===this.type||"radio"===this.type?this.checked=r==this.value:this.value=r)})}),this.trigger("populate",e)},validateInput:function(){},_getInputValue:function(e){if("checkbox"!==e.type&&"radio"!==e.type){if(e.multiple===!0){var t=[];return r("option",e).each(function(){this.selected&&t.push(this.value)}),t}return e.value}return e.checked?e.value:void 0}}),t.View.on({error:function(){F.call(this),this.model&&this.model.previousAttributes&&this.model.set(this.model.previousAttributes(),{silent:!0})},deactivated:function(){F.call(this)}});var xt="data-layout-cid";t.LayoutView=t.View.extend({_defaultTemplate:Handlebars.VM.noop,render:function(){var e=t.View.prototype.render.apply(this,arguments);return this.template===Handlebars.VM.noop?q.call(this):R.call(this),e},setView:function(e,r){r=n.extend({scroll:!0,destroy:!0},r||{}),n.isString(e)&&(e=new(t.Util.registryGet(t,"Views",e,!1))),this.ensureRendered();var i=this._view;return e===i?!1:(r.destroy&&e&&(e._shouldDestroyOnNextSetView=!0),this.trigger("change:view:start",e,i,r),i&&(this._removeChild(i),i.$el.remove(),I.call(i,"deactivated",r),i._shouldDestroyOnNextSetView&&i.destroy()),e?(I.call(this,"activated",r),e.trigger("activated",r),this._addChild(e),this._view=e,this._view.appendTo(U.call(this))):this._view=void 0,this.trigger("change:view:end",e,i,r),e)},getView:function(){return this._view}}),Handlebars.registerHelper("layout-element",function(e){var n=v(e).view;if(!n.getView)throw new Error("layout-element must be used within a LayoutView");return e.hash[xt]=n.cid,m(e.hash),new Handlebars.SafeString(t.Util.tag.call(this,e.hash,"",this))}),t.Router=i.Router.extend({constructor:function(){var e=t.Router.__super__.constructor.apply(this,arguments);return z.call(this),e},route:function(e,t,n){return n||(n=this[t]),i.Router.prototype.route.call(this,e,t,function(){return this.trigger.apply(this,["route:before",e,t].concat(Array.prototype.slice.call(arguments))),n.apply(this,arguments)})}}),t.Routers={},o(t.Router,t.Routers),t.CollectionHelperView=t.CollectionView.extend({events:{"rendered:item":X("rendered:item"),"rendered:collection":X("rendered:collection"),"rendered:empty":X("rendered:empty")},constructor:function(e){n.each(Tt,function(n,r){if(e.options[r]){var i=e.options[r];("itemTemplate"===n||"emptyTemplate"===n)&&(i=t.Util.getTemplate(i)),e[n]=i}}),!e.itemTemplate&&e.template&&e.template!==Handlebars.VM.noop&&(e.itemTemplate=e.template,e.template=Handlebars.VM.noop),!e.emptyTemplate&&e.inverse&&e.inverse!==Handlebars.VM.noop&&(e.emptyTemplate=e.inverse,e.inverse=Handlebars.VM.noop);var r=t.HelperView.call(this,e);return this.parent.name&&(this.emptyTemplate||(this.emptyTemplate=t.Util.getTemplate(this.parent.name+"-empty",!0)),this.itemTemplate||(this.itemTemplate=t.Util.getTemplate(this.parent.name+"-item",!!this.itemView))),r},setAsPrimaryCollectionHelper:function(){n.each(Nt,function(e){V.call(this,e)},this);var e=this;n.each(["itemFilter","itemContext","renderItem","renderEmpty"],function(t){e.parent[t]&&!this[t]&&(e[t]=function(){return e.parent[t].apply(e.parent,arguments)})})}}),n.extend(t.CollectionHelperView.prototype,pt);var Tt={"item-template":"itemTemplate","empty-template":"emptyTemplate","item-view":"itemView","empty-view":"emptyView","empty-class":"emptyClass"},Nt=["itemTemplate","itemView","emptyTemplate","emptyView"];Handlebars.registerViewHelper("collection",t.CollectionHelperView,function(e,t){1===arguments.length&&(t=e,e=t.parent.collection,e&&t.setAsPrimaryCollectionHelper(),t.$el.attr(wt,"true"),t.listenTo(t.parent,"change:data-object",function(e,n){"collection"===e&&(t.setAsPrimaryCollectionHelper(),t.setCollection(n))})),e&&t.setCollection(e)}),Handlebars.registerHelper("collection-element",function(e){if(!v(e).view.renderCollection)throw new Error("collection-element helper must be declared inside of a CollectionView");var n=e.hash;return m(n),n.tagName=n.tagName||"div",n[wt]=!0,new Handlebars.SafeString(t.Util.tag.call(this,n,"",this))}),Handlebars.registerHelper("empty",function(e,t){1===arguments.length&&(t=e);var n=v(t).view;return 1===arguments.length&&(e=n.model),n._emptyListeners||(n._emptyListeners={}),e&&!n._emptyListeners[e.cid]&&e.models&&"length"in e&&(n._emptyListeners[e.cid]=!0,n.listenTo(e,"remove",function(){0===e.length&&n.render()}),n.listenTo(e,"add",function(){1===e.length&&n.render()}),n.listenTo(e,"reset",function(){n.render()})),!e||e.isEmpty()?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("template",function(e,t){var r=n.extend({fn:t&&t.fn},this,t?t.hash:{}),i=v(t).view.renderTemplate(e,r);return new Handlebars.SafeString(i)}),Handlebars.registerHelper("yield",function(e){return v(e).yield&&e.data.yield()}),Handlebars.registerHelper("url",function(e){var r;if(arguments.length>2)r=n.map(n.head(arguments,arguments.length-1),encodeURIComponent).join("/");else{var s=arguments[1],o=s&&s.hash||s;r=o&&o["expand-tokens"]?t.Util.expandToken(e,this):e}if(i.history._hasPushState){var u=i.history.options.root;return"/"===u&&"/"===r.substr(0,1)?r:u+r}return"#"+r}),Handlebars.registerViewHelper("view",{factory:function(e,n){var r=e.length>=1?e[0]:t.View;return t.Util.getViewInstance(r,n.options)},callback:function(){var e=arguments[arguments.length-1],t=e._helperOptions.options,n=e.cid;t.fn&&(ht[n]=t.fn)}});var Ct="data-call-method",kt="data-trigger-event";Handlebars.registerHelper("button",function(e,n){1===arguments.length&&(n=e,e=n.hash.method);var r=n.hash,i=r["expand-tokens"];if(delete r["expand-tokens"],!e&&!n.hash.trigger)throw new Error("button helper must have a method name as the first argument or a 'trigger', or a 'method' attribute specified.");return m(r),r.tagName=r.tagName||"button",r.trigger&&(r[kt]=r.trigger),delete r.trigger,e&&(r[Ct]=e),new Handlebars.SafeString(t.Util.tag(r,n.fn?n.fn(this):"",i?this:null))}),Handlebars.registerHelper("link",function(){var e=n.toArray(arguments),r=e.pop(),i=r.hash,s=0===e.length?[i.href]:e,o=i["expand-tokens"];if(delete i["expand-tokens"],!s[0]&&""!==s[0])throw new Error("link helper requires an href as the first argument or an 'href' attribute");return m(i),s.push(r),i.href=Handlebars.helpers.url.apply(this,s),i.tagName=i.tagName||"a",i.trigger&&(i[kt]=r.hash.trigger),delete i.trigger,i[Ct]="_anchorClick",new Handlebars.SafeString(t.Util.tag(i,r.fn?r.fn(this):"",o?this:null))});var Lt,At="["+Ct+"], ["+kt+"]";r(document).ready(function(){t._fastClickEventName||J()});var Ot="data-element-tmp";Handlebars.registerHelper("element",function(e,r){m(r.hash);var i=n.uniqueId("element"),s=v(r).view,o=n.pick(r.hash,ot);return o[Ot]=i,s._elementsByCid||(s._elementsByCid={}),s._elementsByCid[i]=e,new Handlebars.SafeString(t.Util.tag(o))}),t.View.on("append",function(e,t){(e||this.$el).find("["+Ot+"]").forEach(function(e){var i=r(e),s=i.attr(Ot),o=this._elementsByCid[s];n.isFunction(o)&&(o=o.call(this)),i.replaceWith(o),t&&t(o)},this)}),Handlebars.registerHelper("super",function(e){var r=v(e).view,i=r.constructor&&r.constructor.__super__;if(i){var s=i.template;if(!s){if(!i.name)throw new Error("Cannot use super helper when parent has no name or template.");s=i.name}return n.isString(s)&&(s=t.Util.getTemplate(s,!1)),new Handlebars.SafeString(s(this,e))}return""});var Mt,_t="load:start",Dt="load:end";t.setRootObject=function(e){Mt=e},t.loadHandler=function(e,r,s){var o=n.uniqueId("load");return function(u,a,f){function l(){if(!h.timeout||h.run){var n=void 0!==c._loadingTimeoutDuration?c._loadingTimeoutDuration:t.View.prototype._loadingTimeoutDuration;h.timeout=setTimeout(function(){try{h.run=!0,e.call(c,h.message,h.background,h)}catch(n){t.onException("loadStart",n)}},1e3*n)}}var c=s||this;c._loadInfo=c._loadInfo||{};var h=c._loadInfo[o];h?(clearTimeout(h.endTimeout),h.message=u,!a&&h.background&&(h.background=!1,l())):(h=c._loadInfo[o]=n.extend({isLoading:function(){return h.events.length},cid:o,events:[],timeout:0,message:u,background:!!a},i.Events),l()),n.indexOf(h.events,f)>=0||(h.events.push(f),f.on(Dt,function p(){var e=c._loadingTimeoutEndDuration;void 0===e&&(e=t.View.prototype._loadingTimeoutEndDuration);var i=h.events,s=n.indexOf(i,f);s>=0&&!f.isLoading()&&(i.splice(s,1),n.indexOf(i,f)<0&&f.off(Dt,p)),i.length||(clearTimeout(h.endTimeout),h.endTimeout=setTimeout(function(){try{i.length||(h.run&&(r.call(c,h.background,h),h.trigger(Dt,h)),clearTimeout(h.timeout),h=c._loadInfo[o]=void 0)}catch(e){t.onException("loadEnd",e)}},1e3*e))}))}},t.forwardLoadEvents=function(e,t,n){function r(i,s,o){n&&e.off(_t,r),t.trigger(_t,i,s,o)}return e.on(_t,r),{off:function(){e.off(_t,r)}}},t.mixinLoadable=function(e,t){n.extend(e,{_loadingClassName:"loading",_loadingTimeoutDuration:.33,_loadingTimeoutEndDuration:.1,onLoadStart:function(e,n,i){var s=t?this.parent:this;s&&s.el&&(s.nonBlockingLoad||n||!Mt||Mt===this||Mt.trigger(_t,e,n,i),s._isLoading=!0,r(s.el).addClass(s._loadingClassName),s.trigger("change:load-state","start",n))},onLoadEnd:function(){var e=t?this.parent:this;e&&e.el&&(e._isLoading=!1,r(e.el).removeClass(e._loadingClassName),e.trigger("change:load-state","end"))}})},t.mixinLoadableEvents=function(e,t){n.extend(e,{_loadCount:0,isLoading:function(){return this._loadCount>0},loadStart:function(e,n){this._loadCount++;var r=t?this.parent:this;r.trigger(_t,e,n,r)},loadEnd:function(){this._loadCount--;var e=t?this.parent:this;e.trigger(Dt,e)}})},t.mixinLoadable(t.View.prototype),t.mixinLoadableEvents(t.View.prototype),t.HelperView&&(t.mixinLoadable(t.HelperView.prototype,!0),t.mixinLoadableEvents(t.HelperView.prototype,!0)),t.CollectionHelperView&&(t.mixinLoadable(t.CollectionHelperView.prototype,!0),t.mixinLoadableEvents(t.CollectionHelperView.prototype,!0)),t.sync=function(e,t,n){var r=this,s=n.complete;return n.complete=function(){r._request=void 0,r._aborted=!1,s&&s.apply(this,arguments)},this._request=i.sync.apply(this,arguments),this._request};var Pt=[];t.Model&&Pt.push(t.Model),t.Collection&&Pt.push(t.Collection),n.each(Pt,function(e){var r=e.prototype.fetch;t.mixinLoadableEvents(e.prototype,!1),n.extend(e.prototype,{sync:t.sync,fetch:function(e){e=e||{};var t=this,n=e.complete;return e.complete=function(){n&&n.apply(this,arguments),t.loadEnd()},t.loadStart(void 0,e.background),Y.call(this,e||{},r)},load:function(e,r,i){2!==arguments.length||n.isFunction(r)||(i=r,r=!1),i=i||{},i.background||this.isPopulated()||!Mt||t.forwardLoadEvents(this,Mt,!0),G.call(this,e,r,i)}})}),t.Util.bindToRoute=Q,t.Router&&(t.Router.bindToRoute=t.Router.prototype.bindToRoute=Q),t.View.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.ignoreFetchError,t.background=this.nonBlockingLoad,t},t.HelperView.prototype._modifyDataObjectOptions=t.CollectionHelperView.prototype._modifyDataObjectOptions=function(e,t){return t.ignoreErrors=this.parent.ignoreFetchError,t.background=this.parent.nonBlockingLoad,t},st.collection.loading=function(){var e=this.loadingView,r=this.loadingTemplate,i=this.loadingPlacement;if(e||r){var s=t.loadHandler(n.bind(function(){var n;if(0===this.collection.length&&this.$el.empty(),e){var s=t.Util.getViewInstance(e);this._addChild(s),r?s.render(r):s.render(),n=s}else n=this.renderTemplate(r);var o=i?i.call(this):this.collection.length;this.appendItem(n,o),this.$el.children().eq(o).attr("data-loading-element",this.collection.cid)},this),n.bind(function(){this.$el.find('[data-loading-element="'+this.collection.cid+'"]').remove()},this),this.collection);this.listenTo(this.collection,"load:start",s)}},Tt&&(Tt["loading-template"]="loadingTemplate",Tt["loading-view"]="loadingView",Tt["loading-placement"]="loadingPlacement"),t.View.on({"load:start":t.loadHandler(function(e,t,n){this.onLoadStart(e,t,n)},function(e,t){this.onLoadEnd(t)}),collection:{"load:start":function(e,t,n){this.trigger(_t,e,t,n)}},model:{"load:start":function(e,t,n){this.trigger(_t,e,t,n)}}}),Handlebars.registerHelper("loading",function(e){var t=v(e).view;return t.off("change:load-state",et,t),t.on("change:load-state",et,t),t._isLoading?e.fn(this):e.inverse(this)});var Ht=/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());return Ht&&(t.View.on("before:append",function(){this._renderCount>0&&(n.each(this._elementsByCid,function(e){r(e).detach()}),n.each(this.children,function(e){e.$el.detach()}))}),t.CollectionView.prototype._replaceHTML=function(e){if(!(this.collection&&this._objectOptionsByCid[this.collection.cid]&&this._renderCount))return gt.call(this,e);var t,n=this.getCollectionElement().clone(!0,!0);t=gt.call(this,e),n.attr("data-view-cid")||this.getCollectionElement().replaceWith(n)}),t});